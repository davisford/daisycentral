<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.css">
    <style>
      code { background: none; color: none; border: none; };
      li code { white-space: pre-wrap; margin: 0; padding: 0; border: 0; border-radius: 0; line-height: 18px }
      .covered { background: #cfc; }
      .uncovered { background: #fcc; }
      a, a:visited { color:black; font-size:14pt; }
      pre li .hits {
        float: right;
        margin-left: 10px;
        padding: 2px 4px;
        background: linear-gradient(#222, #666);
        background: -webkit-gradient(linear, 0 0, 0 bottom, from(#222), to(#666));
        background: -moz-linear-gradient(#222, #666);
        background: linear-gradient(#222, #666);
        color: white;
        font-family: Helvetica, "Helvetica Neue", Arial, sans-serif;
        font-size: 10px;
        font-weight: bold;
        text-align: center;
        border-radius: 3px;
        line-height: 10px;
      }

      pre {
        border: none;
        background: none;
      }

      .S{color:red}
      .func{color:blue}
      .C{color:orange}
      .kwrd{font-weight:bold}
      .R{color:gray}

    </style>
    <script>
      function init() {
        var id = location.href.split('#')[1];
        if (id)
          document.getElementById(id).style.display = '';
      }
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row"><div class="span3"><a href="#lib-abstract-class-js" class="filename" name="lib-abstract-class-js" onclick="var el = document.getElementById('lib-abstract-class-js'); el.style.display = el.style.display ? '' : 'none';">lib/abstract-class.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 83%"><strong>83%</strong> [308/938]</div></div></div></div><div id="lib-abstract-class-js" style="display:none;"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> util = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> jutil = <span class="func">require</span>(<span class="S">'./jutil'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Validatable = <span class="func">require</span>(<span class="S">'./validatable'</span>).Validatable;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Hookable = <span class="func">require</span>(<span class="S">'./hookable'</span>).Hookable;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> DEFAULT_CACHE_LIMIT = 1000;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.AbstractClass = AbstractClass;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>jutil.<span class="func">inherits</span>(AbstractClass, Validatable);</code><span class="hits">1</span></li><li class="covered"><code>jutil.<span class="func">inherits</span>(AbstractClass, Hookable);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Abstract class - base class for all persist objects</span></code></li><li class=""><code><span class="C"> * provides **common API** to access any database adapter.</span></code></li><li class=""><code><span class="C"> * This class describes only abstract behavior layer, refer to `lib/adapters/*.js`</span></code></li><li class=""><code><span class="C"> * to learn more about specific adapter implementations</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * `AbstractClass` mixes `Validatable` and `Hookable` classes methods</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @constructor</span></code></li><li class=""><code><span class="C"> * @param {Object} data - initial object data</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">AbstractClass</span>(data) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">_initProperties</span>(data, true);</code><span class="hits">971</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>AbstractClass.prototype._initProperties = <span class="kwrd">function</span> (data, applySetters) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">1659</span></li><li class="covered"><code>    <span class="kwrd">var</span> ctor = this.constructor;</code><span class="hits">1659</span></li><li class="covered"><code>    <span class="kwrd">var</span> ds = ctor.schema.definitions<span class="gly">[</span>ctor.modelName<span class="gly">]</span>;</code><span class="hits">1659</span></li><li class="covered"><code>    <span class="kwrd">var</span> properties = ds.properties;</code><span class="hits">1659</span></li><li class="covered"><code>    data = data <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1659</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (data.id) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">defineReadonlyProp</span>(this, <span class="S">'id'</span>, data.id);</code><span class="hits">659</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'cachedRelations'</span>, <span class="gly">{</span></code></li><li class=""><code>        writable: true,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: <span class="gly">{</span><span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1659</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">keys</span>(properties).<span class="func">forEach</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> _attr    = <span class="S">'_'</span> + attr,</code></li><li class="covered"><code>            attr_was = attr + <span class="S">'_was'</span>;</code><span class="hits">9250</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// Hidden property to store currrent value</span></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(this, _attr, <span class="gly">{</span></code></li><li class=""><code>            writable: true,</code></li><li class=""><code>            enumerable: false,</code></li><li class=""><code>            configurable: true,</code></li><li class=""><code>            value: <span class="func">isdef</span>(data<span class="gly">[</span>attr<span class="gly">]</span>) ? data<span class="gly">[</span>attr<span class="gly">]</span> :</code></li><li class=""><code>            (<span class="func">isdef</span>(this<span class="gly">[</span>attr<span class="gly">]</span>) ? this<span class="gly">[</span>attr<span class="gly">]</span> : (</code></li><li class=""><code>                <span class="func">getDefault</span>(attr)</code></li><li class=""><code>            ))</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">9250</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// Public setters and getters</span></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(this, attr, <span class="gly">{</span></code></li><li class=""><code>            get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (ctor.getter<span class="gly">[</span>attr<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> ctor.getter<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">call</span>(this);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">return</span> this<span class="gly">[</span>_attr<span class="gly">]</span>;</code><span class="hits">4586</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            set: <span class="kwrd">function</span> (value) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (ctor.setter<span class="gly">[</span>attr<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    ctor.setter<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">call</span>(this, value);</code><span class="hits">8</span></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    this<span class="gly">[</span>_attr<span class="gly">]</span> = value;</code><span class="hits">105</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            configurable: true,</code></li><li class=""><code>            enumerable: true</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">9250</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (data.<span class="func">hasOwnProperty</span>(attr)) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (applySetters && ctor.setter<span class="gly">[</span>attr<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>                ctor.setter<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">call</span>(this, data<span class="gly">[</span>attr<span class="gly">]</span>);</code><span class="hits">24</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// Getter for initial property</span></code></li><li class=""><code>            Object.<span class="func">defineProperty</span>(this, attr_was, <span class="gly">{</span></code></li><li class=""><code>                writable: true,</code></li><li class=""><code>                value: this<span class="gly">[</span>_attr<span class="gly">]</span>,</code></li><li class=""><code>                configurable: true,</code></li><li class=""><code>                enumerable: false</code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">3394</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">1659</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">getDefault</span>(attr) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> def = properties<span class="gly">[</span>attr<span class="gly">]</span><span class="gly">[</span><span class="S">'default'</span><span class="gly">]</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">isdef</span>(def)) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> def === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">return</span> <span class="func">def</span>();</code><span class="hits">574</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">return</span> def;</code><span class="hits">659</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> null;</code><span class="hits">3721</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    this.<span class="func">trigger</span>(<span class="S">"initialize"</span>);</code><span class="hits">1659</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>AbstractClass.setter = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>AbstractClass.getter = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * @param {String} prop - property name</span></code></li><li class=""><code><span class="C"> * @param {Object} params - various property configuration</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.defineProperty = <span class="kwrd">function</span> (prop, params) <span class="gly">{</span></code></li><li class="covered"><code>    this.schema.<span class="func">defineProperty</span>(this.modelName, prop, params);</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.whatTypeName = <span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ds = this.schema.definitions<span class="gly">[</span>this.modelName<span class="gly">]</span>;</code><span class="hits">32</span></li><li class="covered"><code>    <span class="kwrd">return</span> ds.properties<span class="gly">[</span>propName<span class="gly">]</span>.type.name;</code><span class="hits">32</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.prototype.whatTypeName = <span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.constructor.<span class="func">whatTypeName</span>(propName);</code><span class="hits">16</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Create new instance of Model class, saved in database</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param data [optional]</span></code></li><li class=""><code><span class="C"> * @param callback(err, obj)</span></code></li><li class=""><code><span class="C"> * callback called with arguments:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *   - err (null or Error)</span></code></li><li class=""><code><span class="C"> *   - instance (null or Model)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.create = <span class="kwrd">function</span> (data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">292</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> modelName = this.modelName;</code><span class="hits">292</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> data === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        callback = data;</code><span class="hits">41</span></li><li class="covered"><code>        data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">41</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback !== <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        callback = <span class="kwrd">function</span> () <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> obj = null;</code><span class="hits">292</span></li><li class=""><code>    <span class="C">// if we come from save</span></code></li><li class=""><code>    <span class="kwrd">if</span> (data instanceof AbstractClass && !data.id) <span class="gly">{</span></code></li><li class="covered"><code>        obj = data;</code><span class="hits">44</span></li><li class="covered"><code>        data = obj.<span class="func">toObject</span>(true);</code><span class="hits">44</span></li><li class="covered"><code>        this.prototype._initProperties.<span class="func">call</span>(obj, data, false);</code><span class="hits">44</span></li><li class="covered"><code>        <span class="func">create</span>();</code><span class="hits">44</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        obj = <span class="kwrd">new</span> <span class="func">this</span>(data);</code><span class="hits">248</span></li><li class="covered"><code>        data = obj.<span class="func">toObject</span>(true);</code><span class="hits">248</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// validation required</span></code></li><li class=""><code>        obj.<span class="func">isValid</span>(<span class="kwrd">function</span> (valid) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!valid) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">callback</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Validation error'</span>), obj);</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">create</span>();</code><span class="hits">247</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">248</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">create</span>() <span class="gly">{</span></code></li><li class=""><code>        obj.<span class="func">trigger</span>(<span class="S">'create'</span>, <span class="kwrd">function</span> (done) <span class="gly">{</span></code></li><li class=""><code>            this.<span class="func">_adapter</span>().<span class="func">create</span>(modelName, data, <span class="kwrd">function</span> (err, id) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (id) <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="func">defineReadonlyProp</span>(obj, <span class="S">'id'</span>, id);</code><span class="hits">290</span></li><li class="covered"><code>                    <span class="func">addToCache</span>(this.constructor, obj);</code><span class="hits">290</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>                done.<span class="func">call</span>(this, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>                        <span class="func">callback</span>(err, obj);</code><span class="hits">290</span></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">290</span></li><li class="covered"><code>            <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">290</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">291</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">stillConnecting</span>(schema, obj, args) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (schema.connected) <span class="kwrd">return</span> false;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> method = args.callee;</code></li><li class=""><code>    schema.<span class="func">on</span>(<span class="S">'connected'</span>, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        method.<span class="func">apply</span>(obj, <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(args));</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> true;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update or insert</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.upsert = AbstractClass.updateOrCreate = <span class="kwrd">function</span> <span class="func">upsert</span>(data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">20</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> Model = this;</code><span class="hits">20</span></li><li class="covered"><code>    <span class="kwrd">if</span> (!data.id) <span class="kwrd">return</span> this.<span class="func">create</span>(data, callback);</code><span class="hits">12</span></li><li class=""><code>    <span class="kwrd">if</span> (this.schema.adapter.updateOrCreate) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> inst = <span class="kwrd">new</span> <span class="func">Model</span>(data);</code><span class="hits">12</span></li><li class=""><code>        this.schema.adapter.<span class="func">updateOrCreate</span>(Model.modelName, inst.<span class="func">toObject</span>(), <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> obj;</code><span class="hits">12</span></li><li class=""><code>            <span class="kwrd">if</span> (data) <span class="gly">{</span></code></li><li class="covered"><code>                inst.<span class="func">_initProperties</span>(data);</code><span class="hits">12</span></li><li class="covered"><code>                obj = inst;</code><span class="hits">12</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = null;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (obj) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">addToCache</span>(Model, obj);</code><span class="hits">12</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            <span class="func">callback</span>(err, obj);</code><span class="hits">12</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">12</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">find</span>(data.id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>            <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>                inst.<span class="func">updateAttributes</span>(data, callback);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> obj = <span class="kwrd">new</span> <span class="func">Model</span>(data);</code></li><li class="uncovered"><code>                obj.<span class="func">save</span>(data, callback);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether object exitst in database</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {id} id - identifier of object (primary key value)</span></code></li><li class=""><code><span class="C"> * @param {Function} cb - callbacl called with (err, exists: Bool)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.exists = <span class="kwrd">function</span> <span class="func">exists</span>(id, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">24</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (id) <span class="gly">{</span></code></li><li class="covered"><code>        this.schema.adapter.<span class="func">exists</span>(this.modelName, id, cb);</code><span class="hits">24</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">cb</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Model::exists requires positive id argument'</span>));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find object by id</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {id} id - primary key value</span></code></li><li class=""><code><span class="C"> * @param {Function} cb - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.find = <span class="kwrd">function</span> <span class="func">find</span>(id, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">68</span></li><li class=""><code></code></li><li class=""><code>    this.schema.adapter.<span class="func">find</span>(this.modelName, id, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> obj = null;</code><span class="hits">68</span></li><li class=""><code>        <span class="kwrd">if</span> (data) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> cached = <span class="func">getCached</span>(this, data.id);</code><span class="hits">60</span></li><li class=""><code>            <span class="kwrd">if</span> (cached) <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = cached;</code></li><li class="uncovered"><code>                <span class="func">substractDirtyAttributes</span>(obj, data);</code></li><li class=""><code>                <span class="C">// maybe just obj._initProperties(data); instead of</span></code></li><li class="uncovered"><code>                this.prototype._initProperties.<span class="func">call</span>(obj, data);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                data.id = id;</code><span class="hits">60</span></li><li class="covered"><code>                obj = <span class="kwrd">new</span> <span class="func">this</span>();</code><span class="hits">60</span></li><li class="covered"><code>                obj.<span class="func">_initProperties</span>(data, false);</code><span class="hits">60</span></li><li class="covered"><code>                <span class="func">addToCache</span>(this, id);</code><span class="hits">60</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">cb</span>(err, obj);</code><span class="hits">68</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">68</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find all instances of Model, matched by query</span></code></li><li class=""><code><span class="C"> * make sure you have marked as `index: true` fields for filter or sort</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} params (optional)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - where: Object `{ key: val, key2: {gt: 'val2'}}`</span></code></li><li class=""><code><span class="C"> * - order: String</span></code></li><li class=""><code><span class="C"> * - limit: Number</span></code></li><li class=""><code><span class="C"> * - skip: Number</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Function} callback (required) called with arguments:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - err (null or Error)</span></code></li><li class=""><code><span class="C"> * - Array of instances</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.all = <span class="kwrd">function</span> <span class="func">all</span>(params, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">162</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="covered"><code>        cb = params;</code><span class="hits">16</span></li><li class="covered"><code>        params = null;</code><span class="hits">16</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> constr = this;</code><span class="hits">162</span></li><li class=""><code>    this.schema.adapter.<span class="func">all</span>(this.modelName, params, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> collection = null;</code><span class="hits">162</span></li><li class=""><code>        <span class="kwrd">if</span> (data && data.map) <span class="gly">{</span></code></li><li class=""><code>            collection = data.<span class="func">map</span>(<span class="kwrd">function</span> (d) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> obj = null;</code><span class="hits">530</span></li><li class=""><code>                <span class="C">// do not create different instances for the same object</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> cached = <span class="func">getCached</span>(constr, d.id);</code><span class="hits">530</span></li><li class=""><code>                <span class="kwrd">if</span> (cached) <span class="gly">{</span></code></li><li class="uncovered"><code>                    obj = cached;</code></li><li class=""><code>                    <span class="C">// keep dirty attributes untouthed (remove from dataset)</span></code></li><li class="uncovered"><code>                    <span class="func">substractDirtyAttributes</span>(obj, d);</code></li><li class=""><code>                    <span class="C">// maybe just obj._initProperties(d);</span></code></li><li class="uncovered"><code>                    constr.prototype._initProperties.<span class="func">call</span>(obj, d);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    obj = <span class="kwrd">new</span> constr;</code><span class="hits">530</span></li><li class="covered"><code>                    obj.<span class="func">_initProperties</span>(d, false);</code><span class="hits">530</span></li><li class="covered"><code>                    <span class="kwrd">if</span> (obj.id) <span class="func">addToCache</span>(constr, obj);</code><span class="hits">530</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                <span class="kwrd">return</span> obj;</code><span class="hits">530</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">162</span></li><li class="covered"><code>            <span class="func">cb</span>(err, collection);</code><span class="hits">162</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">162</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Find one record, same as `all`, limited by 1 and return object, not collection</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * @param {Object} params - search conditions</span></code></li><li class=""><code><span class="C"> * @param {Function} cb - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.findOne = <span class="kwrd">function</span> <span class="func">findOne</span>(params, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">24</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        cb = params;</code><span class="hits">8</span></li><li class="covered"><code>        params = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    params.limit = 1;</code><span class="hits">24</span></li><li class=""><code>    this.<span class="func">all</span>(params, <span class="kwrd">function</span> (err, collection) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err <span class="gly">|</span><span class="gly">|</span> !collection <span class="gly">|</span><span class="gly">|</span> !collection.length > 0) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code><span class="hits">16</span></li><li class="covered"><code>        <span class="func">cb</span>(err, collection<span class="gly">[</span>0<span class="gly">]</span>);</code><span class="hits">16</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">24</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">substractDirtyAttributes</span>(object, data) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(object.<span class="func">toObject</span>()).<span class="func">forEach</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (data.<span class="func">hasOwnProperty</span>(attr) && object.<span class="func">propertyChanged</span>(attr)) <span class="gly">{</span></code></li><li class="uncovered"><code>            delete data<span class="gly">[</span>attr<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Destroy all records</span></code></li><li class=""><code><span class="C"> * @param {Function} cb - callback called with (err)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>    this.schema.adapter.<span class="func">destroyAll</span>(this.modelName, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">clearCache</span>(this);</code><span class="hits">21</span></li><li class="covered"><code>        <span class="func">cb</span>(err);</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">21</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return count of matched records</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} where - search conditions (optional)</span></code></li><li class=""><code><span class="C"> * @param {Function} cb - callback, called with (err, count)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.count = <span class="kwrd">function</span> (where, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">24</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> where === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        cb = where;</code><span class="hits">16</span></li><li class="covered"><code>        where = null;</code><span class="hits">16</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    this.schema.adapter.<span class="func">count</span>(this.modelName, cb, where);</code><span class="hits">24</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return string representation of class</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @override default toString method</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.toString = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'[Model '</span> + this.modelName + <span class="S">']'</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Save instance. When instance haven't id, create method called instead.</span></code></li><li class=""><code><span class="C"> * Triggers: validate, save, update | create</span></code></li><li class=""><code><span class="C"> * @param options {validate: true, throws: false} [optional]</span></code></li><li class=""><code><span class="C"> * @param callback(err, obj)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.save = <span class="kwrd">function</span> (options, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">69</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> options == <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        callback = options;</code><span class="hits">67</span></li><li class="covered"><code>        options = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">67</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    callback = callback <span class="gly">|</span><span class="gly">|</span> <span class="kwrd">function</span> () <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">69</span></li><li class="covered"><code>    options = options <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">69</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!(<span class="S">'validate'</span> <span class="kwrd">in</span> options)) <span class="gly">{</span></code></li><li class="covered"><code>        options.validate = true;</code><span class="hits">68</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!(<span class="S">'throws'</span> <span class="kwrd">in</span> options)) <span class="gly">{</span></code></li><li class="covered"><code>        options.throws = false;</code><span class="hits">68</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (options.validate) <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">isValid</span>(<span class="kwrd">function</span> (valid) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (valid) <span class="gly">{</span></code></li><li class="covered"><code>                save.<span class="func">call</span>(this);</code><span class="hits">67</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> err = <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Validation error'</span>);</code><span class="hits">1</span></li><li class=""><code>                <span class="C">// throws option is dangerous for async usage</span></code></li><li class=""><code>                <span class="kwrd">if</span> (options.throws) <span class="gly">{</span></code></li><li class="covered"><code>                    throw err;</code><span class="hits">1</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="func">callback</span>(err, this);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">67</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        save.<span class="func">call</span>(this);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">save</span>() <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">trigger</span>(<span class="S">'save'</span>, <span class="kwrd">function</span> (saveDone) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> modelName = this.constructor.modelName;</code><span class="hits">68</span></li><li class="covered"><code>            <span class="kwrd">var</span> data = this.<span class="func">toObject</span>(true);</code><span class="hits">68</span></li><li class="covered"><code>            <span class="kwrd">var</span> inst = this;</code><span class="hits">68</span></li><li class=""><code>            <span class="kwrd">if</span> (inst.id) <span class="gly">{</span></code></li><li class=""><code>                inst.<span class="func">trigger</span>(<span class="S">'update'</span>, <span class="kwrd">function</span> (updateDone) <span class="gly">{</span></code></li><li class=""><code>                    inst.<span class="func">_adapter</span>().<span class="func">save</span>(modelName, data, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                            console.<span class="func">log</span>(err);</code></li><li class=""><code>                        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                            inst.<span class="func">_initProperties</span>(data, false);</code><span class="hits">24</span></li><li class=""><code>                        <span class="gly">}</span></code></li><li class=""><code>                        updateDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                            saveDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                                <span class="func">callback</span>(err, inst);</code><span class="hits">24</span></li><li class="covered"><code>                            <span class="gly">}</span>);</code><span class="hits">24</span></li><li class="covered"><code>                        <span class="gly">}</span>);</code><span class="hits">24</span></li><li class="covered"><code>                    <span class="gly">}</span>);</code><span class="hits">24</span></li><li class="covered"><code>                <span class="gly">}</span>, data);</code><span class="hits">24</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                inst.constructor.<span class="func">create</span>(inst, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                    saveDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                        <span class="func">callback</span>(err, inst);</code><span class="hits">44</span></li><li class="covered"><code>                    <span class="gly">}</span>);</code><span class="hits">44</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">44</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">68</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.prototype.isNewRecord = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> !this.id;</code><span class="hits">28</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return adapter of current record</span></code></li><li class=""><code><span class="C"> * @private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype._adapter = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.constructor.schema.adapter;</code><span class="hits">341</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Convert instance to Object</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Boolean} onlySchema - restrict properties to schema only, default false</span></code></li><li class=""><code><span class="C"> * when onlySchema == true, only properties defined in schema returned, </span></code></li><li class=""><code><span class="C"> * otherwise all enumerable properties returned</span></code></li><li class=""><code><span class="C"> * @returns {Object} - canonical object representation (no getters and setters)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.toObject = <span class="kwrd">function</span> (onlySchema) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">406</span></li><li class="covered"><code>    <span class="kwrd">var</span> ds = this.constructor.schema.definitions<span class="gly">[</span>this.constructor.modelName<span class="gly">]</span>;</code><span class="hits">406</span></li><li class="covered"><code>    <span class="kwrd">var</span> properties = ds.properties;</code><span class="hits">406</span></li><li class=""><code>    <span class="C">// weird</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(onlySchema ? properties : this).<span class="func">concat</span>(<span class="gly">[</span><span class="S">'id'</span><span class="gly">]</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (property) <span class="gly">{</span></code></li><li class="covered"><code>        data<span class="gly">[</span>property<span class="gly">]</span> = this<span class="gly">[</span>property<span class="gly">]</span>;</code><span class="hits">2767</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">406</span></li><li class="covered"><code>    <span class="kwrd">return</span> data;</code><span class="hits">406</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Delete object from persistence</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @triggers `destroy` hook (async) before and after destroying object</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.destroy = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">10</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">trigger</span>(<span class="S">'destroy'</span>, <span class="kwrd">function</span> (destroyed) <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">_adapter</span>().<span class="func">destroy</span>(this.constructor.modelName, this.id, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">removeFromCache</span>(this.constructor, this.id);</code><span class="hits">9</span></li><li class=""><code>            <span class="func">destroyed</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                cb && <span class="func">cb</span>(err);</code><span class="hits">8</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">9</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">9</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">10</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update single attribute</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * equals to `updateAttributes({name: value}, cb)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} name - name of property</span></code></li><li class=""><code><span class="C"> * @param {Mixed} value - value of property</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.updateAttribute = <span class="kwrd">function</span> <span class="func">updateAttribute</span>(name, value, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class="covered"><code>    data<span class="gly">[</span>name<span class="gly">]</span> = value;</code><span class="hits">8</span></li><li class="covered"><code>    this.<span class="func">updateAttributes</span>(data, callback);</code><span class="hits">8</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update set of attributes</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * this method performs validation before updating</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @trigger `validation`, `save` and `update` hooks</span></code></li><li class=""><code><span class="C"> * @param {Object} data - data to update</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - callback called with (err, instance)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttributes</span>(data, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">20</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> inst = this;</code><span class="hits">20</span></li><li class="covered"><code>    <span class="kwrd">var</span> model = this.constructor.modelName;</code><span class="hits">20</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// update instance's properties</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        inst<span class="gly">[</span>key<span class="gly">]</span> = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">29</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">20</span></li><li class=""><code></code></li><li class=""><code>    inst.<span class="func">isValid</span>(<span class="kwrd">function</span> (valid) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!valid) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">cb</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Validation error'</span>));</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">update</span>();</code><span class="hits">19</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">20</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">update</span>() <span class="gly">{</span></code></li><li class=""><code>        inst.<span class="func">trigger</span>(<span class="S">'save'</span>, <span class="kwrd">function</span> (saveDone) <span class="gly">{</span></code></li><li class=""><code>            inst.<span class="func">trigger</span>(<span class="S">'update'</span>, <span class="kwrd">function</span> (done) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>                Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>                    data<span class="gly">[</span>key<span class="gly">]</span> = inst<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">27</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">18</span></li><li class=""><code></code></li><li class=""><code>                inst.<span class="func">_adapter</span>().<span class="func">updateAttributes</span>(model, inst.id, data, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (!err) <span class="gly">{</span></code></li><li class="covered"><code>                        inst.<span class="func">_initProperties</span>(data, false);</code><span class="hits">18</span></li><li class=""><code>                        <span class="C">/*</span></code></li><li class=""><code><span class="C">                        Object.keys(data).forEach(function (key) {</span></code></li><li class=""><code><span class="C">                            inst[key] = data[key];</span></code></li><li class=""><code><span class="C">                            Object.defineProperty(inst, key + '_was', {</span></code></li><li class=""><code><span class="C">                                writable:     false,</span></code></li><li class=""><code><span class="C">                                configurable: true,</span></code></li><li class=""><code><span class="C">                                enumerable:   false,</span></code></li><li class=""><code><span class="C">                                value:        data[key]</span></code></li><li class=""><code><span class="C">                            });</span></code></li><li class=""><code><span class="C">                        });</span></code></li><li class=""><code><span class="C">                        */</span></code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                    done.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                        saveDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                            <span class="func">cb</span>(err, inst);</code><span class="hits">17</span></li><li class="covered"><code>                        <span class="gly">}</span>);</code><span class="hits">17</span></li><li class="covered"><code>                    <span class="gly">}</span>);</code><span class="hits">18</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">18</span></li><li class="covered"><code>            <span class="gly">}</span>, data);</code><span class="hits">19</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">19</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>AbstractClass.prototype.fromObject = <span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(obj).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="uncovered"><code>        this<span class="gly">[</span>key<span class="gly">]</span> = obj<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Checks is property changed based on current property and initial value</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} attr - property name</span></code></li><li class=""><code><span class="C"> * @return Boolean</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.propertyChanged = <span class="kwrd">function</span> <span class="func">propertyChanged</span>(attr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this<span class="gly">[</span><span class="S">'_'</span> + attr<span class="gly">]</span> !== this<span class="gly">[</span>attr + <span class="S">'_was'</span><span class="gly">]</span>;</code><span class="hits">89</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Reload object from persistence</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @requires `id` member of `object` to be able to call `find`</span></code></li><li class=""><code><span class="C"> * @param {Function} callback - called with (err, instance) arguments</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.reload = <span class="kwrd">function</span> <span class="func">reload</span>(callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">stillConnecting</span>(this.constructor.schema, this, arguments)) <span class="kwrd">return</span>;</code><span class="hits">16</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> obj = <span class="func">getCached</span>(this.constructor, this.id);</code><span class="hits">16</span></li><li class="covered"><code>    <span class="kwrd">if</span> (obj) obj.<span class="func">reset</span>();</code><span class="hits">16</span></li><li class="covered"><code>    this.constructor.<span class="func">find</span>(this.id, callback);</code><span class="hits">16</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Reset dirty attributes</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * this method does not perform any database operation it just reset object to it's</span></code></li><li class=""><code><span class="C"> * initial state</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.prototype.reset = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> obj = this;</code></li><li class=""><code>    Object.<span class="func">keys</span>(obj).<span class="func">forEach</span>(<span class="kwrd">function</span> (k) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (k !== <span class="S">'id'</span> && !obj.constructor.schema.definitions<span class="gly">[</span>obj.constructor.modelName<span class="gly">]</span>.properties<span class="gly">[</span>k<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            delete obj<span class="gly">[</span>k<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (obj.<span class="func">propertyChanged</span>(k)) <span class="gly">{</span></code></li><li class="uncovered"><code>            obj<span class="gly">[</span>k<span class="gly">]</span> = obj<span class="gly">[</span>k + <span class="S">'_was'</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Declare hasMany relation</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Class} anotherClass - class to has many</span></code></li><li class=""><code><span class="C"> * @param {Object} params - configuration {as:, foreignKey:}</span></code></li><li class=""><code><span class="C"> * @example `User.hasMany(Post, {as: 'posts', foreignKey: 'authorId'});`</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.hasMany = <span class="kwrd">function</span> <span class="func">hasMany</span>(anotherClass, params) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> methodName = params.as; <span class="C">// or pluralize(anotherClass.modelName)</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> fk = params.foreignKey;</code><span class="hits">8</span></li><li class=""><code>    <span class="C">// each instance of this class should have method named</span></code></li><li class=""><code>    <span class="C">// pluralize(anotherClass.modelName)</span></code></li><li class=""><code>    <span class="C">// which is actually just anotherClass.all({where: {thisModelNameId: this.id}}, cb);</span></code></li><li class=""><code>    <span class="func">defineScope</span>(this.prototype, anotherClass, methodName, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> x = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">64</span></li><li class="covered"><code>        x<span class="gly">[</span>fk<span class="gly">]</span> = this.id;</code><span class="hits">64</span></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="gly">{</span>where: x<span class="gly">}</span>;</code><span class="hits">64</span></li><li class=""><code>    <span class="gly">}</span>, <span class="gly">{</span></code></li><li class=""><code>        find: find,</code></li><li class=""><code>        destroy: destroy</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">8</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// obviously, anotherClass should have attribute called `fk`</span></code></li><li class="covered"><code>    anotherClass.schema.<span class="func">defineForeignKey</span>(anotherClass.modelName, fk);</code><span class="hits">8</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">find</span>(id, cb) <span class="gly">{</span></code></li><li class=""><code>        anotherClass.<span class="func">find</span>(id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (!inst) <span class="kwrd">return</span> <span class="func">cb</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Not found'</span>));</code></li><li class=""><code>            <span class="kwrd">if</span> (inst<span class="gly">[</span>fk<span class="gly">]</span> == this.id) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(null, inst);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Permission denied'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">destroy</span>(id, cb) <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">find</span>(id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class=""><code>            <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>                inst.<span class="func">destroy</span>(cb);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Not found'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Declare belongsTo relation</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Class} anotherClass - class to belong</span></code></li><li class=""><code><span class="C"> * @param {Object} params - configuration {as: 'propertyName', foreignKey: 'keyName'}</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.belongsTo = <span class="kwrd">function</span> (anotherClass, params) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> methodName = params.as;</code><span class="hits">16</span></li><li class="covered"><code>    <span class="kwrd">var</span> fk = params.foreignKey;</code><span class="hits">16</span></li><li class=""><code></code></li><li class="covered"><code>    this.schema.<span class="func">defineForeignKey</span>(this.modelName, fk);</code><span class="hits">16</span></li><li class=""><code>    this.prototype<span class="gly">[</span><span class="S">'__finders__'</span><span class="gly">]</span> = this.prototype<span class="gly">[</span><span class="S">'__finders__'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    this.prototype<span class="gly">[</span><span class="S">'__finders__'</span><span class="gly">]</span><span class="gly">[</span>methodName<span class="gly">]</span> = <span class="kwrd">function</span> (id, cb) <span class="gly">{</span></code></li><li class=""><code>        anotherClass.<span class="func">find</span>(id, <span class="kwrd">function</span> (err,inst) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class=""><code>            <span class="kwrd">if</span> (inst<span class="gly">[</span>fk<span class="gly">]</span> === this.id) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(null, inst);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(<span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Permission denied'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    this.prototype<span class="gly">[</span>methodName<span class="gly">]</span> = <span class="kwrd">function</span> (p) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (p instanceof AbstractClass) <span class="gly">{</span> <span class="C">// acts as setter</span></code></li><li class="uncovered"><code>            this<span class="gly">[</span>fk<span class="gly">]</span> = p.id;</code></li><li class="uncovered"><code>            this.cachedRelations<span class="gly">[</span>methodName<span class="gly">]</span> = p;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> p === <span class="S">'function'</span>) <span class="gly">{</span> <span class="C">// acts as async getter</span></code></li><li class="uncovered"><code>            this.__finders__<span class="gly">[</span>methodName<span class="gly">]</span>(this<span class="gly">[</span>fk<span class="gly">]</span>, p);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> this<span class="gly">[</span>fk<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> p === <span class="S">'undefined'</span>) <span class="gly">{</span> <span class="C">// acts as sync getter</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> this<span class="gly">[</span>fk<span class="gly">]</span>;</code><span class="hits">16</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span> <span class="C">// setter</span></code></li><li class="covered"><code>            this<span class="gly">[</span>fk<span class="gly">]</span> = p;</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">16</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define scope</span></code></li><li class=""><code><span class="C"> * TODO: describe behavior and usage examples</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>AbstractClass.scope = <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">defineScope</span>(this, this, name, params);</code><span class="hits">8</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">defineScope</span>(cls, targetClass, name, params, methods) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// collect meta info about scope</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!cls._scopeMeta) <span class="gly">{</span></code></li><li class="covered"><code>        cls._scopeMeta = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// anly make sence to add scope in meta if base and target classes</span></code></li><li class=""><code>    <span class="C">// are same</span></code></li><li class=""><code>    <span class="kwrd">if</span> (cls === targetClass) <span class="gly">{</span></code></li><li class="covered"><code>        cls._scopeMeta<span class="gly">[</span>name<span class="gly">]</span> = params;</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!targetClass._scopeMeta) <span class="gly">{</span></code></li><li class="covered"><code>            targetClass._scopeMeta = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(cls, name, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> f = <span class="kwrd">function</span> <span class="func">caller</span>(cond, cb) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> actualCond;</code><span class="hits">8</span></li><li class=""><code>                <span class="kwrd">if</span> (arguments.length === 1) <span class="gly">{</span></code></li><li class="covered"><code>                    actualCond = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class="covered"><code>                    cb = cond;</code><span class="hits">8</span></li><li class=""><code>                <span class="gly">}</span> else <span class="kwrd">if</span> (arguments.length === 2) <span class="gly">{</span></code></li><li class="uncovered"><code>                    actualCond = cond;</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Method only can be called with one or two arguments'</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>                <span class="kwrd">return</span> targetClass.<span class="func">all</span>(<span class="func">mergeParams</span>(actualCond, caller._scope), cb);</code><span class="hits">8</span></li><li class="covered"><code>            <span class="gly">}</span>;</code><span class="hits">96</span></li><li class="covered"><code>            f._scope = <span class="kwrd">typeof</span> params === <span class="S">'function'</span> ? params.<span class="func">call</span>(this) : params;</code><span class="hits">96</span></li><li class="covered"><code>            f.build = build;</code><span class="hits">96</span></li><li class="covered"><code>            f.create = create;</code><span class="hits">96</span></li><li class="covered"><code>            f.destroyAll = destroyAll;</code><span class="hits">96</span></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> methods) <span class="gly">{</span></code></li><li class="covered"><code>                f<span class="gly">[</span>i<span class="gly">]</span> = methods<span class="gly">[</span>i<span class="gly">]</span>.<span class="func">bind</span>(this);</code><span class="hits">128</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// define sub-scopes</span></code></li><li class=""><code>            Object.<span class="func">keys</span>(targetClass._scopeMeta).<span class="func">forEach</span>(<span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>                Object.<span class="func">defineProperty</span>(f, name, <span class="gly">{</span></code></li><li class=""><code>                    enumerable: false,</code></li><li class=""><code>                    get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                        <span class="func">mergeParams</span>(f._scope, targetClass._scopeMeta<span class="gly">[</span>name<span class="gly">]</span>);</code><span class="hits">24</span></li><li class="covered"><code>                        <span class="kwrd">return</span> f;</code><span class="hits">24</span></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">56</span></li><li class="covered"><code>            <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">96</span></li><li class="covered"><code>            <span class="kwrd">return</span> f;</code><span class="hits">96</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">16</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// and it should have create/build methods with binded thisModelNameId param</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">build</span>(data) <span class="gly">{</span></code></li><li class="covered"><code>        data = data <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">24</span></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">targetClass</span>(<span class="func">mergeParams</span>(this._scope, <span class="gly">{</span>where:data<span class="gly">}</span>).where);</code><span class="hits">24</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">create</span>(data, cb) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> data === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            cb = data;</code><span class="hits">16</span></li><li class="covered"><code>            data = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">16</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        this.<span class="func">build</span>(data).<span class="func">save</span>(cb);</code><span class="hits">16</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">destroyAll</span>(id, cb) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// implement me</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">mergeParams</span>(base, update) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (update.where) <span class="gly">{</span></code></li><li class="covered"><code>            base.where = <span class="func">merge</span>(base.where, update.where);</code><span class="hits">56</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// overwrite order</span></code></li><li class=""><code>        <span class="kwrd">if</span> (update.order) <span class="gly">{</span></code></li><li class="uncovered"><code>            base.order = update.order;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">return</span> base;</code><span class="hits">56</span></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether `s` is not undefined</span></code></li><li class=""><code><span class="C"> * @param {Mixed} s</span></code></li><li class=""><code><span class="C"> * @return {Boolean} s is undefined</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">isdef</span>(s) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> undef;</code><span class="hits">19675</span></li><li class="covered"><code>    <span class="kwrd">return</span> s !== undef;</code><span class="hits">19675</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Merge `base` and `update` params</span></code></li><li class=""><code><span class="C"> * @param {Object} base - base object (updating this object)</span></code></li><li class=""><code><span class="C"> * @param {Object} update - object with new data to update base</span></code></li><li class=""><code><span class="C"> * @returns {Object} `base`</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">merge</span>(base, update) <span class="gly">{</span></code></li><li class="covered"><code>    base = base <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">56</span></li><li class=""><code>    <span class="kwrd">if</span> (update) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(update).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>            base<span class="gly">[</span>key<span class="gly">]</span> = update<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">32</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">56</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> base;</code><span class="hits">56</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define readonly property on object</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} obj</span></code></li><li class=""><code><span class="C"> * @param {String} key</span></code></li><li class=""><code><span class="C"> * @param {Mixed} value</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">defineReadonlyProp</span>(obj, key, value) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(obj, key, <span class="gly">{</span></code></li><li class=""><code>        writable: false,</code></li><li class=""><code>        enumerable: true,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: value</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">949</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add object to cache</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addToCache</span>(constr, obj) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span>;</code><span class="hits">892</span></li><li class="uncovered"><code>    <span class="func">touchCache</span>(constr, obj.id);</code></li><li class="uncovered"><code>    constr.cache<span class="gly">[</span>obj.id<span class="gly">]</span> = obj;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Renew object position in LRU cache index</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">touchCache</span>(constr, id) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> cacheLimit = constr.CACHE_LIMIT <span class="gly">|</span><span class="gly">|</span> DEFAULT_CACHE_LIMIT;</code><span class="hits">600</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> ind = constr.mru.<span class="func">indexOf</span>(id);</code><span class="hits">600</span></li><li class="covered"><code>    <span class="kwrd">if</span> (~ind) constr.mru.<span class="func">splice</span>(ind, 1);</code><span class="hits">600</span></li><li class=""><code>    <span class="kwrd">if</span> (constr.mru.length >= cacheLimit * 2) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0; i < cacheLimit;i += 1) <span class="gly">{</span></code></li><li class="uncovered"><code>            delete constr.cache<span class="gly">[</span>constr.mru<span class="gly">[</span>i<span class="gly">]</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        constr.mru.<span class="func">splice</span>(0, cacheLimit);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Retrieve cached object</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getCached</span>(constr, id) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (id) <span class="func">touchCache</span>(constr, id);</code><span class="hits">606</span></li><li class="covered"><code>    <span class="kwrd">return</span> id && constr.cache<span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">606</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Clear cache (fully)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * removes both cache and LRU index</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Class} constr - class constructor</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">clearCache</span>(constr) <span class="gly">{</span></code></li><li class="covered"><code>    constr.cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">21</span></li><li class="covered"><code>    constr.mru = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">21</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Remove object from cache</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Class} constr</span></code></li><li class=""><code><span class="C"> * @param {id} id</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">removeFromCache</span>(constr, id) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ind = constr.mru.<span class="func">indexOf</span>(id);</code><span class="hits">9</span></li><li class="covered"><code>    <span class="kwrd">if</span> (!~ind) constr.mru.<span class="func">splice</span>(ind, 1);</code><span class="hits">9</span></li><li class="covered"><code>    delete constr.cache<span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">9</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-redis-js" class="filename" name="lib-adapters-redis-js" onclick="var el = document.getElementById('lib-adapters-redis-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/redis.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 88%"><strong>88%</strong> [210/443]</div></div></div></div><div id="lib-adapters-redis-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> redis = <span class="func">safeRequire</span>(<span class="S">'redis'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!redis) <span class="kwrd">return</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (schema.settings.url) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> url = <span class="func">require</span>(<span class="S">'url'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> redisUrl = url.<span class="func">parse</span>(schema.settings.url);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> redisAuth = (redisUrl.auth <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>).<span class="func">split</span>(<span class="S">':'</span>);</code></li><li class="uncovered"><code>        schema.settings.host = redisUrl.hostname;</code></li><li class="uncovered"><code>        schema.settings.port = redisUrl.port;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (redisAuth.length == 2) <span class="gly">{</span></code></li><li class="uncovered"><code>            schema.settings.db = redisAuth<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class="uncovered"><code>            schema.settings.password = redisAuth<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    schema.client = redis.<span class="func">createClient</span>(</code></li><li class=""><code>        schema.settings.port,</code></li><li class=""><code>        schema.settings.host,</code></li><li class=""><code>        schema.settings.options</code></li><li class="covered"><code>    );</code><span class="hits">1</span></li><li class="covered"><code>    schema.client.<span class="func">auth</span>(schema.settings.password);</code><span class="hits">1</span></li><li class="covered"><code>    schema.client.<span class="func">on</span>(<span class="S">'connect'</span>, callback);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">BridgeToRedis</span>(schema.client);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">BridgeToRedis</span>(client) <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    this.client = client;</code><span class="hits">1</span></li><li class="covered"><code>    this.indexes = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.define = <span class="kwrd">function</span> (descr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> m = descr.model.modelName;</code><span class="hits">3</span></li><li class="covered"><code>    this._models<span class="gly">[</span>m<span class="gly">]</span> = descr;</code><span class="hits">3</span></li><li class="covered"><code>    this.indexes<span class="gly">[</span>m<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code>    Object.<span class="func">keys</span>(descr.properties).<span class="func">forEach</span>(<span class="kwrd">function</span> (prop) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (descr.properties<span class="gly">[</span>prop<span class="gly">]</span>.index) <span class="gly">{</span></code></li><li class="covered"><code>            this.indexes<span class="gly">[</span>m<span class="gly">]</span><span class="gly">[</span>prop<span class="gly">]</span> = descr.properties<span class="gly">[</span>prop<span class="gly">]</span>.type;</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.defineForeignKey = <span class="kwrd">function</span> (model, key, cb) <span class="gly">{</span></code></li><li class="covered"><code>    this.indexes<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span> = Number;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="func">cb</span>(null, Number);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.save = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">deleteNulls</span>(data);</code><span class="hits">34</span></li><li class="covered"><code>    <span class="kwrd">var</span> log = this.<span class="func">logger</span>(<span class="S">'HMSET '</span> + model + <span class="S">':'</span> + data.id + <span class="S">' ...'</span>);</code><span class="hits">34</span></li><li class=""><code>    this.client.<span class="func">hmset</span>(model + <span class="S">':'</span> + data.id, data, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">log</span>();</code><span class="hits">34</span></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">34</span></li><li class="covered"><code>        this.<span class="func">updateIndexes</span>(model, data.id, data, callback);</code><span class="hits">34</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">34</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.updateIndexes = <span class="kwrd">function</span> (model, id, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> i = this.indexes<span class="gly">[</span>model<span class="gly">]</span>;</code><span class="hits">36</span></li><li class="covered"><code>    <span class="kwrd">var</span> schedule = <span class="gly">[</span><span class="gly">[</span><span class="S">'sadd'</span>, <span class="S">'s:'</span> + model, id<span class="gly">]</span><span class="gly">]</span>;</code><span class="hits">36</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (i<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>            schedule.<span class="func">push</span>(<span class="gly">[</span></code></li><li class=""><code>                <span class="S">'sadd'</span>,</code></li><li class=""><code>                <span class="S">'i:'</span> + model + <span class="S">':'</span> + key + <span class="S">':'</span> + data<span class="gly">[</span>key<span class="gly">]</span>,</code></li><li class=""><code>                model + <span class="S">':'</span> + id</code></li><li class="covered"><code>            <span class="gly">]</span>);</code><span class="hits">56</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">36</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (schedule.length) <span class="gly">{</span></code></li><li class=""><code>        this.client.<span class="func">multi</span>(schedule).<span class="func">exec</span>(<span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(err, data);</code><span class="hits">36</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">36</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">callback</span>(null);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.create = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (data.id) <span class="kwrd">return</span> create.<span class="func">call</span>(this, data.id, true);</code><span class="hits">29</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> log = this.<span class="func">logger</span>(<span class="S">'INCR id:'</span> + model);</code><span class="hits">29</span></li><li class=""><code>    this.client.<span class="func">incr</span>(<span class="S">'id:'</span> + model, <span class="kwrd">function</span> (err, id) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">log</span>();</code><span class="hits">29</span></li><li class="covered"><code>        create.<span class="func">call</span>(this, id);</code><span class="hits">29</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">29</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">create</span>(id, upsert) <span class="gly">{</span></code></li><li class="covered"><code>        data.id = id;</code><span class="hits">29</span></li><li class=""><code>        this.<span class="func">save</span>(model, data, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">callback</span>(err, id);</code><span class="hits">29</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">29</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// push the id to the list of user ids for sorting</span></code></li><li class="covered"><code>        <span class="func">log</span>(<span class="S">'SADD s:'</span> + model + <span class="S">' '</span> + data.id);</code><span class="hits">29</span></li><li class="covered"><code>        this.client.<span class="func">sadd</span>(<span class="S">"s:"</span> + model, upsert ? data : data.id);</code><span class="hits">29</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.updateOrCreate = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!data.id) <span class="kwrd">return</span> this.<span class="func">create</span>(model, data, callback);</code><span class="hits">2</span></li><li class="covered"><code>    this.<span class="func">save</span>(model, data, callback);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.exists = <span class="kwrd">function</span> (model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> log = this.<span class="func">logger</span>(<span class="S">'EXISTS '</span> + model + <span class="S">':'</span> + id);</code><span class="hits">3</span></li><li class=""><code>    this.client.<span class="func">exists</span>(model + <span class="S">':'</span> + id, <span class="kwrd">function</span> (err, exists) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">log</span>();</code><span class="hits">3</span></li><li class=""><code>        <span class="kwrd">if</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(err, exists);</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.find = <span class="kwrd">function</span> <span class="func">find</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code><span class="hits">9</span></li><li class=""><code>    this.client.<span class="func">hgetall</span>(model + <span class="S">':'</span> + id, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        this.<span class="func">log</span>(<span class="S">'HGETALL '</span> + model + <span class="S">':'</span> + id, t1);</code><span class="hits">9</span></li><li class=""><code>        <span class="kwrd">if</span> (data && Object.<span class="func">keys</span>(data).length > 0) <span class="gly">{</span></code></li><li class="covered"><code>            data.id = id;</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            data = null;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">9</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">9</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code><span class="hits">1</span></li><li class=""><code>    this.client.<span class="func">del</span>(model + <span class="S">':'</span> + id, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        this.<span class="func">log</span>(<span class="S">'DEL '</span> + model + <span class="S">':'</span> + id, t1);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">callback</span>(err);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">1</span></li><li class="covered"><code>    this.<span class="func">log</span>(<span class="S">'SREM s:'</span> + model, t1);</code><span class="hits">1</span></li><li class="covered"><code>    this.client.<span class="func">srem</span>(<span class="S">"s:"</span> + model, id);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.possibleIndexes = <span class="kwrd">function</span> (model, filter) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!filter <span class="gly">|</span><span class="gly">|</span> Object.<span class="func">keys</span>(filter.where <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>).length === 0) <span class="kwrd">return</span> false;</code><span class="hits">13</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> foundIndex = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">13</span></li><li class="covered"><code>    <span class="kwrd">var</span> noIndex = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">13</span></li><li class=""><code>    Object.<span class="func">keys</span>(filter.where).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (this.indexes<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span> && (<span class="kwrd">typeof</span> filter.where<span class="gly">[</span>key<span class="gly">]</span> === <span class="S">'string'</span> <span class="gly">|</span><span class="gly">|</span> <span class="kwrd">typeof</span> filter.where<span class="gly">[</span>key<span class="gly">]</span> === <span class="S">'number'</span>)) <span class="gly">{</span></code></li><li class="covered"><code>            foundIndex.<span class="func">push</span>(<span class="S">'i:'</span> + model + <span class="S">':'</span> + key + <span class="S">':'</span> + filter.where<span class="gly">[</span>key<span class="gly">]</span>);</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            noIndex.<span class="func">push</span>(key);</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">13</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="gly">[</span>foundIndex, noIndex<span class="gly">]</span>;</code><span class="hits">13</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ts = Date.<span class="func">now</span>();</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> client = this.client;</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> log = this.log;</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> cmd;</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> that = this;</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> sortCmd = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">18</span></li><li class="covered"><code>    <span class="kwrd">var</span> allNumeric = true;</code><span class="hits">18</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// TODO: we need strict mode when filtration only possible when we have indexes</span></code></li><li class=""><code>    <span class="C">// WHERE</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter && filter.where) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> pi = this.<span class="func">possibleIndexes</span>(model, filter);</code><span class="hits">13</span></li><li class="covered"><code>        <span class="kwrd">var</span> indexes = pi<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">13</span></li><li class="covered"><code>        <span class="kwrd">var</span> noIndexes = pi<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">13</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (indexes && indexes.length) <span class="gly">{</span></code></li><li class="covered"><code>            cmd = <span class="S">'SINTER "'</span> + indexes.jo<span class="kwrd">in</span>(<span class="S">'" "'</span>) + <span class="S">'"'</span>;</code><span class="hits">10</span></li><li class=""><code>            <span class="kwrd">if</span> (noIndexes.length) <span class="gly">{</span></code></li><li class=""><code>                <span class="func">log</span>(model + <span class="S">': no indexes found for '</span>, noIndexes.jo<span class="kwrd">in</span>(<span class="S">', '</span>),</code></li><li class="uncovered"><code>                    <span class="S">'slow sorting and filtering'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            indexes.<span class="func">push</span>(noIndexes.length ? orderLimitStageBad : orderLimitStage);</code><span class="hits">10</span></li><li class="covered"><code>            client.sinter.<span class="func">apply</span>(client, indexes);</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// filter manually</span></code></li><li class="covered"><code>            cmd = <span class="S">'KEYS '</span> + model + <span class="S">':*'</span>;</code><span class="hits">3</span></li><li class="covered"><code>            client.<span class="func">keys</span>(model + <span class="S">':*'</span>, orderLimitStageBad);</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// no filtering, just sort/limit (if any)</span></code></li><li class="covered"><code>        <span class="func">gotKeys</span>(<span class="S">'*'</span>);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// bad case when we trying to filter on non-indexed fields</span></code></li><li class=""><code>    <span class="C">// in bad case we need retrieve all data and filter/limit/sort manually</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">orderLimitStageBad</span>(err, keys) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">log</span>(cmd, t1);</code><span class="hits">3</span></li><li class="covered"><code>        <span class="kwrd">var</span> t2 = Date.<span class="func">now</span>();</code><span class="hits">3</span></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">var</span> query = keys.<span class="func">map</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="gly">[</span><span class="S">'hgetall'</span>, key<span class="gly">]</span>;</code><span class="hits">40</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code>        client.<span class="func">multi</span>(query).<span class="func">exec</span>(<span class="kwrd">function</span> (err, replies) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">log</span>(query, t2);</code><span class="hits">3</span></li><li class="covered"><code>            <span class="func">gotFilteredData</span>(err, replies.<span class="func">filter</span>(<span class="func">applyFilter</span>(filter)));</code><span class="hits">3</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">gotFilteredData</span>(err, nodes) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(null);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> allNumeric = true;</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> orders = filter.order;</code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.order === <span class="S">"string"</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    orders = <span class="gly">[</span>filter.order<span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>                orders.<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="uncovered"><code>                    key = key.<span class="func">split</span>(<span class="S">' '</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class=""><code>                    <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>.type.name !== <span class="S">'Number'</span> && props<span class="gly">[</span>key<span class="gly">]</span>.type.name !== <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                        allNumeric = false;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class=""><code>                <span class="kwrd">if</span> (allNumeric) <span class="gly">{</span></code></li><li class="uncovered"><code>                    nodes = nodes.<span class="func">sort</span>(numerically.<span class="func">bind</span>(orders));</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    nodes = nodes.<span class="func">sort</span>(literally.<span class="func">bind</span>(orders));</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// LIMIT</span></code></li><li class=""><code>            <span class="kwrd">if</span> (filter && filter.limit) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> from = (filter.offset <span class="gly">|</span><span class="gly">|</span> 0), to = from + filter.limit;</code></li><li class="uncovered"><code>                <span class="func">callback</span>(null, nodes.<span class="func">slice</span>(from, to));</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">callback</span>(null, nodes);</code><span class="hits">3</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">orderLimitStage</span>(err, keys) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">log</span>(cmd, t1);</code><span class="hits">10</span></li><li class="covered"><code>        <span class="kwrd">var</span> t2 = Date.<span class="func">now</span>();</code><span class="hits">10</span></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">gotKeys</span>(keys);</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">gotKeys</span>(keys) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// ORDER</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> reverse = false;</code><span class="hits">15</span></li><li class=""><code>        <span class="kwrd">if</span> (filter && filter.order) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> orders = filter.order;</code><span class="hits">6</span></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.order === <span class="S">"string"</span>)<span class="gly">{</span></code></li><li class="covered"><code>                orders = <span class="gly">[</span>filter.order<span class="gly">]</span>;</code><span class="hits">6</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            orders.<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> m = key.<span class="func">match</span>(<span class="R">/\s+(A|DE)SC$/i</span>);</code><span class="hits">6</span></li><li class=""><code>                <span class="kwrd">if</span> (m) <span class="gly">{</span></code></li><li class="covered"><code>                    key = key.<span class="func">replace</span>(<span class="R">/\s+(A|DE)SC/i</span>, <span class="S">''</span>);</code><span class="hits">3</span></li><li class="covered"><code>                    <span class="kwrd">if</span> (m<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'DE'</span>) reverse = true;</code><span class="hits">3</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>                <span class="kwrd">if</span> (key !== <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>.type.name !== <span class="S">'Number'</span> && props<span class="gly">[</span>key<span class="gly">]</span>.type.name !== <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                        allNumeric = false;</code><span class="hits">5</span></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                sortCmd.<span class="func">push</span>(<span class="S">"BY"</span>, model + <span class="S">":*->"</span> + key);</code><span class="hits">6</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// LIMIT</span></code></li><li class=""><code>        <span class="kwrd">if</span> (keys === <span class="S">'*'</span> && filter && filter.limit)<span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> from = (filter.offset <span class="gly">|</span><span class="gly">|</span> 0), to = from + filter.limit;</code><span class="hits">1</span></li><li class="covered"><code>            sortCmd.<span class="func">push</span>(<span class="S">"LIMIT"</span>, from, to);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// we need ALPHA modifier when sorting string values</span></code></li><li class=""><code>        <span class="C">// the only case it's not required - we sort numbers</span></code></li><li class=""><code>        <span class="C">// TODO: check if we sort numbers</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!allNumeric) <span class="gly">{</span></code></li><li class="covered"><code>            sortCmd.<span class="func">push</span>(<span class="S">'ALPHA'</span>);</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (reverse) <span class="gly">{</span></code></li><li class="covered"><code>            sortCmd.<span class="func">push</span>(<span class="S">'DESC'</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (sortCmd.length) <span class="gly">{</span></code></li><li class="covered"><code>            sortCmd.<span class="func">unshift</span>(<span class="S">"s:"</span> + model);</code><span class="hits">7</span></li><li class="covered"><code>            sortCmd.<span class="func">push</span>(<span class="S">"GET"</span>, <span class="S">"#"</span>);</code><span class="hits">7</span></li><li class="covered"><code>            cmd = <span class="S">"SORT "</span> + sortCmd.jo<span class="kwrd">in</span>(<span class="S">" "</span>);</code><span class="hits">7</span></li><li class="covered"><code>            <span class="kwrd">var</span> ttt = Date.<span class="func">now</span>();</code><span class="hits">7</span></li><li class=""><code>            sortCmd.<span class="func">push</span>(<span class="kwrd">function</span>(err, ids)<span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                <span class="func">log</span>(cmd, ttt);</code><span class="hits">7</span></li><li class=""><code>                <span class="kwrd">var</span> sortedKeys = ids.<span class="func">map</span>(<span class="kwrd">function</span> (i) <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">return</span> model + <span class="S">":"</span> + i;</code><span class="hits">35</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">7</span></li><li class="covered"><code>                <span class="func">handleKeys</span>(err, <span class="func">intersect</span>(sortedKeys, keys));</code><span class="hits">7</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">7</span></li><li class="covered"><code>            client.sort.<span class="func">apply</span>(client, sortCmd);</code><span class="hits">7</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// no sorting or filtering: just get all keys</span></code></li><li class=""><code>            <span class="kwrd">if</span> (keys === <span class="S">'*'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                cmd = <span class="S">'KEYS '</span> + model + <span class="S">':*'</span>;</code><span class="hits">2</span></li><li class="covered"><code>                client.<span class="func">keys</span>(model + <span class="S">':*'</span>, handleKeys);</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">handleKeys</span>(null, keys);</code><span class="hits">6</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">handleKeys</span>(err, keys) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> t2 = Date.<span class="func">now</span>();</code><span class="hits">15</span></li><li class=""><code>        <span class="kwrd">var</span> query = keys.<span class="func">map</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="gly">[</span><span class="S">'hgetall'</span>, key<span class="gly">]</span>;</code><span class="hits">96</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">15</span></li><li class=""><code>        client.<span class="func">multi</span>(query).<span class="func">exec</span>(<span class="kwrd">function</span> (err, replies) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">log</span>(query, t2);</code><span class="hits">15</span></li><li class=""><code>            <span class="C">// console.log('Redis time: %dms', Date.now() - ts);</span></code></li><li class="covered"><code>            <span class="func">callback</span>(err, filter ? replies.<span class="func">filter</span>(<span class="func">applyFilter</span>(filter)) : replies);</code><span class="hits">15</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">15</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span>;</code><span class="hits">18</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">numerically</span>(a, b) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> a<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span> - b<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">literally</span>(a, b) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> a<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span> > b<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// TODO: find better intersection method</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">intersect</span>(sortedKeys, filteredKeys) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (filteredKeys === <span class="S">'*'</span>) <span class="kwrd">return</span> sortedKeys;</code><span class="hits">4</span></li><li class="covered"><code>        <span class="kwrd">var</span> index = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code>        filteredKeys.<span class="func">forEach</span>(<span class="kwrd">function</span> (x) <span class="gly">{</span></code></li><li class="covered"><code>            index<span class="gly">[</span>x<span class="gly">]</span> = true;</code><span class="hits">288</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>        <span class="kwrd">return</span> sortedKeys.<span class="func">filter</span>(<span class="kwrd">function</span> (x) <span class="gly">{</span></code><span class="hits">4</span></li><li class="covered"><code>            <span class="kwrd">return</span> index<span class="gly">[</span>x<span class="gly">]</span>;</code><span class="hits">24</span></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">applyFilter</span>(filter) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.where === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> filter.where;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> keys = Object.<span class="func">keys</span>(filter.where <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>);</code><span class="hits">16</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> (obj) <span class="gly">{</span></code><span class="hits">16</span></li><li class="covered"><code>        <span class="kwrd">var</span> pass = true;</code><span class="hits">120</span></li><li class=""><code>        keys.<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!<span class="func">test</span>(filter.where<span class="gly">[</span>key<span class="gly">]</span>, obj<span class="gly">[</span>key<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>                pass = false;</code><span class="hits">84</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">120</span></li><li class="covered"><code>        <span class="kwrd">return</span> pass;</code><span class="hits">120</span></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">test</span>(example, value) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'string'</span> && example && example.constructor.name === <span class="S">'RegExp'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> value.<span class="func">match</span>(example);</code><span class="hits">15</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="C">// not strict equality</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> example == value;</code><span class="hits">94</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> keysQuery = model + <span class="S">':*'</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code><span class="hits">2</span></li><li class=""><code>    this.client.<span class="func">keys</span>(keysQuery, <span class="kwrd">function</span> (err, keys) <span class="gly">{</span></code></li><li class="covered"><code>        this.<span class="func">log</span>(<span class="S">'KEYS '</span> + keysQuery, t1);</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">var</span> query = keys.<span class="func">map</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="gly">[</span><span class="S">'del'</span>, key<span class="gly">]</span>;</code><span class="hits">30</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="kwrd">var</span> t2 = Date.<span class="func">now</span>();</code><span class="hits">2</span></li><li class=""><code>        this.client.<span class="func">multi</span>(query).<span class="func">exec</span>(<span class="kwrd">function</span> (err, replies) <span class="gly">{</span></code></li><li class="covered"><code>            this.<span class="func">log</span>(query, t2);</code><span class="hits">2</span></li><li class=""><code>            this.client.<span class="func">del</span>(<span class="S">'s:'</span> + model, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">callback</span>(err);</code><span class="hits">2</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> keysQuery = model + <span class="S">':*'</span>;</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code><span class="hits">3</span></li><li class=""><code>    <span class="kwrd">if</span> (where && Object.<span class="func">keys</span>(where).length) <span class="gly">{</span></code></li><li class=""><code>        this.<span class="func">all</span>(model, <span class="gly">{</span>where: where<span class="gly">}</span>, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(err, err ? null : data.length);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        this.client.<span class="func">keys</span>(keysQuery, <span class="kwrd">function</span> (err, keys) <span class="gly">{</span></code></li><li class="covered"><code>            this.<span class="func">log</span>(<span class="S">'KEYS '</span> + keysQuery, t1);</code><span class="hits">2</span></li><li class="covered"><code>            <span class="func">callback</span>(err, err ? null : keys.length);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttrs</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code><span class="hits">2</span></li><li class="covered"><code>    <span class="func">deleteNulls</span>(data);</code><span class="hits">2</span></li><li class=""><code>    this.client.<span class="func">hmset</span>(model + <span class="S">':'</span> + id, data, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        this.<span class="func">log</span>(<span class="S">'HMSET '</span> + model + <span class="S">':'</span> + id, t1);</code><span class="hits">2</span></li><li class="covered"><code>        this.<span class="func">updateIndexes</span>(model, id, data, cb);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">deleteNulls</span>(data) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (data<span class="gly">[</span>key<span class="gly">]</span> === null) delete data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">231</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">36</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>BridgeToRedis.prototype.disconnect = <span class="kwrd">function</span> <span class="func">disconnect</span>() <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">log</span>(<span class="S">'QUIT'</span>, Date.<span class="func">now</span>());</code><span class="hits">1</span></li><li class="covered"><code>    this.client.<span class="func">quit</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-mysql-js" class="filename" name="lib-adapters-mysql-js" onclick="var el = document.getElementById('lib-adapters-mysql-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/mysql.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 89%"><strong>89%</strong> [201/432]</div></div></div></div><div id="lib-adapters-mysql-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> mysql = <span class="func">safeRequire</span>(<span class="S">'mysql'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> BaseSQL = <span class="func">require</span>(<span class="S">'../sql'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!mysql) <span class="kwrd">return</span>;</code><span class="hits">2</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> s = schema.settings;</code><span class="hits">2</span></li><li class=""><code>    schema.client = mysql.<span class="func">createClient</span>(<span class="gly">{</span></code></li><li class=""><code>        host: s.host <span class="gly">|</span><span class="gly">|</span> <span class="S">'localhost'</span>,</code></li><li class=""><code>        port: s.port <span class="gly">|</span><span class="gly">|</span> 3306,</code></li><li class=""><code>        user: s.username,</code></li><li class=""><code>        password: s.password,</code></li><li class=""><code>        debug: s.debug</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">MySQL</span>(schema.client);</code><span class="hits">2</span></li><li class="covered"><code>    schema.adapter.schema = schema;</code><span class="hits">2</span></li><li class=""><code>    <span class="C">// schema.client.query('SET TIME_ZONE = "+04:00"', callback);</span></code></li><li class=""><code>    schema.client.<span class="func">query</span>(<span class="S">'USE '</span> + s.database, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err && err.message.<span class="func">match</span>(<span class="R">/^unknown database/i</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> dbName = s.database;</code></li><li class=""><code>            schema.client.<span class="func">query</span>(<span class="S">'CREATE DATABASE '</span> + dbName, <span class="kwrd">function</span> (error) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!error) <span class="gly">{</span></code></li><li class="uncovered"><code>                    schema.client.<span class="func">query</span>(<span class="S">'USE '</span> + s.database, callback);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    throw error;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="covered"><code>        <span class="gly">}</span> else <span class="func">callback</span>();</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * MySQL adapter</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">MySQL</span>(client) <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class="covered"><code>    this.client = client;</code><span class="hits">2</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="func">require</span>(<span class="S">'util'</span>).<span class="func">inherits</span>(MySQL, BaseSQL);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.query = <span class="kwrd">function</span> (sql, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this.schema.connected) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> this.schema.<span class="func">on</span>(<span class="S">'connected'</span>, <span class="kwrd">function</span> () <span class="gly">{</span></code><span class="hits">1</span></li><li class="covered"><code>            this.<span class="func">query</span>(sql, callback);</code><span class="hits">1</span></li><li class="uncovered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> client = this.client;</code><span class="hits">105</span></li><li class="covered"><code>    <span class="kwrd">var</span> time = Date.<span class="func">now</span>();</code><span class="hits">105</span></li><li class="covered"><code>    <span class="kwrd">var</span> log = this.log;</code><span class="hits">105</span></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> callback !== <span class="S">'function'</span>) throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'callback should be a function'</span>);</code><span class="hits">105</span></li><li class=""><code>    this.client.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err && err.message.<span class="func">match</span>(<span class="R">/^unknown database/i</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> dbName = err.message.<span class="func">match</span>(<span class="R">/^unknown database ~~~S11~~~/i</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>            client.<span class="func">query</span>(<span class="S">'CREATE DATABASE '</span> + dbName, <span class="kwrd">function</span> (error) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (!error) <span class="gly">{</span></code></li><li class="uncovered"><code>                    client.<span class="func">query</span>(sql, callback);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="func">callback</span>(err);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (log) <span class="func">log</span>(sql, time);</code><span class="hits">105</span></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">105</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">105</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Must invoke callback(err, id)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>MySQL.prototype.create = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> fields = this.<span class="func">toFields</span>(model, data);</code><span class="hits">39</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'INSERT INTO '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">39</span></li><li class=""><code>    <span class="kwrd">if</span> (fields) <span class="gly">{</span></code></li><li class="covered"><code>        sql += <span class="S">' SET '</span> + fields;</code><span class="hits">39</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        sql += <span class="S">' VALUES ()'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, info) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, info && info.insertId);</code><span class="hits">39</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">39</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.updateOrCreate = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> mysql = this;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> fieldsNames = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> fieldValues = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> combined = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">2</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> key === <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> k = <span class="S">'`'</span> + key + <span class="S">'`'</span>;</code><span class="hits">12</span></li><li class="covered"><code>            <span class="kwrd">var</span> v;</code><span class="hits">12</span></li><li class=""><code>            <span class="kwrd">if</span> (key !== <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                v = mysql.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>);</code><span class="hits">10</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                v = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            fieldsNames.<span class="func">push</span>(k);</code><span class="hits">12</span></li><li class="covered"><code>            fieldValues.<span class="func">push</span>(v);</code><span class="hits">12</span></li><li class="covered"><code>            <span class="kwrd">if</span> (key !== <span class="S">'id'</span>) combined.<span class="func">push</span>(k + <span class="S">' = '</span> + v);</code><span class="hits">12</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'INSERT INTO '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">' ('</span> + fieldsNames.jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">')'</span>;</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">' VALUES ('</span> + fieldValues.jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">')'</span>;</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">' ON DUPLICATE KEY UPDATE '</span> + combined.jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, info) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!err && info && info.insertId) <span class="gly">{</span></code></li><li class="covered"><code>            data.id = info.insertId;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.toFields = <span class="kwrd">function</span> (model, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> fields = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">44</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">44</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            fields.<span class="func">push</span>(<span class="S">'`'</span> + key.<span class="func">replace</span>(<span class="R">/\./g</span>, <span class="S">'`.`'</span>) + <span class="S">'` = '</span> + this.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>));</code><span class="hits">239</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">44</span></li><li class="covered"><code>    <span class="kwrd">return</span> fields.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code><span class="hits">44</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">dateToMysql</span>(val) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> val.<span class="func">getUTCFullYear</span>() + <span class="S">'-'</span> +</code><span class="hits">39</span></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCMonth</span>() + 1) + <span class="S">'-'</span> +</code></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCDate</span>()) + <span class="S">' '</span> +</code></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCHours</span>()) + <span class="S">':'</span> +</code></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCMinutes</span>()) + <span class="S">':'</span> +</code></li><li class="uncovered"><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCSeconds</span>());</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">fillZeros</span>(v) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> v < 10 ? <span class="S">'0'</span> + v : v;</code><span class="hits">195</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.toDatabase = <span class="kwrd">function</span> (prop, val) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (val === null) <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code><span class="hits">121</span></li><li class=""><code>    <span class="kwrd">if</span> (val.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> operator = Object.<span class="func">keys</span>(val)<span class="gly">[</span>0<span class="gly">]</span></code></li><li class="covered"><code>        val = val<span class="gly">[</span>operator<span class="gly">]</span>;</code><span class="hits">5</span></li><li class=""><code>        <span class="kwrd">if</span> (operator === <span class="S">'between'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span>  this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>0<span class="gly">]</span>) +</code><span class="hits">1</span></li><li class=""><code>                    <span class="S">' AND '</span> +</code></li><li class="uncovered"><code>                    this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>1<span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (operator == <span class="S">'inq'</span> <span class="gly">|</span><span class="gly">|</span> operator == <span class="S">'nin'</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!(val.<span class="func">propertyIsEnumerable</span>(<span class="S">'length'</span>)) && <span class="kwrd">typeof</span> val === <span class="S">'object'</span> && <span class="kwrd">typeof</span> val.length === <span class="S">'number'</span>) <span class="gly">{</span> <span class="C">//if value is array</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> val.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> val;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!prop) <span class="kwrd">return</span> val;</code><span class="hits">120</span></li><li class="covered"><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Number'</span>) <span class="kwrd">return</span> val;</code><span class="hits">118</span></li><li class=""><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (!val) <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code><span class="hits">39</span></li><li class=""><code>        <span class="kwrd">if</span> (!val.toUTCString) <span class="gly">{</span></code></li><li class="covered"><code>            val = <span class="kwrd">new</span> <span class="func">Date</span>(val);</code><span class="hits">14</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'"'</span> + <span class="func">dateToMysql</span>(val) + <span class="S">'"'</span>;</code><span class="hits">39</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (prop.type.name == <span class="S">"Boolean"</span>) <span class="kwrd">return</span> val ? 1 : 0;</code><span class="hits">47</span></li><li class="covered"><code>    <span class="kwrd">return</span> this.client.<span class="func">escape</span>(val.<span class="func">toString</span>());</code><span class="hits">47</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.fromDatabase = <span class="kwrd">function</span> (model, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!data) <span class="kwrd">return</span> null;</code><span class="hits">74</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">74</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> val = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">478</span></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>.type.name === <span class="S">'Date'</span> && val !== null) <span class="gly">{</span></code></li><li class="covered"><code>                val = <span class="kwrd">new</span> <span class="func">Date</span>(val.<span class="func">toString</span>().<span class="func">replace</span>(<span class="R">/GMT.*$/</span>, <span class="S">'GMT'</span>));</code><span class="hits">57</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        data<span class="gly">[</span>key<span class="gly">]</span> = val;</code><span class="hits">478</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">74</span></li><li class="covered"><code>    <span class="kwrd">return</span> data;</code><span class="hits">74</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.escapeName = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'`'</span> + name.<span class="func">replace</span>(<span class="R">/\./g</span>, <span class="S">'`.`'</span>) + <span class="S">'`'</span>;</code><span class="hits">114</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT * FROM '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">21</span></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">21</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class="covered"><code>            sql += <span class="S">' '</span> + <span class="func">buildWhere</span>(filter.where);</code><span class="hits">16</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="covered"><code>            sql += <span class="S">' '</span> + <span class="func">buildOrderBy</span>(filter.order);</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.limit) <span class="gly">{</span></code></li><li class="covered"><code>            sql += <span class="S">' '</span> + <span class="func">buildLimit</span>(filter.limit, filter.offset <span class="gly">|</span><span class="gly">|</span> 0);</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="func">callback</span>(null, data.<span class="func">map</span>(<span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> self.<span class="func">fromDatabase</span>(model, obj);</code><span class="hits">66</span></li><li class="covered"><code>        <span class="gly">}</span>));</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">21</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> sql;</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildWhere</span>(conds) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> cs = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">16</span></li><li class=""><code>        Object.<span class="func">keys</span>(conds).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> keyEscaped = <span class="S">'`'</span> + key.<span class="func">replace</span>(<span class="R">/\./g</span>, <span class="S">'`.`'</span>) + <span class="S">'`'</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> val = self.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, conds<span class="gly">[</span>key<span class="gly">]</span>);</code><span class="hits">16</span></li><li class=""><code>            <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span> === null) <span class="gly">{</span></code></li><li class="covered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' IS NULL'</span>);</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span>.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> condType = Object.<span class="func">keys</span>(conds<span class="gly">[</span>key<span class="gly">]</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">5</span></li><li class="covered"><code>                <span class="kwrd">var</span> sqlCond = keyEscaped;</code><span class="hits">5</span></li><li class=""><code>                <span class="kwrd">switch</span> (condType) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'gt'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' > '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'gte'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' >= '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'lt'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' < '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'lte'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' <= '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'between'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' BETWEEN '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'inq'</span>:</code></li><li class="uncovered"><code>                        sqlCond += <span class="S">' IN '</span>;</code></li><li class="uncovered"><code>                        <span class="kwrd">break</span>;</code></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'nin'</span>:</code></li><li class="uncovered"><code>                        sqlCond += <span class="S">' NOT IN '</span>;</code></li><li class="uncovered"><code>                        <span class="kwrd">break</span>;</code></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'neq'</span>:</code></li><li class="uncovered"><code>                        sqlCond + <span class="S">' != '</span>;</code></li><li class="uncovered"><code>                        <span class="kwrd">break</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                sqlCond += (condType == <span class="S">'inq'</span> <span class="gly">|</span><span class="gly">|</span> condType == <span class="S">'nin'</span>) ? <span class="S">'('</span> + val + <span class="S">')'</span> : val;</code><span class="hits">5</span></li><li class="covered"><code>                cs.<span class="func">push</span>(sqlCond);</code><span class="hits">5</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' = '</span> + val);</code><span class="hits">10</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">16</span></li><li class=""><code>        <span class="kwrd">if</span> (cs.length === 0) <span class="gly">{</span></code></li><li class="uncovered"><code>          <span class="kwrd">return</span> <span class="S">''</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'WHERE '</span> + cs.jo<span class="kwrd">in</span>(<span class="S">' AND '</span>);</code><span class="hits">16</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildOrderBy</span>(order) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> order === <span class="S">'string'</span>) order = <span class="gly">[</span>order<span class="gly">]</span>;</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'ORDER BY '</span> + order.jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildLimit</span>(limit, offset) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'LIMIT '</span> + (offset ? (offset + <span class="S">', '</span> + limit) : limit);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.autoupdate = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> wait = 0;</code><span class="hits">1</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>        wait += 1;</code><span class="hits">1</span></li><li class=""><code>        self.<span class="func">query</span>(<span class="S">'SHOW FIELDS FROM '</span> + self.<span class="func">tableEscaped</span>(model), <span class="kwrd">function</span> (err, fields) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!err && fields.length) <span class="gly">{</span></code></li><li class="covered"><code>                self.<span class="func">alterTable</span>(model, fields, done);</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                self.<span class="func">createTable</span>(model, done);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 && cb) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>();</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.isActual = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ok = false;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> wait = 0;</code><span class="hits">2</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>        wait += 1;</code><span class="hits">2</span></li><li class=""><code>        self.<span class="func">query</span>(<span class="S">'SHOW FIELDS FROM '</span> + model, <span class="kwrd">function</span> (err, fields) <span class="gly">{</span></code></li><li class="covered"><code>            self.<span class="func">alterTable</span>(model, fields, done, true);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err, needAlter) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        ok = ok <span class="gly">|</span><span class="gly">|</span> needAlter;</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 && cb) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>(null, !ok);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.alterTable = <span class="kwrd">function</span> (model, actualFields, done, checkOnly) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> m = this._models<span class="gly">[</span>model<span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code>    <span class="kwrd">var</span> propNames = Object.<span class="func">keys</span>(m.properties).<span class="func">filter</span>(<span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> !!m.properties<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">24</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// change/add new fields</span></code></li><li class=""><code>    propNames.<span class="func">forEach</span>(<span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> found;</code><span class="hits">20</span></li><li class=""><code>        actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span> (f) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (f.Field === propName) <span class="gly">{</span></code></li><li class="covered"><code>                found = f;</code><span class="hits">19</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">20</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (found) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">actualize</span>(propName, found);</code><span class="hits">19</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            sql.<span class="func">push</span>(<span class="S">'ADD COLUMN `'</span> + propName + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// drop columns</span></code></li><li class=""><code>    actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span> (f) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> notFound = !~propNames.<span class="func">indexOf</span>(f.Field);</code><span class="hits">24</span></li><li class="covered"><code>        <span class="kwrd">if</span> (f.Field === <span class="S">'id'</span>) <span class="kwrd">return</span>;</code><span class="hits">21</span></li><li class=""><code>        <span class="kwrd">if</span> (notFound <span class="gly">|</span><span class="gly">|</span> !m.properties<span class="gly">[</span>f.Field<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            sql.<span class="func">push</span>(<span class="S">'DROP COLUMN `'</span> + f.Field + <span class="S">'`'</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (sql.length) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (checkOnly) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">done</span>(null, true);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            this.<span class="func">query</span>(<span class="S">'ALTER TABLE `'</span> + model + <span class="S">'` '</span> + sql.jo<span class="kwrd">in</span>(<span class="S">',\n'</span>), done);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">done</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">actualize</span>(propName, oldSettings) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> newSettings = m.properties<span class="gly">[</span>propName<span class="gly">]</span>;</code><span class="hits">19</span></li><li class=""><code>        <span class="kwrd">if</span> (newSettings && <span class="func">changed</span>(newSettings, oldSettings)) <span class="gly">{</span></code></li><li class="covered"><code>            sql.<span class="func">push</span>(<span class="S">'CHANGE COLUMN `'</span> + propName + <span class="S">'` `'</span> + propName + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">changed</span>(newSettings, oldSettings) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'YES'</span> && (newSettings.allowNull === false <span class="gly">|</span><span class="gly">|</span> newSettings.null === false)) <span class="kwrd">return</span> true;</code><span class="hits">19</span></li><li class="covered"><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'NO'</span> && !(newSettings.allowNull === false <span class="gly">|</span><span class="gly">|</span> newSettings.null === false)) <span class="kwrd">return</span> true;</code><span class="hits">18</span></li><li class="covered"><code>        <span class="kwrd">if</span> (oldSettings.Type.toUpper<span class="kwrd">Case</span>() !== <span class="func">datatype</span>(newSettings)) <span class="kwrd">return</span> true;</code><span class="hits">17</span></li><li class="covered"><code>        <span class="kwrd">return</span> false;</code><span class="hits">17</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.propertiesSQL = <span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="S">'`id` INT(11) NOT NULL AUTO_INCREMENT UNIQUE PRIMARY KEY'</span><span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models<span class="gly">[</span>model<span class="gly">]</span>.properties).<span class="func">forEach</span>(<span class="kwrd">function</span> (prop) <span class="gly">{</span></code></li><li class="covered"><code>        sql.<span class="func">push</span>(<span class="S">'`'</span> + prop + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, prop));</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">return</span> sql.jo<span class="kwrd">in</span>(<span class="S">',\n  '</span>);</code><span class="hits">4</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MySQL.prototype.propertySettingsSQL = <span class="kwrd">function</span> (model, prop) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> p = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span>;</code><span class="hits">24</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="func">datatype</span>(p) + <span class="S">' '</span> +</code><span class="hits">24</span></li><li class="uncovered"><code>    (p.allowNull === false <span class="gly">|</span><span class="gly">|</span> p<span class="gly">[</span><span class="S">'null'</span><span class="gly">]</span> === false ? <span class="S">'NOT NULL'</span> : <span class="S">'NULL'</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">datatype</span>(p) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> dt = <span class="S">''</span>;</code><span class="hits">42</span></li><li class=""><code>    <span class="kwrd">switch</span> (p.type.name) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'String'</span>:</code></li><li class="covered"><code>        dt = <span class="S">'VARCHAR('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 255) + <span class="S">')'</span>;</code><span class="hits">17</span></li><li class="covered"><code>        <span class="kwrd">break</span>;</code><span class="hits">17</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Text'</span>:</code></li><li class="covered"><code>        dt = <span class="S">'TEXT'</span>;</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">break</span>;</code><span class="hits">6</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Number'</span>:</code></li><li class="covered"><code>        dt = <span class="S">'INT('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 11) + <span class="S">')'</span>;</code><span class="hits">7</span></li><li class="covered"><code>        <span class="kwrd">break</span>;</code><span class="hits">7</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Date'</span>:</code></li><li class="covered"><code>        dt = <span class="S">'DATETIME'</span>;</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">break</span>;</code><span class="hits">6</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Boolean'</span>:</code></li><li class="covered"><code>        dt = <span class="S">'TINYINT(1)'</span>;</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">break</span>;</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> dt;</code><span class="hits">42</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-sqlite-js" class="filename" name="lib-adapters-sqlite-js" onclick="var el = document.getElementById('lib-adapters-sqlite-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/sqlite3.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 78%"><strong>78%</strong> [198/408]</div></div></div></div><div id="lib-adapters-sqlite-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> sqlite3 = <span class="func">safeRequire</span>(<span class="S">'sqlite3'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> BaseSQL = <span class="func">require</span>(<span class="S">'../sql'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!sqlite3) <span class="kwrd">return</span>;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> s = schema.settings;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> Database = sqlite3.<span class="func">verbose</span>().Database;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> db = <span class="kwrd">new</span> <span class="func">Database</span>(s.database);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    schema.client = db;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">SQLite3</span>(schema.client);</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (s.database === <span class="S">':memory:'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        schema.adapter.<span class="func">automigrate</span>(callback);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        process.<span class="func">nextTick</span>(callback);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">SQLite3</span>(client) <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    this.client = client;</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="func">require</span>(<span class="S">'util'</span>).<span class="func">inherits</span>(SQLite3, BaseSQL);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.command = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">query</span>(<span class="S">'run'</span>, <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(arguments));</code><span class="hits">55</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.queryAll = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">query</span>(<span class="S">'all'</span>, <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(arguments));</code><span class="hits">21</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.queryOne = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">query</span>(<span class="S">'get'</span>, <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(arguments));</code><span class="hits">15</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.query = <span class="kwrd">function</span> (method, args) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> time = Date.<span class="func">now</span>();</code><span class="hits">91</span></li><li class="covered"><code>    <span class="kwrd">var</span> log = this.log;</code><span class="hits">91</span></li><li class="covered"><code>    <span class="kwrd">var</span> cb = args.<span class="func">pop</span>();</code><span class="hits">91</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> cb === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class=""><code>        args.<span class="func">push</span>(<span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (log) <span class="func">log</span>(args<span class="gly">[</span>0<span class="gly">]</span>, time);</code><span class="hits">91</span></li><li class="covered"><code>            cb.<span class="func">call</span>(this, err, data);</code><span class="hits">91</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">91</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        args.<span class="func">push</span>(cb);</code></li><li class=""><code>        args.<span class="func">push</span>(<span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">log</span>(args<span class="gly">[</span>0<span class="gly">]</span>, time);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    this.client<span class="gly">[</span>method<span class="gly">]</span>.<span class="func">apply</span>(this.client, args);</code><span class="hits">91</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.save = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> queryParams = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">5</span></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'UPDATE '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' SET '</span> +</code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">map</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        queryParams.<span class="func">push</span>(data<span class="gly">[</span>key<span class="gly">]</span>);</code><span class="hits">23</span></li><li class="covered"><code>        <span class="kwrd">return</span> key + <span class="S">' = ?'</span>;</code><span class="hits">23</span></li><li class="covered"><code>    <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">' WHERE id = '</span> + data.id;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">command</span>(sql, queryParams, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Must invoke callback(err, id)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>SQLite3.prototype.create = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    data = data <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">38</span></li><li class="covered"><code>    <span class="kwrd">var</span> questions = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">38</span></li><li class=""><code>    <span class="kwrd">var</span> values = Object.<span class="func">keys</span>(data).<span class="func">map</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        questions.<span class="func">push</span>(<span class="S">'?'</span>);</code><span class="hits">252</span></li><li class="covered"><code>        <span class="kwrd">return</span> data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">252</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">38</span></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'INSERT INTO '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' ('</span> + Object.<span class="func">keys</span>(data).jo<span class="kwrd">in</span>(<span class="S">','</span>) + <span class="S">') VALUES ('</span></code></li><li class="covered"><code>    sql += questions.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code><span class="hits">38</span></li><li class="covered"><code>    sql += <span class="S">')'</span>;</code><span class="hits">38</span></li><li class=""><code>    this.<span class="func">command</span>(sql, values, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, this && this.lastID);</code><span class="hits">38</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">38</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.updateOrCreate = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    data = data <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> questions = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">var</span> values = Object.<span class="func">keys</span>(data).<span class="func">map</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        questions.<span class="func">push</span>(<span class="S">'?'</span>);</code><span class="hits">12</span></li><li class="covered"><code>        <span class="kwrd">return</span> data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">12</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'INSERT OR REPLACE INTO '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' ('</span> + Object.<span class="func">keys</span>(data).jo<span class="kwrd">in</span>(<span class="S">','</span>) + <span class="S">') VALUES ('</span></code></li><li class="covered"><code>    sql += questions.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">')'</span>;</code><span class="hits">2</span></li><li class=""><code>    this.<span class="func">command</span>(sql, values, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!err && this) <span class="gly">{</span></code></li><li class="covered"><code>            data.id = this.lastID;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.toFields = <span class="kwrd">function</span> (model, data) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> fields = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            fields.<span class="func">push</span>(<span class="S">'`'</span> + key.<span class="func">replace</span>(<span class="R">/\./g</span>, <span class="S">'`.`'</span>) + <span class="S">'` = '</span> + this.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> fields.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">dateToMysql</span>(val) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">return</span> val.<span class="func">getUTCFullYear</span>() + <span class="S">'-'</span> +</code></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCMonth</span>() + 1) + <span class="S">'-'</span> +</code></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCDate</span>()) + <span class="S">' '</span> +</code></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCHours</span>()) + <span class="S">':'</span> +</code></li><li class=""><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCMinutes</span>()) + <span class="S">':'</span> +</code></li><li class="uncovered"><code>        <span class="func">fillZeros</span>(val.<span class="func">getUTCSeconds</span>());</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">fillZeros</span>(v) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> v < 10 ? <span class="S">'0'</span> + v : v;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.toDatabase = <span class="kwrd">function</span> (prop, val) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!prop) <span class="kwrd">return</span> val;</code><span class="hits">11</span></li><li class="covered"><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Number'</span>) <span class="kwrd">return</span> val;</code><span class="hits">10</span></li><li class="covered"><code>    <span class="kwrd">if</span> (val === null) <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code><span class="hits">10</span></li><li class=""><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (!val) <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">if</span> (!val.toUTCString) <span class="gly">{</span></code></li><li class="uncovered"><code>            val = <span class="kwrd">new</span> <span class="func">Date</span>(val);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> val;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (prop.type.name == <span class="S">"Boolean"</span>) <span class="kwrd">return</span> val ? 1 : 0;</code><span class="hits">8</span></li><li class="covered"><code>    <span class="kwrd">return</span> val.<span class="func">toString</span>();</code><span class="hits">8</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.fromDatabase = <span class="kwrd">function</span> (model, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!data) <span class="kwrd">return</span> null;</code><span class="hits">74</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">74</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> val = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">478</span></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>.type.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                val = <span class="kwrd">new</span> <span class="func">Date</span>(<span class="func">parseInt</span>(val));</code><span class="hits">74</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        data<span class="gly">[</span>key<span class="gly">]</span> = val;</code><span class="hits">478</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">74</span></li><li class="covered"><code>    <span class="kwrd">return</span> data;</code><span class="hits">74</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.escapeName = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'`'</span> + name + <span class="S">'`'</span>;</code><span class="hits">92</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.exists = <span class="kwrd">function</span> (model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT 1 FROM '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE id = '</span> + id + <span class="S">' LIMIT 1'</span>;</code><span class="hits">3</span></li><li class=""><code>    this.<span class="func">queryOne</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">3</span></li><li class="covered"><code>        <span class="func">callback</span>(null, data && data<span class="gly">[</span><span class="S">'1'</span><span class="gly">]</span> === 1);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.find = <span class="kwrd">function</span> <span class="func">find</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT * FROM '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE id = '</span> + id + <span class="S">' LIMIT 1'</span>;</code><span class="hits">9</span></li><li class=""><code>    this.<span class="func">queryOne</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (data) <span class="gly">{</span></code></li><li class="covered"><code>            data.id = id;</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            data = null;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, this.<span class="func">fromDatabase</span>(model, data));</code><span class="hits">9</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">9</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT * FROM '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">21</span></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">21</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">21</span></li><li class="covered"><code>    <span class="kwrd">var</span> queryParams = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class="covered"><code>            sql += <span class="S">' '</span> + <span class="func">buildWhere</span>(filter.where);</code><span class="hits">16</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="covered"><code>            sql += <span class="S">' '</span> + <span class="func">buildOrderBy</span>(filter.order);</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.limit) <span class="gly">{</span></code></li><li class="covered"><code>            sql += <span class="S">' '</span> + <span class="func">buildLimit</span>(filter.limit, filter.offset <span class="gly">|</span><span class="gly">|</span> 0);</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">queryAll</span>(sql, queryParams, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="func">callback</span>(null, data.<span class="func">map</span>(<span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> self.<span class="func">fromDatabase</span>(model, obj);</code><span class="hits">66</span></li><li class="covered"><code>        <span class="gly">}</span>));</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">21</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> sql;</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildWhere</span>(conds) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> cs = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">16</span></li><li class=""><code>        Object.<span class="func">keys</span>(conds).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> keyEscaped = <span class="S">'`'</span> + key.<span class="func">replace</span>(<span class="R">/\./g</span>, <span class="S">'`.`'</span>) + <span class="S">'`'</span></code></li><li class=""><code>            <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span> === null) <span class="gly">{</span></code></li><li class="covered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' IS NULL'</span>);</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span>.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> condType = Object.<span class="func">keys</span>(conds<span class="gly">[</span>key<span class="gly">]</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">5</span></li><li class="covered"><code>                <span class="kwrd">var</span> sqlCond = keyEscaped;</code><span class="hits">5</span></li><li class=""><code>                <span class="kwrd">switch</span> (condType) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'gt'</span>:</code></li><li class="covered"><code>                    sqlCond += <span class="S">' > '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                    <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'gte'</span>:</code></li><li class="covered"><code>                    sqlCond += <span class="S">' >= '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                    <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'lt'</span>:</code></li><li class="covered"><code>                    sqlCond += <span class="S">' < '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                    <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'lte'</span>:</code></li><li class="covered"><code>                    sqlCond += <span class="S">' <= '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                    <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="kwrd">case</span> <span class="S">'between'</span>:</code></li><li class="covered"><code>                    sqlCond += <span class="S">' BETWEEN ? AND ?'</span>;</code><span class="hits">1</span></li><li class="covered"><code>                    queryParams.<span class="func">push</span>(conds<span class="gly">[</span>key<span class="gly">]</span><span class="gly">[</span>condType<span class="gly">]</span><span class="gly">[</span>0<span class="gly">]</span>);</code><span class="hits">1</span></li><li class="covered"><code>                    queryParams.<span class="func">push</span>(conds<span class="gly">[</span>key<span class="gly">]</span><span class="gly">[</span>condType<span class="gly">]</span><span class="gly">[</span>1<span class="gly">]</span>);</code><span class="hits">1</span></li><li class="covered"><code>                    <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>                <span class="kwrd">if</span> (condType !== <span class="S">'between'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    sqlCond += <span class="S">'?'</span>;</code><span class="hits">4</span></li><li class="covered"><code>                    queryParams.<span class="func">push</span>(conds<span class="gly">[</span>key<span class="gly">]</span><span class="gly">[</span>condType<span class="gly">]</span>);</code><span class="hits">4</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                cs.<span class="func">push</span>(sqlCond);</code><span class="hits">5</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' = ?'</span>);</code><span class="hits">10</span></li><li class="covered"><code>                queryParams.<span class="func">push</span>(self.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, conds<span class="gly">[</span>key<span class="gly">]</span>));</code><span class="hits">10</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">16</span></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'WHERE '</span> + cs.jo<span class="kwrd">in</span>(<span class="S">' AND '</span>);</code><span class="hits">16</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildOrderBy</span>(order) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> order === <span class="S">'string'</span>) order = <span class="gly">[</span>order<span class="gly">]</span>;</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'ORDER BY '</span> + order.jo<span class="kwrd">in</span>(<span class="S">', '</span>);</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildLimit</span>(limit, offset) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'LIMIT '</span> + (offset ? (offset + <span class="S">', '</span> + limit) : limit);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> queryParams = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">queryOne</span>(<span class="S">'SELECT count(*) as cnt FROM '</span> +</code></li><li class=""><code>        this.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span> + <span class="func">buildWhere</span>(where), queryParams, <span class="kwrd">function</span> (err, res) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">3</span></li><li class="covered"><code>        <span class="func">callback</span>(err, err ? null : res.cnt);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildWhere</span>(conds) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> cs = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code>        Object.<span class="func">keys</span>(conds <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> keyEscaped = <span class="S">'`'</span> + key.<span class="func">replace</span>(<span class="R">/\./g</span>, <span class="S">'`.`'</span>) + <span class="S">'`'</span></code></li><li class=""><code>            <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span> === null) <span class="gly">{</span></code></li><li class="uncovered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' IS NULL'</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' = ?'</span>);</code><span class="hits">1</span></li><li class="covered"><code>                queryParams.<span class="func">push</span>(self.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, conds<span class="gly">[</span>key<span class="gly">]</span>));</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>        <span class="kwrd">return</span> cs.length ? <span class="S">' WHERE '</span> + cs.jo<span class="kwrd">in</span>(<span class="S">' AND '</span>) : <span class="S">''</span>;</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.disconnect = <span class="kwrd">function</span> <span class="func">disconnect</span>() <span class="gly">{</span></code></li><li class="covered"><code>    this.client.<span class="func">close</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.autoupdate = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> wait = 0;</code></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="uncovered"><code>        wait += 1;</code></li><li class=""><code>        self.<span class="func">queryAll</span>(<span class="S">'SHOW FIELDS FROM '</span> + this.<span class="func">tableEscaped</span>(model), <span class="kwrd">function</span> (err, fields) <span class="gly">{</span></code></li><li class="uncovered"><code>            self.<span class="func">alterTable</span>(model, fields, done);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 && cb) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">cb</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.alterTable = <span class="kwrd">function</span> (model, actualFields, done) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> m = this._models<span class="gly">[</span>model<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> propNames = Object.<span class="func">keys</span>(m.properties);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// change/add new fields</span></code></li><li class=""><code>    propNames.<span class="func">forEach</span>(<span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> found;</code></li><li class=""><code>        actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span> (f) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (f.Field === propName) <span class="gly">{</span></code></li><li class="uncovered"><code>                found = f;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (found) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">actualize</span>(propName, found);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            sql.<span class="func">push</span>(<span class="S">'ADD COLUMN `'</span> + propName + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// drop columns</span></code></li><li class=""><code>    actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span> (f) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> notFound = !~propNames.<span class="func">indexOf</span>(f.Field);</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (f.Field === <span class="S">'id'</span>) <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (notFound <span class="gly">|</span><span class="gly">|</span> !m.properties<span class="gly">[</span>f.Field<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql.<span class="func">push</span>(<span class="S">'DROP COLUMN `'</span> + f.Field + <span class="S">'`'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (sql.length) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.<span class="func">command</span>(<span class="S">'ALTER TABLE '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span> + sql.jo<span class="kwrd">in</span>(<span class="S">',\n'</span>), done);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">done</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">actualize</span>(propName, oldSettings) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> newSettings = m.properties<span class="gly">[</span>propName<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (newSettings && <span class="func">changed</span>(newSettings, oldSettings)) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql.<span class="func">push</span>(<span class="S">'CHANGE COLUMN `'</span> + propName + <span class="S">'` `'</span> + propName + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">changed</span>(newSettings, oldSettings) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'YES'</span> && (newSettings.allowNull === false <span class="gly">|</span><span class="gly">|</span> newSettings.null === false)) <span class="kwrd">return</span> true;</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'NO'</span> && !(newSettings.allowNull === false <span class="gly">|</span><span class="gly">|</span> newSettings.null === false)) <span class="kwrd">return</span> true;</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (oldSettings.Type.toUpper<span class="kwrd">Case</span>() !== <span class="func">datatype</span>(newSettings)) <span class="kwrd">return</span> true;</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> false;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.propertiesSQL = <span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="S">'`id` INTEGER PRIMARY KEY'</span><span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models<span class="gly">[</span>model<span class="gly">]</span>.properties).<span class="func">forEach</span>(<span class="kwrd">function</span> (prop) <span class="gly">{</span></code></li><li class="covered"><code>        sql.<span class="func">push</span>(<span class="S">'`'</span> + prop + <span class="S">'` '</span> + self.<span class="func">propertySettingsSQL</span>(model, prop));</code><span class="hits">14</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">return</span> sql.jo<span class="kwrd">in</span>(<span class="S">',\n  '</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>SQLite3.prototype.propertySettingsSQL = <span class="kwrd">function</span> (model, prop) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> p = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span>;</code><span class="hits">14</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="func">datatype</span>(p) + <span class="S">' '</span> +</code><span class="hits">14</span></li><li class="uncovered"><code>    (p.allowNull === false <span class="gly">|</span><span class="gly">|</span> p<span class="gly">[</span><span class="S">'null'</span><span class="gly">]</span> === false ? <span class="S">'NOT NULL'</span> : <span class="S">'NULL'</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">datatype</span>(p) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">switch</span> (p.type.name) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'String'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'VARCHAR('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 255) + <span class="S">')'</span>;</code><span class="hits">5</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Text'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'TEXT'</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Number'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'INT(11)'</span>;</code><span class="hits">3</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Date'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'DATETIME'</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Boolean'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'TINYINT(1)'</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-postgres-js" class="filename" name="lib-adapters-postgres-js" onclick="var el = document.getElementById('lib-adapters-postgres-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/postgres.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 73%"><strong>73%</strong> [181/404]</div></div></div></div><div id="lib-adapters-postgres-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> pg = <span class="func">safeRequire</span>(<span class="S">'pg'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> BaseSQL = <span class="func">require</span>(<span class="S">'../sql'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!pg) <span class="kwrd">return</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> Client = pg.Client;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> s = schema.settings;</code><span class="hits">1</span></li><li class=""><code>    schema.client = <span class="kwrd">new</span> <span class="func">Client</span>(s.url ? s.url : <span class="gly">{</span></code></li><li class=""><code>        host: s.host <span class="gly">|</span><span class="gly">|</span> <span class="S">'localhost'</span>,</code></li><li class=""><code>        port: s.port <span class="gly">|</span><span class="gly">|</span> 5432,</code></li><li class=""><code>        user: s.username,</code></li><li class=""><code>        password: s.password,</code></li><li class=""><code>        database: s.database,</code></li><li class=""><code>        debug: s.debug</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">PG</span>(schema.client);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    schema.adapter.<span class="func">connect</span>(callback);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">PG</span>(client) <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    this.client = client;</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="func">require</span>(<span class="S">'util'</span>).<span class="func">inherits</span>(PG, BaseSQL);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.connect = <span class="kwrd">function</span> (callback) <span class="gly">{</span></code></li><li class=""><code>    this.client.<span class="func">connect</span>(<span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!err)<span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>();</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span>else<span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">error</span>(err);</code></li><li class="uncovered"><code>            throw err;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.query = <span class="kwrd">function</span> (sql, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> time = Date.<span class="func">now</span>();</code><span class="hits">91</span></li><li class="covered"><code>    <span class="kwrd">var</span> log = this.log;</code><span class="hits">91</span></li><li class=""><code>    this.client.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (log) <span class="func">log</span>(sql, time);</code><span class="hits">91</span></li><li class="covered"><code>        <span class="func">callback</span>(err, data ? data.rows : null);</code><span class="hits">91</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">91</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Must invoke callback(err, id)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>PG.prototype.create = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> fields = this.<span class="func">toFields</span>(model, data, true);</code><span class="hits">38</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'INSERT INTO '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">''</span>;</code><span class="hits">38</span></li><li class=""><code>    <span class="kwrd">if</span> (fields) <span class="gly">{</span></code></li><li class="covered"><code>        sql += <span class="S">' '</span> + fields;</code><span class="hits">38</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        sql += <span class="S">' VALUES ()'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    sql += <span class="S">' RETURNING id'</span>;</code><span class="hits">38</span></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, info) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">38</span></li><li class="covered"><code>        <span class="func">callback</span>(err, info && info<span class="gly">[</span>0<span class="gly">]</span> && info<span class="gly">[</span>0<span class="gly">]</span>.id);</code><span class="hits">38</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">38</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.updateOrCreate = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> pg = this;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> fieldsNames = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> fieldValues = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> combined = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">2</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> key === <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> k = <span class="S">'"'</span> + key + <span class="S">'"'</span>;</code><span class="hits">12</span></li><li class="covered"><code>            <span class="kwrd">var</span> v;</code><span class="hits">12</span></li><li class=""><code>            <span class="kwrd">if</span> (key !== <span class="S">'id'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                v = pg.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>);</code><span class="hits">10</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                v = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            fieldsNames.<span class="func">push</span>(k);</code><span class="hits">12</span></li><li class="covered"><code>            fieldValues.<span class="func">push</span>(v);</code><span class="hits">12</span></li><li class="covered"><code>            <span class="kwrd">if</span> (key !== <span class="S">'id'</span>) combined.<span class="func">push</span>(k + <span class="S">' = '</span> + v);</code><span class="hits">12</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'UPDATE '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">' SET '</span> + combined + <span class="S">' WHERE id = '</span> + data.id + <span class="S">';'</span>;</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">' INSERT INTO '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">' ('</span> + fieldsNames.jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">')'</span>;</code><span class="hits">2</span></li><li class=""><code>    sql += <span class="S">' SELECT '</span> + fieldValues.jo<span class="kwrd">in</span>(<span class="S">', '</span>)</code></li><li class="covered"><code>    sql += <span class="S">' WHERE NOT EXISTS (SELECT 1 FROM '</span> + this.<span class="func">tableEscaped</span>(model);</code><span class="hits">2</span></li><li class="covered"><code>    sql += <span class="S">' WHERE id = '</span> + data.id + <span class="S">') RETURNING id'</span>;</code><span class="hits">2</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, info) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!err && info && info<span class="gly">[</span>0<span class="gly">]</span> && info<span class="gly">[</span>0<span class="gly">]</span>.id) <span class="gly">{</span></code></li><li class="covered"><code>            data.id = info<span class="gly">[</span>0<span class="gly">]</span>.id;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.toFields = <span class="kwrd">function</span> (model, data, forCreate) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> fields = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">43</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">43</span></li><li class=""><code>    </code></li><li class=""><code>    <span class="kwrd">if</span>(forCreate)<span class="gly">{</span></code></li><li class="covered"><code>      <span class="kwrd">var</span> columns = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">38</span></li><li class=""><code>      Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>          <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>              columns.<span class="func">push</span>(<span class="S">'"'</span> + key + <span class="S">'"'</span>);</code><span class="hits">214</span></li><li class="covered"><code>              fields.<span class="func">push</span>(this.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>));</code><span class="hits">214</span></li><li class=""><code>          <span class="gly">}</span></code></li><li class="covered"><code>      <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">38</span></li><li class="covered"><code>      <span class="kwrd">return</span> <span class="S">'('</span> + columns.jo<span class="kwrd">in</span>(<span class="S">','</span>) + <span class="S">') VALUES ('</span>+fields.jo<span class="kwrd">in</span>(<span class="S">','</span>)+<span class="S">')'</span>;</code><span class="hits">38</span></li><li class=""><code>    <span class="gly">}</span>else<span class="gly">{</span></code></li><li class=""><code>      Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>          <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>              fields.<span class="func">push</span>(<span class="S">'"'</span> + key + <span class="S">'" = '</span> + this.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, data<span class="gly">[</span>key<span class="gly">]</span>));</code><span class="hits">18</span></li><li class=""><code>          <span class="gly">}</span></code></li><li class="covered"><code>      <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">5</span></li><li class="covered"><code>      <span class="kwrd">return</span> fields.jo<span class="kwrd">in</span>(<span class="S">','</span>);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">dateToPostgres</span>(val) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="gly">[</span></code><span class="hits">39</span></li><li class=""><code>        val.<span class="func">getUTCFullYear</span>(),</code></li><li class=""><code>        <span class="func">fz</span>(val.<span class="func">getUTCMonth</span>() + 1),</code></li><li class=""><code>        <span class="func">fz</span>(val.<span class="func">getUTCDate</span>())</code></li><li class=""><code>    <span class="gly">]</span>.jo<span class="kwrd">in</span>(<span class="S">'-'</span>) + <span class="S">' '</span> + <span class="gly">[</span></code></li><li class=""><code>        <span class="func">fz</span>(val.<span class="func">getUTCHours</span>()),</code></li><li class=""><code>        <span class="func">fz</span>(val.<span class="func">getUTCMinutes</span>()),</code></li><li class=""><code>        <span class="func">fz</span>(val.<span class="func">getUTCSeconds</span>())</code></li><li class="uncovered"><code>    <span class="gly">]</span>.jo<span class="kwrd">in</span>(<span class="S">':'</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">fz</span>(v) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> v < 10 ? <span class="S">'0'</span> + v : v;</code><span class="hits">195</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>PG.prototype.toDatabase = <span class="kwrd">function</span> (prop, val) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (val === null) <span class="gly">{</span></code></li><li class=""><code>		<span class="C">// Postgres complains with NULLs in not null columns</span></code></li><li class=""><code>		<span class="C">// If we have an autoincrement value, return DEFAULT instead</span></code></li><li class=""><code>        <span class="kwrd">if</span>( prop.autoIncrement ) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="S">'DEFAULT'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code><span class="hits">141</span></li><li class=""><code>	    <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (val.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> operator = Object.<span class="func">keys</span>(val)<span class="gly">[</span>0<span class="gly">]</span></code></li><li class="covered"><code>        val = val<span class="gly">[</span>operator<span class="gly">]</span>;</code><span class="hits">5</span></li><li class=""><code>        <span class="kwrd">if</span> (operator === <span class="S">'between'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>0<span class="gly">]</span>) + <span class="S">' AND '</span> + this.<span class="func">toDatabase</span>(prop, val<span class="gly">[</span>1<span class="gly">]</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Number'</span>) <span class="kwrd">return</span> val;</code><span class="hits">117</span></li><li class=""><code>    <span class="kwrd">if</span> (prop.type.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!val) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span>( prop.autoIncrement ) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="S">'DEFAULT'</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!val.toUTCString) <span class="gly">{</span></code></li><li class="covered"><code>            val = <span class="kwrd">new</span> <span class="func">Date</span>(val);</code><span class="hits">14</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">escape</span>(<span class="func">dateToPostgres</span>(val));</code><span class="hits">39</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="func">escape</span>(val.<span class="func">toString</span>());</code><span class="hits">78</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.fromDatabase = <span class="kwrd">function</span> (model, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!data) <span class="kwrd">return</span> null;</code><span class="hits">8</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">8</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> val = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">52</span></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// if (props[key])</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        data<span class="gly">[</span>key<span class="gly">]</span> = val;</code><span class="hits">52</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">8</span></li><li class="covered"><code>    <span class="kwrd">return</span> data;</code><span class="hits">8</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.escapeName = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'"'</span> + name.<span class="func">replace</span>(<span class="R">/\./g</span>, <span class="S">'"."'</span>) + <span class="S">'"'</span>;</code><span class="hits">114</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">query</span>(<span class="S">'SELECT * FROM '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span> + this.<span class="func">toFilter</span>(model, filter), <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">21</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.toFilter = <span class="kwrd">function</span> (model, filter) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter && <span class="kwrd">typeof</span> filter.where === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>      <span class="kwrd">return</span> <span class="func">filter</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!filter) <span class="kwrd">return</span> <span class="S">''</span>;</code><span class="hits">19</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">19</span></li><li class="covered"><code>    <span class="kwrd">var</span> out = <span class="S">''</span>;</code><span class="hits">19</span></li><li class=""><code>    <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> fields = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">16</span></li><li class="covered"><code>        <span class="kwrd">var</span> conds = filter.where;</code><span class="hits">16</span></li><li class=""><code>        Object.<span class="func">keys</span>(conds).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (filter.where<span class="gly">[</span>key<span class="gly">]</span> && filter.where<span class="gly">[</span>key<span class="gly">]</span>.constructor.name === <span class="S">'RegExp'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> filterValue = this.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, filter.where<span class="gly">[</span>key<span class="gly">]</span>);</code><span class="hits">16</span></li><li class=""><code>                <span class="kwrd">if</span> (filterValue === <span class="S">'NULL'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    fields.<span class="func">push</span>(<span class="S">'"'</span> + key + <span class="S">'" IS '</span> + filterValue);</code><span class="hits">1</span></li><li class=""><code>                <span class="gly">}</span> else <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span>.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">var</span> condType = Object.<span class="func">keys</span>(conds<span class="gly">[</span>key<span class="gly">]</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">5</span></li><li class="covered"><code>                    <span class="kwrd">var</span> sqlCond = key;</code><span class="hits">5</span></li><li class=""><code>                    <span class="kwrd">switch</span> (condType) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">case</span> <span class="S">'gt'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' > '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                        <span class="kwrd">case</span> <span class="S">'gte'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' >= '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                        <span class="kwrd">case</span> <span class="S">'lt'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' < '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                        <span class="kwrd">case</span> <span class="S">'lte'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' <= '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                        <span class="kwrd">case</span> <span class="S">'between'</span>:</code></li><li class="covered"><code>                        sqlCond += <span class="S">' BETWEEN '</span>;</code><span class="hits">1</span></li><li class="covered"><code>                        <span class="kwrd">break</span>;</code><span class="hits">1</span></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="covered"><code>                    sqlCond += filterValue;</code><span class="hits">5</span></li><li class="covered"><code>                    fields.<span class="func">push</span>(sqlCond);</code><span class="hits">5</span></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    fields.<span class="func">push</span>(<span class="S">'"'</span> + key + <span class="S">'" = '</span> + filterValue);</code><span class="hits">10</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">16</span></li><li class=""><code>        <span class="kwrd">if</span> (fields.length) <span class="gly">{</span></code></li><li class="covered"><code>            out += <span class="S">' WHERE '</span> + fields.jo<span class="kwrd">in</span>(<span class="S">' AND '</span>);</code><span class="hits">16</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="covered"><code>        out += <span class="S">' ORDER BY '</span> + filter.order;</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.limit) <span class="gly">{</span></code></li><li class="covered"><code>        out += <span class="S">' LIMIT '</span> + filter.limit + <span class="S">' '</span> + (filter.offset <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> out;</code><span class="hits">19</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.autoupdate = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> wait = 0;</code></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="uncovered"><code>        wait += 1;</code></li><li class=""><code>        self.<span class="func">query</span>(<span class="S">'SELECT column_name as Field, udt_name as Type, is_nullable as Null, column_default as Default FROM information_schema.COLUMNS WHERE table_name = \''</span>+ self.<span class="func">table</span>(model) + <span class="S">'\''</span>, <span class="kwrd">function</span> (err, fields) <span class="gly">{</span></code></li><li class="uncovered"><code>            self.<span class="func">alterTable</span>(model, fields, done);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 && cb) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">cb</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.alterTable = <span class="kwrd">function</span> (model, actualFields, done) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> m = this._models<span class="gly">[</span>model<span class="gly">]</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> propNames = Object.<span class="func">keys</span>(m.properties);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// change/add new fields</span></code></li><li class=""><code>    propNames.<span class="func">forEach</span>(<span class="kwrd">function</span> (propName) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> found;</code></li><li class=""><code>        actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span> (f) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (f.Field === propName) <span class="gly">{</span></code></li><li class="uncovered"><code>                found = f;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (found) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">actualize</span>(propName, found);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            sql.<span class="func">push</span>(<span class="S">'ADD COLUMN "'</span> + propName + <span class="S">'" '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// drop columns</span></code></li><li class=""><code>    actualFields.<span class="func">forEach</span>(<span class="kwrd">function</span> (f) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> notFound = !~propNames.<span class="func">indexOf</span>(f.Field);</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (f.Field === <span class="S">'id'</span>) <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (notFound <span class="gly">|</span><span class="gly">|</span> !m.properties<span class="gly">[</span>f.Field<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql.<span class="func">push</span>(<span class="S">'DROP COLUMN "'</span> + f.Field + <span class="S">'"'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (sql.length) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.<span class="func">query</span>(<span class="S">'ALTER TABLE '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span> + sql.jo<span class="kwrd">in</span>(<span class="S">',\n'</span>), done);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">done</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">actualize</span>(propName, oldSettings) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> newSettings = m.properties<span class="gly">[</span>propName<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (newSettings && <span class="func">changed</span>(newSettings, oldSettings)) <span class="gly">{</span></code></li><li class="uncovered"><code>            sql.<span class="func">push</span>(<span class="S">'CHANGE COLUMN "'</span> + propName + <span class="S">'" "'</span> + propName + <span class="S">'" '</span> + self.<span class="func">propertySettingsSQL</span>(model, propName));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">changed</span>(newSettings, oldSettings) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'YES'</span> && (newSettings.allowNull === false <span class="gly">|</span><span class="gly">|</span> newSettings.null === false)) <span class="kwrd">return</span> true;</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (oldSettings.Null === <span class="S">'NO'</span> && !(newSettings.allowNull === false <span class="gly">|</span><span class="gly">|</span> newSettings.null === false)) <span class="kwrd">return</span> true;</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (oldSettings.Type.toUpper<span class="kwrd">Case</span>() !== <span class="func">datatype</span>(newSettings)) <span class="kwrd">return</span> true;</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> false;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.propertiesSQL = <span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="gly">[</span><span class="S">'"id" SERIAL NOT NULL UNIQUE PRIMARY KEY'</span><span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models<span class="gly">[</span>model<span class="gly">]</span>.properties).<span class="func">forEach</span>(<span class="kwrd">function</span> (prop) <span class="gly">{</span></code></li><li class="covered"><code>        sql.<span class="func">push</span>(<span class="S">'"'</span> + prop + <span class="S">'" '</span> + self.<span class="func">propertySettingsSQL</span>(model, prop));</code><span class="hits">14</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="kwrd">return</span> sql.jo<span class="kwrd">in</span>(<span class="S">',\n  '</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>PG.prototype.propertySettingsSQL = <span class="kwrd">function</span> (model, prop) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> p = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span>;</code><span class="hits">14</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="func">datatype</span>(p) + <span class="S">' '</span> +</code><span class="hits">14</span></li><li class="uncovered"><code>    (p.allowNull === false <span class="gly">|</span><span class="gly">|</span> p<span class="gly">[</span><span class="S">'null'</span><span class="gly">]</span> === false ? <span class="S">'NOT NULL'</span> : <span class="S">'NULL'</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">escape</span>(val) <span class="gly">{</span></code></li><li class=""><code>  <span class="kwrd">if</span> (val === undefined <span class="gly">|</span><span class="gly">|</span> val === null) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="S">'NULL'</span>;</code></li><li class=""><code>  <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>  <span class="kwrd">switch</span> (<span class="kwrd">typeof</span> val) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">case</span> <span class="S">'boolean'</span>: <span class="kwrd">return</span> (val) ? <span class="S">'true'</span> : <span class="S">'false'</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">case</span> <span class="S">'number'</span>: <span class="kwrd">return</span> val+<span class="S">''</span>;</code></li><li class=""><code>  <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>  <span class="kwrd">if</span> (<span class="kwrd">typeof</span> val === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class=""><code>    val = (<span class="kwrd">typeof</span> val.toISOString === <span class="S">'function'</span>)</code></li><li class=""><code>      ? val.<span class="func">toISOString</span>()</code></li><li class="uncovered"><code>      : val.<span class="func">toString</span>();</code></li><li class=""><code>  <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>  val = val.<span class="func">replace</span>(<span class="R">/[\0\n\r\b\t\\\'\"\x1a]/g</span>, <span class="kwrd">function</span>(s) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">switch</span>(s) <span class="gly">{</span></code></li><li class="uncovered"><code>      <span class="kwrd">case</span> <span class="S">"\0"</span>: <span class="kwrd">return</span> <span class="S">"\\0"</span>;</code></li><li class="uncovered"><code>      <span class="kwrd">case</span> <span class="S">"\n"</span>: <span class="kwrd">return</span> <span class="S">"\\n"</span>;</code></li><li class="uncovered"><code>      <span class="kwrd">case</span> <span class="S">"\r"</span>: <span class="kwrd">return</span> <span class="S">"\\r"</span>;</code></li><li class="uncovered"><code>      <span class="kwrd">case</span> <span class="S">"\b"</span>: <span class="kwrd">return</span> <span class="S">"\\b"</span>;</code></li><li class="uncovered"><code>      <span class="kwrd">case</span> <span class="S">"\t"</span>: <span class="kwrd">return</span> <span class="S">"\\t"</span>;</code></li><li class="uncovered"><code>      <span class="kwrd">case</span> <span class="S">"\x1a"</span>: <span class="kwrd">return</span> <span class="S">"\\Z"</span>;</code></li><li class=""><code>      default: <span class="kwrd">return</span> <span class="S">"\\"+s;</span></code></li><li class=""><code><span class="S">    }</span></code></li><li class="covered"><code><span class="S">  });</span></code><span class="hits">117</span></li><li class="covered"><code><span class="S">  return "</span>'<span class="S">"+val+"</span>'";</code><span class="hits">117</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">datatype</span>(p) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">switch</span> (p.type.name) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'String'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'VARCHAR('</span> + (p.limit <span class="gly">|</span><span class="gly">|</span> 255) + <span class="S">')'</span>;</code><span class="hits">5</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Text'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'TEXT'</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Number'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'INTEGER'</span>;</code><span class="hits">3</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Date'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'TIMESTAMP'</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'Boolean'</span>:</code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="S">'BOOLEAN'</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-neo-j-js" class="filename" name="lib-adapters-neo-j-js" onclick="var el = document.getElementById('lib-adapters-neo-j-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/neo4j.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 77%"><strong>77%</strong> [180/367]</div></div></div></div><div id="lib-adapters-neo-j-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> neo4j = <span class="func">safeRequire</span>(<span class="S">'neo4j'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    schema.client = <span class="kwrd">new</span> neo4j.<span class="func">GraphDatabase</span>(schema.settings.url);</code><span class="hits">1</span></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">Neo4j</span>(schema.client);</code><span class="hits">1</span></li><li class="covered"><code>    process.<span class="func">nextTick</span>(callback);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Neo4j</span>(client) <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    this.client = client;</code><span class="hits">1</span></li><li class="covered"><code>    this.cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.define = <span class="kwrd">function</span> <span class="func">defineModel</span>(descr) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">mixClassMethods</span>(descr.model, descr.properties);</code><span class="hits">3</span></li><li class="covered"><code>    this.<span class="func">mixInstanceMethods</span>(descr.model.prototype, descr.properties);</code><span class="hits">3</span></li><li class="covered"><code>    this._models<span class="gly">[</span>descr.model.modelName<span class="gly">]</span> = descr;</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.createIndexHelper = <span class="kwrd">function</span> (cls, indexName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> db = this.client;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> method = <span class="S">'findBy'</span> + indexName<span class="gly">[</span>0<span class="gly">]</span>.toUpper<span class="kwrd">Case</span>() + indexName.<span class="func">substr</span>(1);</code><span class="hits">4</span></li><li class=""><code>    cls<span class="gly">[</span>method<span class="gly">]</span> = <span class="kwrd">function</span> (value, cb) <span class="gly">{</span></code></li><li class=""><code>        db.<span class="func">getIndexedNode</span>(cls.modelName, indexName, value, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code><span class="hits">1</span></li><li class=""><code>            <span class="kwrd">if</span> (node) <span class="gly">{</span></code></li><li class="covered"><code>                node.data.id = node.id;</code><span class="hits">1</span></li><li class="covered"><code>                <span class="func">cb</span>(null, <span class="kwrd">new</span> <span class="func">cls</span>(node.data));</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">cb</span>(null, null);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.mixClassMethods = <span class="kwrd">function</span> <span class="func">mixClassMethods</span>(cls, properties) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> neo = this;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">keys</span>(properties).<span class="func">forEach</span>(<span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (properties<span class="gly">[</span>name<span class="gly">]</span>.index) <span class="gly">{</span></code></li><li class="covered"><code>            neo.<span class="func">createIndexHelper</span>(cls, name);</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    cls.setupCypherQuery = <span class="kwrd">function</span> (name, queryStr, rowHandler) <span class="gly">{</span></code></li><li class=""><code>        cls<span class="gly">[</span>name<span class="gly">]</span> = <span class="kwrd">function</span> <span class="func">cypherQuery</span>(params, cb) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                cb = params;</code></li><li class="uncovered"><code>                params = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (params.constructor.name !== <span class="S">'Array'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                params = <span class="gly">[</span>params<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> i = 0;</code></li><li class=""><code>            <span class="kwrd">var</span> q = queryStr.<span class="func">replace</span>(<span class="R">/\?/g</span>, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> params<span class="gly">[</span>i++<span class="gly">]</span>;</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>            neo.client.<span class="func">query</span>(<span class="kwrd">function</span> (err, result) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">cb</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class="uncovered"><code>                <span class="func">cb</span>(null, result.<span class="func">map</span>(rowHandler));</code></li><li class="uncovered"><code>            <span class="gly">}</span>, q);</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * @param from - id of object to check relation from</span></code></li><li class=""><code><span class="C">     * @param to - id of object to check relation to</span></code></li><li class=""><code><span class="C">     * @param type - type of relation</span></code></li><li class=""><code><span class="C">     * @param direction - all | incoming | outgoing</span></code></li><li class=""><code><span class="C">     * @param cb - callback (err, rel || false)</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    cls.relationshipExists = <span class="kwrd">function</span> <span class="func">relationshipExists</span>(from, to, type, direction, cb) <span class="gly">{</span></code></li><li class=""><code>        neo.<span class="func">node</span>(from, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class=""><code>            node.<span class="func">_getRelationships</span>(direction, type, <span class="kwrd">function</span> (err, rels) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">if</span> (err && cb) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class="uncovered"><code>                <span class="kwrd">if</span> (err && !cb) throw err;</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> found = false;</code></li><li class=""><code>                <span class="kwrd">if</span> (rels && rels.forEach) <span class="gly">{</span></code></li><li class=""><code>                    rels.<span class="func">forEach</span>(<span class="kwrd">function</span> (r) <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (r.start.id === from && r.end.id === to) <span class="gly">{</span></code></li><li class="uncovered"><code>                            found = true;</code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                cb  && <span class="func">cb</span>(err, found);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    cls.createRelationshipTo = <span class="kwrd">function</span> <span class="func">createRelationshipTo</span>(id1, id2, type, data, cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> fromNode, toNode;</code></li><li class=""><code>        neo.<span class="func">node</span>(id1, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err && cb) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err && !cb) throw err;</code></li><li class="uncovered"><code>            fromNode = node;</code></li><li class="uncovered"><code>            <span class="func">ok</span>();</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>        neo.<span class="func">node</span>(id2, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err && cb) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err && !cb) throw err;</code></li><li class="uncovered"><code>            toNode = node;</code></li><li class="uncovered"><code>            <span class="func">ok</span>();</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">ok</span>() <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (fromNode && toNode) <span class="gly">{</span></code></li><li class="uncovered"><code>                fromNode.<span class="func">createRelationshipTo</span>(toNode, type, <span class="func">cleanup</span>(data), cb);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    cls.createRelationshipFrom = <span class="kwrd">function</span> <span class="func">createRelationshipFrom</span>(id1, id2, type, data, cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        cls.<span class="func">createRelationshipTo</span>(id2, id1, type, data, cb);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// only create relationship if it is not exists</span></code></li><li class=""><code>    cls.ensureRelationshipTo = <span class="kwrd">function</span> (id1, id2, type, data, cb) <span class="gly">{</span></code></li><li class=""><code>        cls.<span class="func">relationshipExists</span>(id1, id2, type, <span class="S">'outgoing'</span>, <span class="kwrd">function</span> (err, exists) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err && cb) <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err && !cb) throw err;</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (exists) <span class="kwrd">return</span> cb && <span class="func">cb</span>(null);</code></li><li class="uncovered"><code>            cls.<span class="func">createRelationshipTo</span>(id1, id2, type, data, cb);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.mixInstanceMethods = <span class="kwrd">function</span> <span class="func">mixInstanceMethods</span>(proto) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> neo = this;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * @param obj - Object or id of object to check relation with</span></code></li><li class=""><code><span class="C">     * @param type - type of relation</span></code></li><li class=""><code><span class="C">     * @param cb - callback (err, rel || false)</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    proto.isInRelationWith = <span class="kwrd">function</span> <span class="func">isInRelationWith</span>(obj, type, direction, cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.constructor.<span class="func">relationshipExists</span>(this.id, obj.id <span class="gly">|</span><span class="gly">|</span> obj, type, <span class="S">'all'</span>, cb);</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.node = <span class="kwrd">function</span> <span class="func">find</span>(id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (this.cache<span class="gly">[</span>id<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(null, this.cache<span class="gly">[</span>id<span class="gly">]</span>);</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        this.client.<span class="func">getNodeById</span>(id, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (node) <span class="gly">{</span></code></li><li class="covered"><code>                this.cache<span class="gly">[</span>id<span class="gly">]</span> = node;</code><span class="hits">8</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            <span class="func">callback</span>(err, node);</code><span class="hits">10</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.create = <span class="kwrd">function</span> <span class="func">create</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    data.nodeType = model;</code><span class="hits">30</span></li><li class="covered"><code>    <span class="kwrd">var</span> node = this.client.<span class="func">createNode</span>();</code><span class="hits">30</span></li><li class="covered"><code>    node.data = <span class="func">cleanup</span>(data);</code><span class="hits">30</span></li><li class="covered"><code>    node.data.nodeType = model;</code><span class="hits">30</span></li><li class=""><code>    node.<span class="func">save</span>(<span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        this.cache<span class="gly">[</span>node.id<span class="gly">]</span> = node;</code><span class="hits">30</span></li><li class=""><code>        node.<span class="func">index</span>(model, <span class="S">'id'</span>, node.id, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">30</span></li><li class=""><code>            this.<span class="func">updateIndexes</span>(model, node, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">30</span></li><li class="covered"><code>                <span class="func">callback</span>(null, node.id);</code><span class="hits">30</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">30</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">30</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">30</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.updateIndexes = <span class="kwrd">function</span> <span class="func">updateIndexes</span>(model, node, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">35</span></li><li class="covered"><code>    <span class="kwrd">var</span> wait = 1;</code><span class="hits">35</span></li><li class=""><code>    Object.<span class="func">keys</span>(props).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>.index && node.data<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            wait += 1;</code><span class="hits">55</span></li><li class="covered"><code>            node.<span class="func">index</span>(model, key, node.data<span class="gly">[</span>key<span class="gly">]</span>, done);</code><span class="hits">55</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">35</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">done</span>();</code><span class="hits">35</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> error = false;</code><span class="hits">35</span></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err) <span class="gly">{</span></code></li><li class="covered"><code>        error = error <span class="gly">|</span><span class="gly">|</span> err;</code><span class="hits">90</span></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>(error);</code><span class="hits">35</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.save = <span class="kwrd">function</span> <span class="func">save</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">5</span></li><li class=""><code>    this.<span class="func">node</span>(data.id, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">5</span></li><li class="covered"><code>        node.data = <span class="func">cleanup</span>(data);</code><span class="hits">5</span></li><li class=""><code>        node.<span class="func">save</span>(<span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">5</span></li><li class=""><code>            self.<span class="func">updateIndexes</span>(model, node, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">if</span> (err) <span class="kwrd">return</span> console.<span class="func">log</span>(err);</code><span class="hits">5</span></li><li class="covered"><code>                <span class="func">callback</span>(null, node.data);</code><span class="hits">5</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.exists = <span class="kwrd">function</span> <span class="func">exists</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    delete this.cache<span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">3</span></li><li class="covered"><code>    this.<span class="func">node</span>(id, callback);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.find = <span class="kwrd">function</span> <span class="func">find</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    delete this.cache<span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">7</span></li><li class=""><code>    this.<span class="func">node</span>(id, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (node && node.data) <span class="gly">{</span></code></li><li class="covered"><code>            node.data.id = id;</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, this.<span class="func">readFromDb</span>(model, node && node.data));</code><span class="hits">7</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">7</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.readFromDb = <span class="kwrd">function</span> <span class="func">readFromDb</span>(model, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!data) <span class="kwrd">return</span> data;</code><span class="hits">166</span></li><li class="covered"><code>    <span class="kwrd">var</span> res = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">166</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">166</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span> && props<span class="gly">[</span>key<span class="gly">]</span>.type.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            res<span class="gly">[</span>key<span class="gly">]</span> = <span class="kwrd">new</span> <span class="func">Date</span>(data<span class="gly">[</span>key<span class="gly">]</span>);</code><span class="hits">142</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            res<span class="gly">[</span>key<span class="gly">]</span> = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">642</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">166</span></li><li class="covered"><code>    <span class="kwrd">return</span> res;</code><span class="hits">166</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> force = true;</code><span class="hits">1</span></li><li class=""><code>    this.<span class="func">node</span>(id, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">1</span></li><li class=""><code>        node.<span class="func">delete</span>(<span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">1</span></li><li class="uncovered"><code>            delete this.cache<span class="gly">[</span>id<span class="gly">]</span>;</code></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this), force);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class=""><code>    this.client.<span class="func">queryNodeIndex</span>(model, <span class="S">'id:*'</span>, <span class="kwrd">function</span> (err, nodes) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (nodes) <span class="gly">{</span></code></li><li class=""><code>            nodes = nodes.<span class="func">map</span>(<span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class="covered"><code>                obj.data.id = obj.id;</code><span class="hits">160</span></li><li class="covered"><code>                <span class="kwrd">return</span> this.<span class="func">readFromDb</span>(model, obj.data);</code><span class="hits">160</span></li><li class="covered"><code>            <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">19</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter) <span class="gly">{</span></code></li><li class="covered"><code>            nodes = nodes ? nodes.<span class="func">filter</span>(<span class="func">applyFilter</span>(filter)) : nodes;</code><span class="hits">17</span></li><li class=""><code>            <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> key = filter.order.<span class="func">split</span>(<span class="S">' '</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">6</span></li><li class="covered"><code>                <span class="kwrd">var</span> dir = filter.order.<span class="func">split</span>(<span class="S">' '</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">6</span></li><li class=""><code>                nodes = nodes.<span class="func">sort</span>(<span class="kwrd">function</span> (a, b) <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">return</span> a<span class="gly">[</span>key<span class="gly">]</span> > b<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">49</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">6</span></li><li class="covered"><code>                <span class="kwrd">if</span> (dir === <span class="S">'DESC'</span>) nodes = nodes.<span class="func">reverse</span>();</code><span class="hits">6</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, nodes);</code><span class="hits">19</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">19</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.allNodes = <span class="kwrd">function</span> <span class="func">all</span>(model, callback) <span class="gly">{</span></code></li><li class=""><code>    this.client.<span class="func">queryNodeIndex</span>(model, <span class="S">'id:*'</span>, <span class="kwrd">function</span> (err, nodes) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, nodes);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">applyFilter</span>(filter) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.where === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> filter.where;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> keys = Object.<span class="func">keys</span>(filter.where <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>);</code><span class="hits">17</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> (obj) <span class="gly">{</span></code><span class="hits">17</span></li><li class="covered"><code>        <span class="kwrd">var</span> pass = true;</code><span class="hits">145</span></li><li class=""><code>        keys.<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!<span class="func">test</span>(filter.where<span class="gly">[</span>key<span class="gly">]</span>, obj<span class="gly">[</span>key<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>                pass = false;</code><span class="hits">90</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">145</span></li><li class="covered"><code>        <span class="kwrd">return</span> pass;</code><span class="hits">145</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">test</span>(example, value) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'string'</span> && example && example.constructor.name === <span class="S">'RegExp'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> value.<span class="func">match</span>(example);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'object'</span> && value.constructor.name === <span class="S">'Date'</span> && <span class="kwrd">typeof</span> example === <span class="S">'object'</span> && example.constructor.name === <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> example.<span class="func">toString</span>() === value.<span class="func">toString</span>();</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="C">// not strict equality</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> example == value;</code><span class="hits">104</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> wait, error = null;</code><span class="hits">2</span></li><li class=""><code>    this.<span class="func">allNodes</span>(model, <span class="kwrd">function</span> (err, collection) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">2</span></li><li class="covered"><code>        wait = collection.length;</code><span class="hits">2</span></li><li class=""><code>        collection && collection.forEach && collection.<span class="func">forEach</span>(<span class="kwrd">function</span> (node) <span class="gly">{</span></code></li><li class="covered"><code>            node.<span class="func">delete</span>(done, true);</code><span class="hits">29</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err) <span class="gly">{</span></code></li><li class="covered"><code>        error = error <span class="gly">|</span><span class="gly">|</span> err;</code><span class="hits">29</span></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(error);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, conds) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">all</span>(model, <span class="gly">{</span>where: conds<span class="gly">}</span>, <span class="kwrd">function</span> (err, collection) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, collection ? collection.length : 0);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Neo4j.prototype.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttributes</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class="covered"><code>    data.id = id;</code><span class="hits">2</span></li><li class=""><code>    this.<span class="func">node</span>(id, <span class="kwrd">function</span> (err, node) <span class="gly">{</span></code></li><li class="covered"><code>        this.<span class="func">save</span>(model, <span class="func">merge</span>(node.data, data), cb);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">cleanup</span>(data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!data) <span class="kwrd">return</span> null;</code><span class="hits">35</span></li><li class="covered"><code>    <span class="kwrd">var</span> res = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">35</span></li><li class=""><code>    Object.<span class="func">keys</span>(data).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> v = data<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">263</span></li><li class=""><code>        <span class="kwrd">if</span> (v === null) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// skip</span></code></li><li class=""><code>            <span class="C">// console.log('skip null', key);</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (v && v.constructor.name === <span class="S">'Array'</span> && v.length === 0) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// skip</span></code></li><li class=""><code>            <span class="C">// console.log('skip blank array', key);</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> v !== <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            res<span class="gly">[</span>key<span class="gly">]</span> = v;</code><span class="hits">121</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">35</span></li><li class="covered"><code>    <span class="kwrd">return</span> res;</code><span class="hits">35</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">merge</span>(base, update) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(update).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        base<span class="gly">[</span>key<span class="gly">]</span> = update<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">return</span> base;</code><span class="hits">2</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-validatable-js" class="filename" name="lib-validatable-js" onclick="var el = document.getElementById('lib-validatable-js'); el.style.display = el.style.display ? '' : 'none';">lib/validatable.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 94%"><strong>94%</strong> [116/530]</div></div></div></div><div id="lib-validatable-js" style="display:none;"><pre><ol><li class="covered"><code>exports.Validatable = Validatable;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validation encapsulated in this abstract class.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Basically validation configurators is just class methods, which adds validations</span></code></li><li class=""><code><span class="C"> * configs to AbstractClass._validations. Each of this validations run when</span></code></li><li class=""><code><span class="C"> * `obj.isValid()` method called.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Each configurator can accept n params (n-1 field names and one config). Config</span></code></li><li class=""><code><span class="C"> * is {Object} depends on specific validation, but all of them has one common part:</span></code></li><li class=""><code><span class="C"> * `message` member. It can be just string, when only one situation possible,</span></code></li><li class=""><code><span class="C"> * e.g. `Post.validatesPresenceOf('title', { message: 'can not be blank' });`</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * In more complicated cases it can be {Hash} of messages (for each case):</span></code></li><li class=""><code><span class="C"> * `User.validatesLengthOf('password', { min: 6, max: 20, message: {min: 'too short', max: 'too long'}});`</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Validatable</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// validatable class</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate presence. This validation fails when validated field is blank.</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * Default error message "can't be blank"</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example presence of title</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * Post.validatesPresenceOf('title');</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * @example with custom message</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * Post.validatesPresenceOf('title', {message: 'Can not be blank'});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validatePresence</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesPresenceOf = <span class="func">getConfigurator</span>(<span class="S">'presence'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate length. Three kinds of validations: min, max, is.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error messages:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - min: too short</span></code></li><li class=""><code><span class="C"> * - max: too long</span></code></li><li class=""><code><span class="C"> * - is:  length is wrong</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example length validations</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('password', {min: 7});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('email', {max: 100});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('state', {is: 2});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('nick', {min: 3, max: 15});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * @example length validations with custom error messages</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('password', {min: 7, message: {min: 'too weak'}});</span></code></li><li class=""><code><span class="C"> * User.validatesLengthOf('state', {is: 2, message: {is: 'is not valid state name'}});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateLength</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesLengthOf = <span class="func">getConfigurator</span>(<span class="S">'length'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate numericality.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesNumericalityOf('age', { message: { number: '...' }});</span></code></li><li class=""><code><span class="C"> * User.validatesNumericalityOf('age', {int: true, message: { int: '...' }});</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error messages:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - number: is not a number</span></code></li><li class=""><code><span class="C"> * - int: is not an integer</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateNumericality</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesNumericalityOf = <span class="func">getConfigurator</span>(<span class="S">'numericality'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate inclusion in set</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example </span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * User.validatesInclusionOf('gender', {in: ['male', 'female']});</span></code></li><li class=""><code><span class="C"> * User.validatesInclusionOf('role', {</span></code></li><li class=""><code><span class="C"> *     in: ['admin', 'moderator', 'user'], message: 'is not allowed'</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is not included in the list</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @sync</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateInclusion</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesInclusionOf = <span class="func">getConfigurator</span>(<span class="S">'inclusion'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate exclusion</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example `Company.validatesExclusionOf('domain', {in: ['www', 'admin']});`</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is reserved</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateExclusion</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesExclusionOf = <span class="func">getConfigurator</span>(<span class="S">'exclusion'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate format</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is invalid</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateFormat</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesFormatOf = <span class="func">getConfigurator</span>(<span class="S">'format'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate using custom validator</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is invalid</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateCustom</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validate = <span class="func">getConfigurator</span>(<span class="S">'custom'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate using custom async validator</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is invalid</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @async</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateCustom</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validateAsync = <span class="func">getConfigurator</span>(<span class="S">'custom'</span>, <span class="gly">{</span>async: true<span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Validate uniqueness</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Default error message: is not unique</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @async</span></code></li><li class=""><code><span class="C"> * @nocode</span></code></li><li class=""><code><span class="C"> * @see helper/validateUniqueness</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>Validatable.validatesUniquenessOf = <span class="func">getConfigurator</span>(<span class="S">'uniqueness'</span>, <span class="gly">{</span>async: true<span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// implementation of validators</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Presence validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validatePresence</span>(attr, conf, err) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">blank</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">err</span>();</code><span class="hits">13</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Length validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateLength</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code><span class="hits">10</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> len = this<span class="gly">[</span>attr<span class="gly">]</span>.length;</code><span class="hits">10</span></li><li class=""><code>    <span class="kwrd">if</span> (conf.m<span class="kwrd">in</span> && len < conf.m<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">err</span>(<span class="S">'min'</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (conf.max && len > conf.max) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">err</span>(<span class="S">'max'</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (conf.is && len !== conf.is) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">err</span>(<span class="S">'is'</span>);</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Numericality validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateNumericality</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code><span class="hits">22</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this<span class="gly">[</span>attr<span class="gly">]</span> !== <span class="S">'number'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">err</span>(<span class="S">'number'</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (conf.int && this<span class="gly">[</span>attr<span class="gly">]</span> !== Math.<span class="func">round</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">err</span>(<span class="S">'int'</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Inclusion validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateInclusion</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code><span class="hits">19</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!~conf.<span class="kwrd">in</span>.<span class="func">indexOf</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="func">err</span>()</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Exclusion validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateExclusion</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code><span class="hits">15</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (~conf.<span class="kwrd">in</span>.<span class="func">indexOf</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="func">err</span>()</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Format validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateFormat</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (nullCheck.<span class="func">call</span>(this, attr, conf, err)) <span class="kwrd">return</span>;</code><span class="hits">13</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this<span class="gly">[</span>attr<span class="gly">]</span> === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!this<span class="gly">[</span>attr<span class="gly">]</span>.<span class="func">match</span>(conf<span class="gly">[</span><span class="S">'with'</span><span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">err</span>();</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">err</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Custom validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateCustom</span>(attr, conf, err, done) <span class="gly">{</span></code></li><li class="covered"><code>    conf.customValidator.<span class="func">call</span>(this, err, done);</code><span class="hits">242</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Uniqueness validator</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validateUniqueness</span>(attr, conf, err, done) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> cond = <span class="gly">{</span>where: <span class="gly">{</span><span class="gly">}</span><span class="gly">}</span>;</code><span class="hits">6</span></li><li class="covered"><code>    cond.where<span class="gly">[</span>attr<span class="gly">]</span> = this<span class="gly">[</span>attr<span class="gly">]</span>;</code><span class="hits">6</span></li><li class=""><code>    this.constructor.<span class="func">all</span>(cond, <span class="kwrd">function</span> (error, found) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (found.length > 1) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">err</span>();</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (found.length === 1 && found<span class="gly">[</span>0<span class="gly">]</span>.id != this.id) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">err</span>();</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">done</span>();</code><span class="hits">6</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">6</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> validators = <span class="gly">{</span></code></li><li class=""><code>    presence:     validatePresence,</code></li><li class=""><code>    length:       validateLength,</code></li><li class=""><code>    numericality: validateNumericality,</code></li><li class=""><code>    inclusion:    validateInclusion,</code></li><li class=""><code>    exclusion:    validateExclusion,</code></li><li class=""><code>    format:       validateFormat,</code></li><li class=""><code>    custom:       validateCustom,</code></li><li class=""><code>    uniqueness:   validateUniqueness</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getConfigurator</span>(name, opts) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> () <span class="gly">{</span></code><span class="hits">9</span></li><li class="covered"><code>        <span class="func">configure</span>(this, name, arguments, opts);</code><span class="hits">21</span></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * This method performs validation, triggers validation hooks.</span></code></li><li class=""><code><span class="C"> * Before validation `obj.errors` collection cleaned.</span></code></li><li class=""><code><span class="C"> * Each validation can add errors to `obj.errors` collection.</span></code></li><li class=""><code><span class="C"> * If collection is not blank, validation failed.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @warning This method can be called as sync only when no async validation</span></code></li><li class=""><code><span class="C"> * configured. It's strongly recommended to run all validations as asyncronous.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Function} callback called with (valid)</span></code></li><li class=""><code><span class="C"> * @return {Boolean} true if no async validation configured and all passed</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example ExpressJS controller: render user if valid, show flash otherwise</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * user.isValid(function (valid) {</span></code></li><li class=""><code><span class="C"> *     if (valid) res.render({user: user});</span></code></li><li class=""><code><span class="C"> *     else res.flash('error', 'User is not valid'), console.log(user.errors), res.redirect('/users');</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Validatable.prototype.isValid = <span class="kwrd">function</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> valid = true, inst = this, wait = 0, async = false;</code><span class="hits">373</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// exit with success when no errors</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this.constructor._validations) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">cleanErrors</span>(this);</code><span class="hits">107</span></li><li class=""><code>        <span class="kwrd">if</span> (callback) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(valid);</code><span class="hits">107</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> valid;</code><span class="hits">107</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(this, <span class="S">'errors'</span>, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: <span class="kwrd">new</span> Errors</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">266</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">trigger</span>(<span class="S">'validation'</span>, <span class="kwrd">function</span> (validationsDone) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> inst = this;</code><span class="hits">266</span></li><li class=""><code>        this.constructor._validations.<span class="func">forEach</span>(<span class="kwrd">function</span> (v) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (v<span class="gly">[</span>2<span class="gly">]</span> && v<span class="gly">[</span>2<span class="gly">]</span>.async) <span class="gly">{</span></code></li><li class="covered"><code>                async = true;</code><span class="hits">237</span></li><li class="covered"><code>                wait += 1;</code><span class="hits">237</span></li><li class="covered"><code>                <span class="func">validationFailed</span>(inst, v, done);</code><span class="hits">237</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="func">validationFailed</span>(inst, v)) <span class="gly">{</span></code></li><li class="covered"><code>                    valid = false;</code><span class="hits">26</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">266</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!async) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">validationsDone</span>();</code><span class="hits">35</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> asyncFail = false;</code><span class="hits">266</span></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">done</span>(fail) <span class="gly">{</span></code></li><li class="covered"><code>            asyncFail = asyncFail <span class="gly">|</span><span class="gly">|</span> fail;</code><span class="hits">237</span></li><li class=""><code>            <span class="kwrd">if</span> (--wait === 0 && callback) <span class="gly">{</span></code></li><li class=""><code>                validationsDone.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                    <span class="kwrd">if</span>( valid && !asyncFail ) <span class="func">cleanErrors</span>(inst);</code><span class="hits">230</span></li><li class="covered"><code>                    <span class="func">callback</span>(valid && !asyncFail);</code><span class="hits">230</span></li><li class="covered"><code>                <span class="gly">}</span>);</code><span class="hits">230</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">266</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!async) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (valid) <span class="func">cleanErrors</span>(this);</code><span class="hits">35</span></li><li class="covered"><code>        <span class="kwrd">if</span> (callback) <span class="func">callback</span>(valid);</code><span class="hits">34</span></li><li class="covered"><code>        <span class="kwrd">return</span> valid;</code><span class="hits">34</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// in case of async validation we should return undefined here,</span></code></li><li class=""><code>        <span class="C">// because not all validations are finished yet</span></code></li><li class="covered"><code>        <span class="kwrd">return</span>;</code><span class="hits">231</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">cleanErrors</span>(inst) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(inst, <span class="S">'errors'</span>, <span class="gly">{</span></code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: true,</code></li><li class=""><code>        value: false</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">350</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">validationFailed</span>(inst, v, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> attr = v<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">579</span></li><li class="covered"><code>    <span class="kwrd">var</span> conf = v<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">579</span></li><li class="covered"><code>    <span class="kwrd">var</span> opts = v<span class="gly">[</span>2<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">579</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> attr !== <span class="S">'string'</span>) <span class="kwrd">return</span> false;</code><span class="hits">579</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// here we should check skip validation conditions (if, unless)</span></code></li><li class=""><code>    <span class="C">// that can be specified in conf</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">skipValidation</span>(inst, conf, <span class="S">'if'</span>)) <span class="kwrd">return</span> false;</code><span class="hits">544</span></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="func">skipValidation</span>(inst, conf, <span class="S">'unless'</span>)) <span class="kwrd">return</span> false;</code><span class="hits">472</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> fail = false;</code><span class="hits">472</span></li><li class="covered"><code>    <span class="kwrd">var</span> validator = validators<span class="gly">[</span>conf.validation<span class="gly">]</span>;</code><span class="hits">472</span></li><li class="covered"><code>    <span class="kwrd">var</span> validatorArguments = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">472</span></li><li class="covered"><code>    validatorArguments.<span class="func">push</span>(attr);</code><span class="hits">472</span></li><li class="covered"><code>    validatorArguments.<span class="func">push</span>(conf);</code><span class="hits">472</span></li><li class=""><code>    validatorArguments.<span class="func">push</span>(<span class="kwrd">function</span> <span class="func">onerror</span>(kind) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> message;</code><span class="hits">28</span></li><li class=""><code>        <span class="kwrd">if</span> (conf.message) <span class="gly">{</span></code></li><li class="covered"><code>            message = conf.message;</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!message && defaultMessages<span class="gly">[</span>conf.validation<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            message = defaultMessages<span class="gly">[</span>conf.validation<span class="gly">]</span>;</code><span class="hits">24</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!message) <span class="gly">{</span></code></li><li class="covered"><code>            message = <span class="S">'is invalid'</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (kind) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (message<span class="gly">[</span>kind<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// get deeper</span></code></li><li class="covered"><code>                message = message<span class="gly">[</span>kind<span class="gly">]</span>;</code><span class="hits">10</span></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (defaultMessages.common<span class="gly">[</span>kind<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                message = defaultMessages.common<span class="gly">[</span>kind<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        inst.errors.<span class="func">add</span>(attr, message);</code><span class="hits">28</span></li><li class="covered"><code>        fail = true;</code><span class="hits">28</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">472</span></li><li class=""><code>    <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class=""><code>        validatorArguments.<span class="func">push</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>(fail);</code><span class="hits">237</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">237</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    validator.<span class="func">apply</span>(inst, validatorArguments);</code><span class="hits">472</span></li><li class="covered"><code>    <span class="kwrd">return</span> fail;</code><span class="hits">472</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">skipValidation</span>(inst, conf, kind) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> doValidate = true;</code><span class="hits">1123</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> conf<span class="gly">[</span>kind<span class="gly">]</span> === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        doValidate = conf<span class="gly">[</span>kind<span class="gly">]</span>.<span class="func">call</span>(inst);</code><span class="hits">36</span></li><li class="covered"><code>        <span class="kwrd">if</span> (kind === <span class="S">'unless'</span>) doValidate = !doValidate;</code><span class="hits">36</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> conf<span class="gly">[</span>kind<span class="gly">]</span> === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (inst.<span class="func">hasOwnProperty</span>(conf<span class="gly">[</span>kind<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>            doValidate = inst<span class="gly">[</span>conf<span class="gly">[</span>kind<span class="gly">]</span><span class="gly">]</span>;</code><span class="hits">45</span></li><li class="covered"><code>            <span class="kwrd">if</span> (kind === <span class="S">'unless'</span>) doValidate = !doValidate;</code><span class="hits">45</span></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> inst<span class="gly">[</span>conf<span class="gly">[</span>kind<span class="gly">]</span><span class="gly">]</span> === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            doValidate = inst<span class="gly">[</span>conf<span class="gly">[</span>kind<span class="gly">]</span><span class="gly">]</span>.<span class="func">call</span>(inst);</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (kind === <span class="S">'unless'</span>) doValidate = !doValidate;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            doValidate = kind === <span class="S">'if'</span>;</code><span class="hits">37</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> !doValidate;</code><span class="hits">1123</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> defaultMessages = <span class="gly">{</span></code></li><li class=""><code>    presence: <span class="S">'can\'t be blank'</span>,</code></li><li class=""><code>    length: <span class="gly">{</span></code></li><li class=""><code>        m<span class="kwrd">in</span>: <span class="S">'too short'</span>,</code></li><li class=""><code>        max: <span class="S">'too long'</span>,</code></li><li class=""><code>        is: <span class="S">'length is wrong'</span></code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    common: <span class="gly">{</span></code></li><li class=""><code>        blank: <span class="S">'is blank'</span>,</code></li><li class=""><code>        <span class="S">'null'</span>: <span class="S">'is null'</span></code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    numericality: <span class="gly">{</span></code></li><li class=""><code>        <span class="S">'int'</span>: <span class="S">'is not an integer'</span>,</code></li><li class=""><code>        <span class="S">'number'</span>: <span class="S">'is not a number'</span></code></li><li class=""><code>    <span class="gly">}</span>,</code></li><li class=""><code>    inclusion: <span class="S">'is not included in the list'</span>,</code></li><li class=""><code>    exclusion: <span class="S">'is reserved'</span>,</code></li><li class=""><code>    uniqueness: <span class="S">'is not unique'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">nullCheck</span>(attr, conf, err) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> isNull = this<span class="gly">[</span>attr<span class="gly">]</span> === null <span class="gly">|</span><span class="gly">|</span> !(attr <span class="kwrd">in</span> this);</code><span class="hits">130</span></li><li class=""><code>    <span class="kwrd">if</span> (isNull) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!conf.allowNull) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">err</span>(<span class="S">'null'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> true;</code><span class="hits">25</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">blank</span>(this<span class="gly">[</span>attr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!conf.allowBlank) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">err</span>(<span class="S">'blank'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> true;</code><span class="hits">26</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> false;</code><span class="hits">79</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return true when v is undefined, blank array, null or empty string</span></code></li><li class=""><code><span class="C"> * otherwise returns false</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Mix} v</span></code></li><li class=""><code><span class="C"> * @returns {Boolean} whether `v` blank or not</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">blank</span>(v) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> v === <span class="S">'undefined'</span>) <span class="kwrd">return</span> true;</code><span class="hits">199</span></li><li class="covered"><code>    <span class="kwrd">if</span> (v instanceof Array && v.length === 0) <span class="kwrd">return</span> true;</code><span class="hits">199</span></li><li class="covered"><code>    <span class="kwrd">if</span> (v === null) <span class="kwrd">return</span> true;</code><span class="hits">186</span></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> v == <span class="S">'string'</span> && v === <span class="S">''</span>) <span class="kwrd">return</span> true;</code><span class="hits">160</span></li><li class="covered"><code>    <span class="kwrd">return</span> false;</code><span class="hits">160</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">configure</span>(cls, validation, args, opts) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!cls._validations) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(cls, <span class="S">'_validations'</span>, <span class="gly">{</span></code></li><li class=""><code>            writable: true,</code></li><li class=""><code>            configurable: true,</code></li><li class=""><code>            enumerable: false,</code></li><li class=""><code>            value: <span class="gly">[</span><span class="gly">]</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">9</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    args = <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(args);</code><span class="hits">21</span></li><li class="covered"><code>    <span class="kwrd">var</span> conf;</code><span class="hits">21</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> === <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        conf = args.<span class="func">pop</span>();</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        conf = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (validation === <span class="S">'custom'</span> && <span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        conf.customValidator = args.<span class="func">pop</span>();</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    conf.validation = validation;</code><span class="hits">21</span></li><li class=""><code>    args.<span class="func">forEach</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span></code></li><li class="covered"><code>        cls._validations.<span class="func">push</span>(<span class="gly">[</span>attr, conf, opts<span class="gly">]</span>);</code><span class="hits">22</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">21</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Errors</span>() <span class="gly">{</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>Errors.prototype.add = <span class="kwrd">function</span> (field, message) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this<span class="gly">[</span>field<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>        this<span class="gly">[</span>field<span class="gly">]</span> = <span class="gly">[</span>message<span class="gly">]</span>;</code><span class="hits">27</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        this<span class="gly">[</span>field<span class="gly">]</span>.<span class="func">push</span>(message);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-mongodb-js" class="filename" name="lib-adapters-mongodb-js" onclick="var el = document.getElementById('lib-adapters-mongodb-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/mongodb.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 97%"><strong>97%</strong> [95/190]</div></div></div></div><div id="lib-adapters-mongodb-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> mongodb = <span class="func">safeRequire</span>(<span class="S">'mongodb'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> ObjectID = mongodb.ObjectID;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!mongodb) <span class="kwrd">return</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> s = schema.settings;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (schema.settings.url) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> url = <span class="func">require</span>(<span class="S">'url'</span>).<span class="func">parse</span>(schema.settings.url);</code><span class="hits">1</span></li><li class="covered"><code>        s.host = url.hostname;</code><span class="hits">1</span></li><li class="covered"><code>        s.port = url.port;</code><span class="hits">1</span></li><li class="covered"><code>        s.database = url.pathname.<span class="func">replace</span>(/^\<span class="C">//, '');</span></code><span class="hits">1</span></li><li class="covered"><code>        s.username = url.auth && url.auth.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">1</span></li><li class="covered"><code>        s.password = url.auth && url.auth.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    s.host = s.host <span class="gly">|</span><span class="gly">|</span> <span class="S">'localhost'</span>;</code><span class="hits">1</span></li><li class="covered"><code>    s.port = <span class="func">parseInt</span>(s.port <span class="gly">|</span><span class="gly">|</span> <span class="S">'27017'</span>, 10);</code><span class="hits">1</span></li><li class="covered"><code>    s.database = s.database <span class="gly">|</span><span class="gly">|</span> <span class="S">'test'</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">MongoDB</span>(s, schema, callback);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">MongoDB</span>(s, schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    this.collections = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> server = <span class="kwrd">new</span> mongodb.<span class="func">Server</span>(s.host, s.port, <span class="gly">{</span><span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">new</span> mongodb.<span class="func">Db</span>(s.database, server, <span class="gly">{</span><span class="gly">}</span>).<span class="func">open</span>(<span class="kwrd">function</span> (err, client) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) throw err;</code><span class="hits">1</span></li><li class="covered"><code>        this.client = client;</code><span class="hits">1</span></li><li class="covered"><code>        schema.client = client;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">callback</span>();</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.define = <span class="kwrd">function</span> (descr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!descr.settings) descr.settings = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code>    this._models<span class="gly">[</span>descr.model.modelName<span class="gly">]</span> = descr;</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.defineProperty = <span class="kwrd">function</span> (model, prop, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span> = params;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.collection = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this.collections<span class="gly">[</span>name<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>        this.collections<span class="gly">[</span>name<span class="gly">]</span> = <span class="kwrd">new</span> mongodb.<span class="func">Collection</span>(this.client, name);</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.collections<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">87</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.create = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">insert</span>(data, <span class="gly">{</span><span class="gly">}</span>, <span class="kwrd">function</span> (err, m) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, err ? null : m<span class="gly">[</span>0<span class="gly">]</span>._id.<span class="func">toString</span>());</code><span class="hits">40</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">40</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.save = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">save</span>(<span class="gly">{</span>_id: <span class="kwrd">new</span> <span class="func">ObjectID</span>(data.id)<span class="gly">}</span>, data, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.exists = <span class="kwrd">function</span> (model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">findOne</span>(<span class="gly">{</span>_id: <span class="kwrd">new</span> <span class="func">ObjectID</span>(id)<span class="gly">}</span>, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, !err && data);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.find = <span class="kwrd">function</span> <span class="func">find</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">findOne</span>(<span class="gly">{</span>_id: <span class="kwrd">new</span> <span class="func">ObjectID</span>(id)<span class="gly">}</span>, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (data) data.id = id;</code><span class="hits">11</span></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">11</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">11</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.updateOrCreate = <span class="kwrd">function</span> <span class="func">updateOrCreate</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> adapter = this;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="kwrd">if</span> (!data.id) <span class="kwrd">return</span> this.<span class="func">create</span>(data, callback);</code><span class="hits">2</span></li><li class=""><code>    this.<span class="func">find</span>(model, data.id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>            adapter.<span class="func">updateAttributes</span>(model, data.id, data, callback);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            delete data.id;</code><span class="hits">2</span></li><li class=""><code>            adapter.<span class="func">create</span>(model, data, <span class="kwrd">function</span> (err, id) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">2</span></li><li class=""><code>                <span class="kwrd">if</span> (id) <span class="gly">{</span></code></li><li class="covered"><code>                    data.id = id;</code><span class="hits">2</span></li><li class="covered"><code>                    delete data._id;</code><span class="hits">2</span></li><li class="covered"><code>                    <span class="func">callback</span>(null, data);</code><span class="hits">2</span></li><li class=""><code>                <span class="gly">}</span> else<span class="gly">{</span></code></li><li class=""><code>                    <span class="func">callback</span>(null, null); <span class="C">// wtf?</span></code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">collection</span>(model).<span class="func">remove</span>(<span class="gly">{</span>_id: <span class="kwrd">new</span> <span class="func">ObjectID</span>(id)<span class="gly">}</span>, callback);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!filter) <span class="gly">{</span></code></li><li class="covered"><code>        filter = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> query = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">21</span></li><li class=""><code>    <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(filter.where).<span class="func">forEach</span>(<span class="kwrd">function</span> (k) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> cond = filter.where<span class="gly">[</span>k<span class="gly">]</span>;</code><span class="hits">16</span></li><li class="covered"><code>            <span class="kwrd">var</span> spec = false;</code><span class="hits">16</span></li><li class=""><code>            <span class="kwrd">if</span> (cond && cond.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                spec = Object.<span class="func">keys</span>(cond)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">5</span></li><li class="covered"><code>                cond = cond<span class="gly">[</span>spec<span class="gly">]</span>;</code><span class="hits">5</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (spec) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (spec === <span class="S">'between'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = <span class="gly">{</span> $gte: cond<span class="gly">[</span>0<span class="gly">]</span>, $lte: cond<span class="gly">[</span>1<span class="gly">]</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class="covered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span><span class="gly">[</span><span class="S">'
    </div>
  </body>
</html>
</span> + spec<span class="gly">]</span> = cond;</code><span class="hits">4</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (cond === null) <span class="gly">{</span></code></li><li class="covered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = <span class="gly">{</span>$type: 10<span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = cond;</code><span class="hits">10</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">16</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> cursor = this.<span class="func">collection</span>(model).<span class="func">find</span>(query);</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> m = filter.order.<span class="func">match</span>(<span class="R">/\s+(A|DE)SC$/</span>);</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">var</span> key = filter.order;</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">var</span> reverse = false;</code><span class="hits">6</span></li><li class=""><code>        <span class="kwrd">if</span> (m) <span class="gly">{</span></code></li><li class="covered"><code>            key = key.<span class="func">replace</span>(<span class="R">/\s+(A|DE)SC$/</span>, <span class="S">''</span>);</code><span class="hits">3</span></li><li class="covered"><code>            <span class="kwrd">if</span> (m<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'DE'</span>) reverse = true;</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (reverse) <span class="gly">{</span></code></li><li class="covered"><code>            cursor.<span class="func">sort</span>(<span class="gly">[</span><span class="gly">[</span>key, <span class="S">'desc'</span><span class="gly">]</span><span class="gly">]</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            cursor.<span class="func">sort</span>(key);</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.limit) <span class="gly">{</span></code></li><li class="covered"><code>        cursor.<span class="func">limit</span>(filter.limit);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.skip) <span class="gly">{</span></code></li><li class="uncovered"><code>        cursor.<span class="func">skip</span>(filter.skip);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (filter.offset) <span class="gly">{</span></code></li><li class="uncovered"><code>        cursor.<span class="func">skip</span>(filter.offset);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    cursor.<span class="func">toArray</span>(<span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">21</span></li><li class="covered"><code>        <span class="func">callback</span>(null, data.<span class="func">map</span>(<span class="kwrd">function</span> (o) <span class="gly">{</span> o.id = o._id.<span class="func">toString</span>(); delete o._id; <span class="kwrd">return</span> o; <span class="gly">}</span>));</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">21</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">collection</span>(model).<span class="func">remove</span>(<span class="gly">{</span><span class="gly">}</span>, callback);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">count</span>(where, <span class="kwrd">function</span> (err, count) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, count);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttrs</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">findAndModify</span>(<span class="gly">{</span>_id: <span class="kwrd">new</span> <span class="func">ObjectID</span>(id)<span class="gly">}</span>, <span class="gly">[</span><span class="gly">[</span><span class="S">'_id'</span>,<span class="S">'asc'</span><span class="gly">]</span><span class="gly">]</span>, <span class="gly">{</span>$set: data<span class="gly">}</span>, <span class="gly">{</span><span class="gly">}</span>, <span class="kwrd">function</span>(err, object) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">cb</span>(err, object);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.prototype.disconnect = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    this.client.<span class="func">close</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-memory-js" class="filename" name="lib-adapters-memory-js" onclick="var el = document.getElementById('lib-adapters-memory-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/memory.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 99%"><strong>99%</strong> [84/175]</div></div></div></div><div id="lib-adapters-memory-js" style="display:none;"><pre><ol><li class="covered"><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">Memory</span>();</code><span class="hits">3</span></li><li class="covered"><code>    process.<span class="func">nextTick</span>(callback);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Memory</span>() <span class="gly">{</span></code></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code>    this.cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class="covered"><code>    this.ids = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>Memory.prototype.define = <span class="kwrd">function</span> <span class="func">defineModel</span>(descr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> m = descr.model.modelName;</code><span class="hits">5</span></li><li class="covered"><code>    this._models<span class="gly">[</span>m<span class="gly">]</span> = descr;</code><span class="hits">5</span></li><li class="covered"><code>    this.cache<span class="gly">[</span>m<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">5</span></li><li class="covered"><code>    this.ids<span class="gly">[</span>m<span class="gly">]</span> = 1;</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.create = <span class="kwrd">function</span> <span class="func">create</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> id = data.id <span class="gly">|</span><span class="gly">|</span> this.ids<span class="gly">[</span>model<span class="gly">]</span>++;</code><span class="hits">42</span></li><li class="covered"><code>    data.id = id;</code><span class="hits">42</span></li><li class="covered"><code>    this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span> = data;</code><span class="hits">42</span></li><li class="covered"><code>    <span class="func">callback</span>(null, id);</code><span class="hits">42</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.updateOrCreate = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> mem = this;</code><span class="hits">2</span></li><li class=""><code>    this.<span class="func">exists</span>(model, data.id, <span class="kwrd">function</span> (err, exists) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (exists) <span class="gly">{</span></code></li><li class="uncovered"><code>            mem.<span class="func">save</span>(model, data, callback);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            mem.<span class="func">create</span>(model, data, <span class="kwrd">function</span> (err, id) <span class="gly">{</span></code></li><li class="covered"><code>                data.id = id;</code><span class="hits">2</span></li><li class="covered"><code>                <span class="func">callback</span>(err, data);</code><span class="hits">2</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.save = <span class="kwrd">function</span> <span class="func">save</span>(model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>data.id<span class="gly">]</span> = data;</code><span class="hits">7</span></li><li class="covered"><code>    <span class="func">callback</span>(null, data);</code><span class="hits">7</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.exists = <span class="kwrd">function</span> <span class="func">exists</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">callback</span>(null, this.cache<span class="gly">[</span>model<span class="gly">]</span>.<span class="func">hasOwnProperty</span>(id));</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.find = <span class="kwrd">function</span> <span class="func">find</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">callback</span>(null, this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>);</code><span class="hits">9</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class="covered"><code>    delete this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="func">callback</span>();</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> nodes = Object.<span class="func">keys</span>(this.cache<span class="gly">[</span>model<span class="gly">]</span>).<span class="func">map</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">122</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">24</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// do we need some filtration?</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class="covered"><code>            nodes = nodes ? nodes.<span class="func">filter</span>(<span class="func">applyFilter</span>(filter)) : nodes;</code><span class="hits">19</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// do we need some sorting?</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">6</span></li><li class="covered"><code>            <span class="kwrd">var</span> allNumeric = true;</code><span class="hits">6</span></li><li class="covered"><code>            <span class="kwrd">var</span> orders = filter.order;</code><span class="hits">6</span></li><li class="covered"><code>            <span class="kwrd">var</span> reverse = false;</code><span class="hits">6</span></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.order === <span class="S">"string"</span>) <span class="gly">{</span></code></li><li class="covered"><code>                orders = <span class="gly">[</span>filter.order<span class="gly">]</span>;</code><span class="hits">6</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            orders.<span class="func">forEach</span>(<span class="kwrd">function</span> (key, i) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">var</span> m = key.<span class="func">match</span>(<span class="R">/\s+(A|DE)SC$/i</span>);</code><span class="hits">6</span></li><li class=""><code>                <span class="kwrd">if</span> (m) <span class="gly">{</span></code></li><li class="covered"><code>                    key = key.<span class="func">replace</span>(<span class="R">/\s+(A|DE)SC/i</span>, <span class="S">''</span>);</code><span class="hits">3</span></li><li class="covered"><code>                    <span class="kwrd">if</span> (m<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'DE'</span>) reverse = true;</code><span class="hits">3</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>                orders<span class="gly">[</span>i<span class="gly">]</span> = key;</code><span class="hits">6</span></li><li class=""><code>                <span class="kwrd">if</span> (props<span class="gly">[</span>key<span class="gly">]</span>.type.name !== <span class="S">'Number'</span> && props<span class="gly">[</span>key<span class="gly">]</span>.type.name !== <span class="S">'Date'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    allNumeric = false;</code><span class="hits">5</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">6</span></li><li class=""><code>            <span class="kwrd">if</span> (allNumeric) <span class="gly">{</span></code></li><li class="covered"><code>                nodes = nodes.<span class="func">sort</span>(numerically.<span class="func">bind</span>(orders));</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                nodes = nodes.<span class="func">sort</span>(literally.<span class="func">bind</span>(orders));</code><span class="hits">5</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (reverse) nodes = nodes.<span class="func">reverse</span>();</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(null, nodes);</code><span class="hits">24</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">24</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">numerically</span>(a, b) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> a<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span> - b<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span>;</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">literally</span>(a, b) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> a<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span> > b<span class="gly">[</span>this<span class="gly">[</span>0<span class="gly">]</span><span class="gly">]</span>;</code><span class="hits">39</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">applyFilter</span>(filter) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> filter.where === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> filter.where;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> keys = Object.<span class="func">keys</span>(filter.where);</code><span class="hits">19</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> (obj) <span class="gly">{</span></code><span class="hits">19</span></li><li class="covered"><code>        <span class="kwrd">var</span> pass = true;</code><span class="hits">98</span></li><li class=""><code>        keys.<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (!<span class="func">test</span>(filter.where<span class="gly">[</span>key<span class="gly">]</span>, obj<span class="gly">[</span>key<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class="covered"><code>                pass = false;</code><span class="hits">69</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">98</span></li><li class="covered"><code>        <span class="kwrd">return</span> pass;</code><span class="hits">98</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">test</span>(example, value) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> value === <span class="S">'string'</span> && example && example.constructor.name === <span class="S">'RegExp'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> value.<span class="func">match</span>(example);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="C">// not strict equality</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> example == value;</code><span class="hits">98</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>Memory.prototype.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(this.cache<span class="gly">[</span>model<span class="gly">]</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (id) <span class="gly">{</span></code></li><li class="covered"><code>        delete this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">12</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">2</span></li><li class="covered"><code>    this.cache<span class="gly">[</span>model<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="func">callback</span>();</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> cache = this.cache<span class="gly">[</span>model<span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code>    <span class="kwrd">var</span> data = Object.<span class="func">keys</span>(cache)</code></li><li class=""><code>    <span class="kwrd">if</span> (where) <span class="gly">{</span></code></li><li class=""><code>        data = data.<span class="func">filter</span>(<span class="kwrd">function</span> (id) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> ok = true;</code><span class="hits">8</span></li><li class=""><code>            Object.<span class="func">keys</span>(where).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (cache<span class="gly">[</span>id<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span> != where<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>                    ok = false;</code><span class="hits">8</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">8</span></li><li class="covered"><code>            <span class="kwrd">return</span> ok;</code><span class="hits">8</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="func">callback</span>(null, data.length);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Memory.prototype.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttributes</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class="covered"><code>    data.id = id;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> base = this.cache<span class="gly">[</span>model<span class="gly">]</span><span class="gly">[</span>id<span class="gly">]</span>;</code><span class="hits">4</span></li><li class="covered"><code>    this.<span class="func">save</span>(model, <span class="func">merge</span>(base, data), cb);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">merge</span>(base, update) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!base) <span class="kwrd">return</span> update;</code><span class="hits">4</span></li><li class=""><code>    Object.<span class="func">keys</span>(update).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        base<span class="gly">[</span>key<span class="gly">]</span> = update<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">10</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">return</span> base;</code><span class="hits">4</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-schema-js" class="filename" name="lib-schema-js" onclick="var el = document.getElementById('lib-schema-js'); el.style.display = el.style.display ? '' : 'none';">lib/schema.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 94%"><strong>94%</strong> [80/314]</div></div></div></div><div id="lib-schema-js" style="display:none;"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> AbstractClass = <span class="func">require</span>(<span class="S">'./abstract-class'</span>).AbstractClass;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> util = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Export public API</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>exports.Schema = Schema;</code><span class="hits">1</span></li><li class=""><code><span class="C">// exports.AbstractClass = AbstractClass;</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Helpers</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> slice = Array.prototype.slice;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Schema - adapter-specific classes factory.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * All classes in single schema shares same adapter type and</span></code></li><li class=""><code><span class="C"> * one database connection</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param name - type of schema adapter (mysql, mongoose, sequelize, redis)</span></code></li><li class=""><code><span class="C"> * @param settings - any database-specific settings which we need to</span></code></li><li class=""><code><span class="C"> * establish connection (of course it depends on specific adapter)</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - host</span></code></li><li class=""><code><span class="C"> * - port</span></code></li><li class=""><code><span class="C"> * - username</span></code></li><li class=""><code><span class="C"> * - password</span></code></li><li class=""><code><span class="C"> * - database</span></code></li><li class=""><code><span class="C"> * - debug {Boolean} = false</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example Schema creation, waiting for connection callback</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * var schema = new Schema('mysql', { database: 'myapp_test' });</span></code></li><li class=""><code><span class="C"> * schema.define(...);</span></code></li><li class=""><code><span class="C"> * schema.on('connected', function () {</span></code></li><li class=""><code><span class="C"> *     // work with database</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Schema</span>(name, settings) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> schema = this;</code><span class="hits">11</span></li><li class=""><code>    <span class="C">// just save everything we get</span></code></li><li class="covered"><code>    this.name = name;</code><span class="hits">11</span></li><li class="covered"><code>    this.settings = settings;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// Disconnected by default</span></code></li><li class="covered"><code>    this.connected = false;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// create blank models pool</span></code></li><li class="covered"><code>    this.models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">11</span></li><li class="covered"><code>    this.definitions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// and initialize schema using adapter</span></code></li><li class=""><code>    <span class="C">// this is only one initialization entry point of adapter</span></code></li><li class=""><code>    <span class="C">// this module should define `adapter` member of `this` (schema)</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> adapter;</code><span class="hits">11</span></li><li class=""><code>    <span class="kwrd">if</span> (path.<span class="func">existsSync</span>(__dirname + <span class="S">'/adapters/'</span> + name + <span class="S">'.js'</span>)) <span class="gly">{</span></code></li><li class="covered"><code>        adapter = <span class="func">require</span>(<span class="S">'./adapters/'</span> + name);</code><span class="hits">11</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            adapter = <span class="func">require</span>(name);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Adapter '</span> + name + <span class="S">' is not defined, try\n  npm install '</span> + name);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    adapter.<span class="func">initialize</span>(this, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// we have an adaper now?</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!this.adapter) <span class="gly">{</span></code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Adapter is not defined correctly: it should create `adapter` member of schema'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        this.adapter.log = <span class="kwrd">function</span> (query, start) <span class="gly">{</span></code></li><li class="covered"><code>            schema.<span class="func">log</span>(query, start);</code><span class="hits">440</span></li><li class="covered"><code>        <span class="gly">}</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class=""><code>        this.adapter.logger = <span class="kwrd">function</span> (query) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> t1 = Date.<span class="func">now</span>();</code><span class="hits">66</span></li><li class="covered"><code>            <span class="kwrd">var</span> log = this.log;</code><span class="hits">66</span></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="kwrd">function</span> (q) <span class="gly">{</span></code><span class="hits">66</span></li><li class="covered"><code>                <span class="func">log</span>(q <span class="gly">|</span><span class="gly">|</span> query, t1);</code><span class="hits">95</span></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class="covered"><code>        <span class="gly">}</span>;</code><span class="hits">11</span></li><li class=""><code></code></li><li class="covered"><code>        this.connected = true;</code><span class="hits">11</span></li><li class="covered"><code>        this.<span class="func">emit</span>(<span class="S">'connected'</span>);</code><span class="hits">11</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">11</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>util.<span class="func">inherits</span>(Schema, <span class="func">require</span>(<span class="S">'events'</span>).EventEmitter);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Text</span>() <span class="gly">{</span><span class="gly">}</span></code></li><li class="covered"><code>Schema.Text = Text;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define class</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} className</span></code></li><li class=""><code><span class="C"> * @param {Object} properties - hash of class properties in format</span></code></li><li class=""><code><span class="C"> *   `{property: Type, property2: Type2, ...}`</span></code></li><li class=""><code><span class="C"> *   or</span></code></li><li class=""><code><span class="C"> *   `{property: {type: Type}, property2: {type: Type2}, ...}`</span></code></li><li class=""><code><span class="C"> * @param {Object} settings - other configuration of class</span></code></li><li class=""><code><span class="C"> * @return newly created class</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @example simple case</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * var User = schema.define('User', {</span></code></li><li class=""><code><span class="C"> *     email: String,</span></code></li><li class=""><code><span class="C"> *     password: String,</span></code></li><li class=""><code><span class="C"> *     birthDate: Date,</span></code></li><li class=""><code><span class="C"> *     activated: Boolean</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * @example more advanced case</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * var User = schema.defind('User', {</span></code></li><li class=""><code><span class="C"> *     email: { type: String, limit: 150, index: true },</span></code></li><li class=""><code><span class="C"> *     password: { type: String, limit: 50 },</span></code></li><li class=""><code><span class="C"> *     birthDate: Date,</span></code></li><li class=""><code><span class="C"> *     registrationDate: {type: Date, default: function () { return new Date }},</span></code></li><li class=""><code><span class="C"> *     activated: { type: Boolean, default: false }</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.define = <span class="kwrd">function</span> <span class="func">defineClass</span>(className, properties, settings) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> schema = this;</code><span class="hits">27</span></li><li class="covered"><code>    <span class="kwrd">var</span> args = slice.<span class="func">call</span>(arguments);</code><span class="hits">27</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!className) throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Class name required'</span>);</code><span class="hits">27</span></li><li class="covered"><code>    <span class="kwrd">if</span> (args.length == 1) properties = <span class="gly">{</span><span class="gly">}</span>, args.<span class="func">push</span>(properties);</code><span class="hits">27</span></li><li class="covered"><code>    <span class="kwrd">if</span> (args.length == 2) settings   = <span class="gly">{</span><span class="gly">}</span>, args.<span class="func">push</span>(settings);</code><span class="hits">27</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">standartize</span>(properties, settings);</code><span class="hits">27</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// every class can receive hash of data as optional param</span></code></li><li class=""><code>    <span class="kwrd">var</span> newClass = <span class="kwrd">function</span> <span class="func">ModelConstructor</span>(data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!(this instanceof ModelConstructor)) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">ModelConstructor</span>(data);</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        AbstractClass.<span class="func">call</span>(this, data);</code><span class="hits">971</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">27</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(newClass, <span class="S">'schema'</span>, schema);</code><span class="hits">27</span></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(newClass, <span class="S">'modelName'</span>, className);</code><span class="hits">27</span></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(newClass, <span class="S">'cache'</span>, <span class="gly">{</span><span class="gly">}</span>);</code><span class="hits">27</span></li><li class="covered"><code>    <span class="func">hiddenProperty</span>(newClass, <span class="S">'mru'</span>, <span class="gly">[</span><span class="gly">]</span>);</code><span class="hits">27</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// setup inheritance</span></code></li><li class="covered"><code>    newClass.__proto__ = AbstractClass;</code><span class="hits">27</span></li><li class="covered"><code>    util.<span class="func">inherits</span>(newClass, AbstractClass);</code><span class="hits">27</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// store class in model pool</span></code></li><li class="covered"><code>    this.models<span class="gly">[</span>className<span class="gly">]</span> = newClass;</code><span class="hits">27</span></li><li class=""><code>    this.definitions<span class="gly">[</span>className<span class="gly">]</span> = <span class="gly">{</span></code></li><li class=""><code>        properties: properties,</code></li><li class=""><code>        settings: settings</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">27</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// pass controll to adapter</span></code></li><li class=""><code>    this.adapter.<span class="func">define</span>(<span class="gly">{</span></code></li><li class=""><code>        model:      newClass,</code></li><li class=""><code>        properties: properties,</code></li><li class=""><code>        settings:   settings</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">27</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> newClass;</code><span class="hits">27</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">standartize</span>(properties, settings) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(properties).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> v = properties<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">122</span></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> v === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                properties<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span> type: v <span class="gly">}</span>;</code><span class="hits">73</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">27</span></li><li class=""><code>        <span class="C">// TODO: add timestamps fields</span></code></li><li class=""><code>        <span class="C">// when present in settings: {timestamps: true}</span></code></li><li class=""><code>        <span class="C">// or {timestamps: {created: 'created_at', updated: false}}</span></code></li><li class=""><code>        <span class="C">// by default property names: createdAt, updatedAt</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define single property named `prop` on `model`</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} model - name of model</span></code></li><li class=""><code><span class="C"> * @param {String} prop - name of propery</span></code></li><li class=""><code><span class="C"> * @param {Object} params - property settings</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.defineProperty = <span class="kwrd">function</span> (model, prop, params) <span class="gly">{</span></code></li><li class="covered"><code>    this.definitions<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span> = params;</code><span class="hits">5</span></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.defineProperty) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">defineProperty</span>(model, prop, params);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Drop each model table and re-create.</span></code></li><li class=""><code><span class="C"> * This method make sense only for sql adapters.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @warning All data will be lost! Use autoupdate if you need your data.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.automigrate = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">freeze</span>();</code><span class="hits">9</span></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.automigrate) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">automigrate</span>(cb);</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">cb</span>();</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Update existing database tables.</span></code></li><li class=""><code><span class="C"> * This method make sense only for sql adapters.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.autoupdate = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">freeze</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.autoupdate) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">autoupdate</span>(cb);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">cb</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether migrations needed</span></code></li><li class=""><code><span class="C"> * This method make sense only for sql adapters.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.isActual = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">freeze</span>();</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.isActual) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">isActual</span>(cb);</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (cb) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">cb</span>(null, true);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Log benchmarked message. Do not redefine this method, if you need to grab</span></code></li><li class=""><code><span class="C"> * chema logs, use `schema.on('log', ...)` emitter event</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @private used by adapters</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.log = <span class="kwrd">function</span> (sql, t) <span class="gly">{</span></code></li><li class="uncovered"><code>    this.<span class="func">emit</span>(<span class="S">'log'</span>, sql, t);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Freeze schema. Behavior depends on adapter</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.freeze = <span class="kwrd">function</span> <span class="func">freeze</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.freezeSchema) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.adapter.<span class="func">freezeSchema</span>();</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return table name for specified `modelName`</span></code></li><li class=""><code><span class="C"> * @param {String} modelName</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.tableName = <span class="kwrd">function</span> (modelName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.definitions<span class="gly">[</span>modelName<span class="gly">]</span>.settings.table = this.definitions<span class="gly">[</span>modelName<span class="gly">]</span>.settings.table <span class="gly">|</span><span class="gly">|</span> modelName</code><span class="hits">281</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define foreign key</span></code></li><li class=""><code><span class="C"> * @param {String} className</span></code></li><li class=""><code><span class="C"> * @param {String} key - name of key field</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.defineForeignKey = <span class="kwrd">function</span> <span class="func">defineForeignKey</span>(className, key) <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// return if already defined</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (this.definitions<span class="gly">[</span>className<span class="gly">]</span>.properties<span class="gly">[</span>key<span class="gly">]</span>) <span class="kwrd">return</span>;</code><span class="hits">16</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (this.adapter.defineForeignKey) <span class="gly">{</span></code></li><li class=""><code>        this.adapter.<span class="func">defineForeignKey</span>(className, key, <span class="kwrd">function</span> (err, keyType) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (err) throw err;</code><span class="hits">4</span></li><li class="covered"><code>            this.definitions<span class="gly">[</span>className<span class="gly">]</span>.properties<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span>type: keyType<span class="gly">}</span>;</code><span class="hits">4</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        this.definitions<span class="gly">[</span>className<span class="gly">]</span>.properties<span class="gly">[</span>key<span class="gly">]</span> = <span class="gly">{</span>type: Number<span class="gly">}</span>;</code><span class="hits">12</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Close database connection</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Schema.prototype.disconnect = <span class="kwrd">function</span> <span class="func">disconnect</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.adapter.disconnect === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        this.adapter.<span class="func">disconnect</span>();</code><span class="hits">7</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Define hidden property</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">hiddenProperty</span>(where, property, value) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">defineProperty</span>(where, property, <span class="gly">{</span></code></li><li class=""><code>        writable: false,</code></li><li class=""><code>        enumerable: false,</code></li><li class=""><code>        configurable: false,</code></li><li class=""><code>        value: value</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">108</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-sql-js" class="filename" name="lib-sql-js" onclick="var el = document.getElementById('lib-sql-js'); el.style.display = el.style.display ? '' : 'none';">lib/sql.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 95%"><strong>95%</strong> [75/161]</div></div></div></div><div id="lib-sql-js" style="display:none;"><pre><ol><li class="covered"><code>module.exports = BaseSQL;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Base SQL class</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">BaseSQL</span>() <span class="gly">{</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.query = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'query method should be declared in adapter'</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.command = <span class="kwrd">function</span> (sql, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.<span class="func">query</span>(sql, callback);</code><span class="hits">22</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.queryOne = <span class="kwrd">function</span> (sql, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">6</span></li><li class="covered"><code>        <span class="func">callback</span>(err, data<span class="gly">[</span>0<span class="gly">]</span>);</code><span class="hits">6</span></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.table = <span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this._models<span class="gly">[</span>model<span class="gly">]</span>.model.schema.<span class="func">tableName</span>(model);</code><span class="hits">281</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.escapeName = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class="uncovered"><code>    throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'escapeName method should be declared in adapter'</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.tableEscaped = <span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.<span class="func">escapeName</span>(this.<span class="func">table</span>(model));</code><span class="hits">281</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.define = <span class="kwrd">function</span> (descr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!descr.settings) descr.settings = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">10</span></li><li class="covered"><code>    this._models<span class="gly">[</span>descr.model.modelName<span class="gly">]</span> = descr;</code><span class="hits">10</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.defineProperty = <span class="kwrd">function</span> (model, prop, params) <span class="gly">{</span></code></li><li class="covered"><code>    this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span> = params;</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.save = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> sql = <span class="S">'UPDATE '</span> + this.<span class="func">tableEscaped</span>(model) + <span class="S">' SET '</span> + this.<span class="func">toFields</span>(model, data) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + data.id;</code><span class="hits">10</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err);</code><span class="hits">10</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">10</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.exists = <span class="kwrd">function</span> (model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT 1 FROM '</span> +</code></li><li class="covered"><code>        this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + id + <span class="S">' LIMIT 1'</span>;</code><span class="hits">6</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">6</span></li><li class="covered"><code>        <span class="func">callback</span>(null, data.length === 1);</code><span class="hits">6</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">6</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.find = <span class="kwrd">function</span> <span class="func">find</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'SELECT * FROM '</span> +</code></li><li class="covered"><code>        this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + id + <span class="S">' LIMIT 1'</span>;</code><span class="hits">18</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">query</span>(sql, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (data && data.length === 1) <span class="gly">{</span></code></li><li class="covered"><code>            data<span class="gly">[</span>0<span class="gly">]</span>.id = id;</code><span class="hits">16</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            data = <span class="gly">[</span>null<span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, this.<span class="func">fromDatabase</span>(model, data<span class="gly">[</span>0<span class="gly">]</span>));</code><span class="hits">18</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">18</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> sql = <span class="S">'DELETE FROM '</span> +</code></li><li class="covered"><code>        this.<span class="func">tableEscaped</span>(model) + <span class="S">' WHERE '</span> + this.<span class="func">escapeName</span>(<span class="S">'id'</span>) + <span class="S">' = '</span> + id;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">command</span>(sql, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">command</span>(<span class="S">'DELETE FROM '</span> + this.<span class="func">tableEscaped</span>(model), <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">callback</span>(err, <span class="gly">[</span><span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err);</code><span class="hits">9</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">9</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">6</span></li><li class="covered"><code>    <span class="kwrd">var</span> props = this._models<span class="gly">[</span>model<span class="gly">]</span>.properties;</code><span class="hits">6</span></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">queryOne</span>(<span class="S">'SELECT count(*) as cnt FROM '</span> +</code></li><li class=""><code>        this.<span class="func">tableEscaped</span>(model) + <span class="S">' '</span> + <span class="func">buildWhere</span>(where), <span class="kwrd">function</span> (err, res) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">6</span></li><li class="covered"><code>        <span class="func">callback</span>(err, res && res.cnt);</code><span class="hits">6</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">6</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">buildWhere</span>(conds) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> cs = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">6</span></li><li class=""><code>        Object.<span class="func">keys</span>(conds <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> keyEscaped = self.<span class="func">escapeName</span>(key);</code><span class="hits">2</span></li><li class=""><code>            <span class="kwrd">if</span> (conds<span class="gly">[</span>key<span class="gly">]</span> === null) <span class="gly">{</span></code></li><li class="uncovered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' IS NULL'</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                cs.<span class="func">push</span>(keyEscaped + <span class="S">' = '</span> + self.<span class="func">toDatabase</span>(props<span class="gly">[</span>key<span class="gly">]</span>, conds<span class="gly">[</span>key<span class="gly">]</span>));</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">6</span></li><li class="covered"><code>        <span class="kwrd">return</span> cs.length ? <span class="S">' WHERE '</span> + cs.jo<span class="kwrd">in</span>(<span class="S">' AND '</span>) : <span class="S">''</span>;</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttrs</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class="covered"><code>    data.id = id;</code><span class="hits">6</span></li><li class="covered"><code>    this.<span class="func">save</span>(model, data, cb);</code><span class="hits">6</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.disconnect = <span class="kwrd">function</span> <span class="func">disconnect</span>() <span class="gly">{</span></code></li><li class="covered"><code>    this.client.<span class="func">end</span>();</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.automigrate = <span class="kwrd">function</span> (cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">5</span></li><li class="covered"><code>    <span class="kwrd">var</span> wait = 0;</code><span class="hits">5</span></li><li class=""><code>    Object.<span class="func">keys</span>(this._models).<span class="func">forEach</span>(<span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="covered"><code>        wait += 1;</code><span class="hits">10</span></li><li class=""><code>        self.<span class="func">dropTable</span>(model, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// console.log('drop', model);</span></code></li><li class=""><code>            self.<span class="func">createTable</span>(model, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// console.log('create', model);</span></code></li><li class="covered"><code>                <span class="kwrd">if</span> (err) console.<span class="func">log</span>(err);</code><span class="hits">10</span></li><li class="covered"><code>                <span class="func">done</span>();</code><span class="hits">10</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">10</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">10</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="kwrd">if</span> (wait === 0) <span class="func">cb</span>();</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>() <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0 && cb) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">cb</span>();</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.dropTable = <span class="kwrd">function</span> (model, cb) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">command</span>(<span class="S">'DROP TABLE IF EXISTS '</span> + this.<span class="func">tableEscaped</span>(model), cb);</code><span class="hits">10</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>BaseSQL.prototype.createTable = <span class="kwrd">function</span> (model, cb) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">command</span>(<span class="S">'CREATE TABLE '</span> + this.<span class="func">tableEscaped</span>(model) +</code></li><li class="covered"><code>        <span class="S">' (\n  '</span> + this.<span class="func">propertiesSQL</span>(model) + <span class="S">'\n)'</span>, cb);</code><span class="hits">10</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-adapters-mongoose-js" class="filename" name="lib-adapters-mongoose-js" onclick="var el = document.getElementById('lib-adapters-mongoose-js'); el.style.display = el.style.display ? '' : 'none';">lib/adapters/mongoose.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 100%"><strong>100%</strong> [44/227]</div></div></div></div><div id="lib-adapters-mongoose-js" style="display:none;"><pre><ol><li class="covered"><code><span class="kwrd">var</span> safeRequire = <span class="func">require</span>(<span class="S">'../utils'</span>).safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> mongoose = <span class="func">safeRequire</span>(<span class="S">'mongoose'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!mongoose) <span class="kwrd">return</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!schema.settings.url) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> url = schema.settings.host <span class="gly">|</span><span class="gly">|</span> <span class="S">'localhost'</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (schema.settings.port) url += <span class="S">':'</span> + schema.settings.port;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> auth = <span class="S">''</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (schema.settings.username) <span class="gly">{</span></code></li><li class="uncovered"><code>            auth = schema.settings.username;</code></li><li class=""><code>            <span class="kwrd">if</span> (schema.settings.password) <span class="gly">{</span></code></li><li class="uncovered"><code>                auth += <span class="S">':'</span> + schema.settings.password;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (auth) <span class="gly">{</span></code></li><li class="uncovered"><code>            url = auth + <span class="S">'@'</span> + url;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (schema.settings.database) <span class="gly">{</span></code></li><li class="uncovered"><code>            url += <span class="S">'/'</span> + schema.settings.database;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            url += <span class="S">'/'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        url = <span class="S">'mongodb:~~~C1~~~</span></code></li><li class=""><code><span class="S">        schema.settings.url = url;</span></code></li><li class=""><code><span class="S">    }</span></code></li><li class="covered"><code><span class="S">    schema.client = mongoose.connect(schema.settings.url);</span></code><span class="hits">1</span></li><li class="covered"><code><span class="S">    schema.adapter = new MongooseAdapter(schema.client);</span></code><span class="hits">1</span></li><li class="covered"><code><span class="S">    process.nextTick(callback);</span></code><span class="hits">1</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">function MongooseAdapter(client) {</span></code></li><li class="covered"><code><span class="S">    this._models = {};</span></code><span class="hits">1</span></li><li class="covered"><code><span class="S">    this.client = client;</span></code><span class="hits">1</span></li><li class="covered"><code><span class="S">    this.cache = {};</span></code><span class="hits">1</span></li><li class=""><code><span class="S">}</span></code></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.define = function (descr) {</span></code></li><li class="covered"><code><span class="S">    var props = {};</span></code><span class="hits">3</span></li><li class=""><code><span class="S">    Object.keys(descr.properties).forEach(function (key) {</span></code></li><li class="covered"><code><span class="S">        props[key] = descr.properties[key].type;</span></code><span class="hits">12</span></li><li class="covered"><code><span class="S">        if (props[key].name === '</span>Text<span class="S">') props[key] = String;</span></code><span class="hits">12</span></li><li class="covered"><code><span class="S">    });</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">    var schema = new mongoose.Schema(props);</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">    this._models[descr.model.modelName] = mongoose.model(descr.model.modelName, schema);</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">    this.cache[descr.model.modelName] = {};</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.defineForeignKey = function (model, key, cb) {</span></code></li><li class="covered"><code><span class="S">    var piece = {};</span></code><span class="hits">2</span></li><li class="covered"><code><span class="S">    piece[key] = {type: mongoose.Schema.ObjectId, index: true};</span></code><span class="hits">2</span></li><li class="covered"><code><span class="S">    this._models[model].schema.add(piece);</span></code><span class="hits">2</span></li><li class="covered"><code><span class="S">    cb(null, String);</span></code><span class="hits">2</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.setCache = function (model, instance) {</span></code></li><li class=""><code><span class="S">    this.cache[model][instance.id] = instance;</span></code></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.getCached = function (model, id, cb) {</span></code></li><li class=""><code><span class="S">    if (this.cache[model][id]) {</span></code></li><li class="covered"><code><span class="S">        cb(null, this.cache[model][id]);</span></code><span class="hits">1</span></li><li class=""><code><span class="S">    } else {</span></code></li><li class=""><code><span class="S">        this._models[model].findById(id, function (err, instance) {</span></code></li><li class=""><code><span class="S">            if (err) {</span></code></li><li class=""><code><span class="S">                return cb(err);</span></code></li><li class=""><code><span class="S">            }</span></code></li><li class="covered"><code><span class="S">            this.cache[model][id] = instance;</span></code><span class="hits">15</span></li><li class="covered"><code><span class="S">            cb(null, instance);</span></code><span class="hits">15</span></li><li class="covered"><code><span class="S">        }.bind(this));</span></code><span class="hits">15</span></li><li class=""><code><span class="S">    }</span></code></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.create = function (model, data, callback) {</span></code></li><li class="covered"><code><span class="S">    var m = new this._models[model](data);</span></code><span class="hits">38</span></li><li class=""><code><span class="S">    m.save(function (err) {</span></code></li><li class="covered"><code><span class="S">        callback(err, err ? null : m.id);</span></code><span class="hits">38</span></li><li class="covered"><code><span class="S">    });</span></code><span class="hits">38</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.save = function (model, data, callback) {</span></code></li><li class=""><code><span class="S">    this.getCached(model, data.id, function (err, inst) {</span></code></li><li class=""><code><span class="S">        if (err) {</span></code></li><li class=""><code><span class="S">            return callback(err);</span></code></li><li class=""><code><span class="S">        }</span></code></li><li class="covered"><code><span class="S">        merge(inst, data);</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">        inst.save(callback);</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">    });</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.exists = function (model, id, callback) {</span></code></li><li class="covered"><code><span class="S">    delete this.cache[model][id];</span></code><span class="hits">3</span></li><li class=""><code><span class="S">    this.getCached(model, id, function (err, data) {</span></code></li><li class=""><code><span class="S">        if (err) {</span></code></li><li class=""><code><span class="S">            return callback(err);</span></code></li><li class=""><code><span class="S">        }</span></code></li><li class="covered"><code><span class="S">        callback(err, !!data);</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">    });</span></code><span class="hits">3</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.find = function find(model, id, callback) {</span></code></li><li class="covered"><code><span class="S">    delete this.cache[model][id];</span></code><span class="hits">7</span></li><li class=""><code><span class="S">    this.getCached(model, id, function (err, data) {</span></code></li><li class=""><code><span class="S">        if (err) {</span></code></li><li class=""><code><span class="S">            return callback(err);</span></code></li><li class=""><code><span class="S">        }</span></code></li><li class="covered"><code><span class="S">        callback(err, data ? data.toObject() : null);</span></code><span class="hits">7</span></li><li class="covered"><code><span class="S">    });</span></code><span class="hits">7</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.destroy = function destroy(model, id, callback) {</span></code></li><li class=""><code><span class="S">    this.getCached(model, id, function (err, data) {</span></code></li><li class=""><code><span class="S">        if (err) {</span></code></li><li class=""><code><span class="S">            return callback(err);</span></code></li><li class=""><code><span class="S">        }</span></code></li><li class=""><code><span class="S">        if (data) {</span></code></li><li class="covered"><code><span class="S">            data.remove(callback);</span></code><span class="hits">1</span></li><li class=""><code><span class="S">        } else {</span></code></li><li class=""><code><span class="S">            callback(null);</span></code></li><li class=""><code><span class="S">        }</span></code></li><li class="covered"><code><span class="S">    });</span></code><span class="hits">1</span></li><li class="covered"><code><span class="S">};</span></code><span class="hits">1</span></li><li class=""><code><span class="S"></span></code></li><li class=""><code><span class="S">MongooseAdapter.prototype.all = function all(model, filter, callback) {</span></code></li><li class=""><code><span class="S">    if (!filter) {</span></code></li><li class="covered"><code><span class="S">        filter = {};</span></code><span class="hits">2</span></li><li class=""><code><span class="S">    }</span></code></li><li class="covered"><code><span class="S">    var query = this._models[model].find({});</span></code><span class="hits">21</span></li><li class=""><code><span class="S">    if (filter.where) {</span></code></li><li class=""><code><span class="S">        Object.keys(filter.where).forEach(function (k) {</span></code></li><li class="covered"><code><span class="S">            var cond = filter.where[k];</span></code><span class="hits">16</span></li><li class="covered"><code><span class="S">            var spec = false;</span></code><span class="hits">16</span></li><li class=""><code><span class="S">            if (cond && cond.constructor.name === '</span>Object<span class="S">') {</span></code></li><li class="covered"><code><span class="S">                spec = Object.keys(cond)[0];</span></code><span class="hits">5</span></li><li class="covered"><code><span class="S">                cond = cond[spec];</span></code><span class="hits">5</span></li><li class=""><code><span class="S">            }</span></code></li><li class=""><code><span class="S">            if (spec) {</span></code></li><li class=""><code><span class="S">                if (spec === '</span>between<span class="S">') {</span></code></li><li class="covered"><code><span class="S">                    query.where(k).gte(cond[0]).lte(cond[1]);</span></code><span class="hits">1</span></li><li class=""><code><span class="S">                } else {</span></code></li><li class="covered"><code><span class="S">                    query.where(k)[spec](cond);</span></code><span class="hits">4</span></li><li class=""><code><span class="S">                }</span></code></li><li class=""><code><span class="S">            } else {</span></code></li><li class="covered"><code><span class="S">                query.where(k, cond);</span></code><span class="hits">11</span></li><li class=""><code><span class="S">            }</span></code></li><li class="covered"><code><span class="S">        });</span></code><span class="hits">16</span></li><li class=""><code><span class="S">    }</span></code></li><li class=""><code><span class="S">    if (filter.order) {</span></code></li><li class="covered"><code><span class="S">        var m = filter.order.match(/\s+(A|DE)SC$/);</span></code><span class="hits">6</span></li><li class="covered"><code><span class="S">        var key = filter.order;</span></code><span class="hits">6</span></li><li class="covered"><code><span class="S">        var reverse = false;</span></code><span class="hits">6</span></li><li class=""><code><span class="S">        if (m) {</span></code></li><li class="covered"><code><span class="S">            key = key.replace(/\s+(A|DE)SC$/, '</span>');</code><span class="hits">3</span></li><li class="covered"><code>            <span class="kwrd">if</span> (m<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'DE'</span>) reverse = true;</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (reverse) <span class="gly">{</span></code></li><li class="covered"><code>            query.<span class="func">desc</span>(key);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            query.<span class="func">asc</span>(key);</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.limit) <span class="gly">{</span></code></li><li class="covered"><code>        query.<span class="func">limit</span>(filter.limit);</code><span class="hits">5</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.skip) <span class="gly">{</span></code></li><li class="uncovered"><code>        query.<span class="func">skip</span>(filter.skip);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (filter.offset) <span class="gly">{</span></code></li><li class="uncovered"><code>        query.<span class="func">skip</span>(filter.offset);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    query.<span class="func">exec</span>(<span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">21</span></li><li class="covered"><code>        <span class="func">callback</span>(null, data);</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">21</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongooseAdapter.prototype.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> wait = 0;</code><span class="hits">3</span></li><li class=""><code>    this._models<span class="gly">[</span>model<span class="gly">]</span>.<span class="func">find</span>(<span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">3</span></li><li class="covered"><code>        wait = data.length;</code><span class="hits">3</span></li><li class=""><code>        data.<span class="func">forEach</span>(<span class="kwrd">function</span> (obj) <span class="gly">{</span></code></li><li class=""><code>            obj.<span class="func">remove</span>(done)</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">3</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">3</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> error = null;</code><span class="hits">3</span></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">done</span>(err) <span class="gly">{</span></code></li><li class="covered"><code>        error = error <span class="gly">|</span><span class="gly">|</span> err;</code><span class="hits">37</span></li><li class=""><code>        <span class="kwrd">if</span> (--wait === 0) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(error);</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongooseAdapter.prototype.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class="covered"><code>    this._models<span class="gly">[</span>model<span class="gly">]</span>.<span class="func">count</span>(where <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>, callback);</code><span class="hits">3</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongooseAdapter.prototype.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttrs</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">getCached</span>(model, id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (err) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">cb</span>(err);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">merge</span>(inst, data);</code><span class="hits">2</span></li><li class="covered"><code>            inst.<span class="func">save</span>(cb);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="gly">}</span> else <span class="func">cb</span>();</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongooseAdapter.prototype.disconnect = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    this.client.connection.<span class="func">close</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">merge</span>(base, update) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(update).<span class="func">forEach</span>(<span class="kwrd">function</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>        base<span class="gly">[</span>key<span class="gly">]</span> = update<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">21</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="kwrd">return</span> base;</code><span class="hits">5</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-hookable-js" class="filename" name="lib-hookable-js" onclick="var el = document.getElementById('lib-hookable-js'); el.style.display = el.style.display ? '' : 'none';">lib/hookable.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 100%"><strong>100%</strong> [25/52]</div></div></div></div><div id="lib-hookable-js" style="display:none;"><pre><ol><li class="covered"><code>exports.Hookable = Hookable;</code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Hookable</span>() <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// hookable class</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>Hookable.afterInitialize = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeValidation = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterValidation = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeSave = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterSave = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeCreate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterCreate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeUpdate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterUpdate = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.beforeDestroy = null;</code><span class="hits">1</span></li><li class="covered"><code>Hookable.afterDestroy = null;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Hookable.prototype.trigger = <span class="kwrd">function</span> <span class="func">trigger</span>(actionName, work, data) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> capitalizedName = <span class="func">capitalize</span>(actionName);</code><span class="hits">2356</span></li><li class="covered"><code>    <span class="kwrd">var</span> afterHook = this.constructor<span class="gly">[</span><span class="S">"after"</span> + capitalizedName<span class="gly">]</span>;</code><span class="hits">2356</span></li><li class="covered"><code>    <span class="kwrd">var</span> beforeHook = this.constructor<span class="gly">[</span><span class="S">"before"</span> + capitalizedName<span class="gly">]</span>;</code><span class="hits">2356</span></li><li class="covered"><code>    <span class="kwrd">var</span> inst = this;</code><span class="hits">2356</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// we only call "before" hook when we have actual action (work) to perform</span></code></li><li class=""><code>    <span class="kwrd">if</span> (work) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (beforeHook) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// before hook should be called on instance with one param: callback</span></code></li><li class=""><code>            beforeHook.<span class="func">call</span>(inst, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// actual action also have one param: callback</span></code></li><li class="covered"><code>                work.<span class="func">call</span>(inst, next);</code><span class="hits">1</span></li><li class="covered"><code>            <span class="gly">}</span>, data);</code><span class="hits">4</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            work.<span class="func">call</span>(inst, next);</code><span class="hits">693</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">next</span>();</code><span class="hits">1659</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">next</span>(done) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (afterHook) <span class="gly">{</span></code></li><li class="covered"><code>            afterHook.<span class="func">call</span>(inst, done);</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (done) <span class="gly">{</span></code></li><li class="covered"><code>            done.<span class="func">call</span>(this);</code><span class="hits">652</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">capitalize</span>(string) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> string.<span class="func">charAt</span>(0).toUpper<span class="kwrd">Case</span>() + string.<span class="func">slice</span>(1);</code><span class="hits">2356</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-jutil-js" class="filename" name="lib-jutil-js" onclick="var el = document.getElementById('lib-jutil-js'); el.style.display = el.style.display ? '' : 'none';">lib/jutil.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 100%"><strong>100%</strong> [5/10]</div></div></div></div><div id="lib-jutil-js" style="display:none;"><pre><ol><li class="covered"><code>exports.inherits = <span class="kwrd">function</span> (newClass, baseClass) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(baseClass).<span class="func">forEach</span>(<span class="kwrd">function</span> (classMethod) <span class="gly">{</span></code></li><li class="covered"><code>        newClass<span class="gly">[</span>classMethod<span class="gly">]</span> = baseClass<span class="gly">[</span>classMethod<span class="gly">]</span>;</code><span class="hits">20</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class=""><code>    Object.<span class="func">keys</span>(baseClass.prototype).<span class="func">forEach</span>(<span class="kwrd">function</span> (instanceMethod) <span class="gly">{</span></code></li><li class="covered"><code>        newClass.prototype<span class="gly">[</span>instanceMethod<span class="gly">]</span> = baseClass.prototype<span class="gly">[</span>instanceMethod<span class="gly">]</span>;</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
<div class="row"><div class="span3"><a href="#lib-utils-js" class="filename" name="lib-utils-js" onclick="var el = document.getElementById('lib-utils-js'); el.style.display = el.style.display ? '' : 'none';">lib/utils.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 50%"><strong>50%</strong> [4/12]</div></div></div></div><div id="lib-utils-js" style="display:none;"><pre><ol><li class="covered"><code>exports.safeRequire = safeRequire;</code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">safeRequire</span>(module) <span class="gly">{</span></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">require</span>(module);</code><span class="hits">7</span></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'Run "npm install '</span> + module + <span class="S">'" command to use jugglingdb using this database engine'</span>);</code></li><li class="uncovered"><code>        process.<span class="func">exit</span>(1);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div>
    </div>
  </body>
</html>
